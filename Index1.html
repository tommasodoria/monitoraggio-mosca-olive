<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>OliveTrack</title>
<meta name="application-name" content="OliveTrack">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="OliveTrack">
<meta name="theme-color" content="#052e16">
<meta name="mobile-web-app-capable" content="yes">
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%23052e16'/><text y='.9em' font-size='80' x='10'>ğŸ«’</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,600;0,700;1,400&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
* { box-sizing:border-box; margin:0; padding:0; }
body { font-family:'DM Sans',sans-serif; transition:background 0.3s; overflow-x:hidden; }
html { overflow-x:hidden; }
input,select,button,textarea { font-family:inherit; }
.page { width:100%; min-height:100vh; position:relative; transition:background 0.3s,color 0.3s; overflow-x:hidden; }
.content-wrap { width:100%; max-width:100%; padding:0; }
@media(min-width:600px){ .content-wrap { max-width:640px; margin:0 auto; } }
@media(min-width:900px){ .content-wrap { max-width:860px; } }
@media(min-width:1200px){ .content-wrap { max-width:1000px; } }
.light { background:#f8fafc; color:#1a1a2e; }
.light .card { background:white; box-shadow:0 2px 14px rgba(0,0,0,0.07); }
.light .header { background:#052e16; }
.light .section-bg { background:#f0fdf4; }
.light .input-border { border-color:#d1fae5; }
.light .input-bg { background:white; color:#1a1a2e; }
.light .muted { color:#6b7280; }
.light .divider { border-color:#f3f4f6; }
.light .nav-bg { background:white; border-color:#e5e7eb; }
.light .tab-inactive { background:#f0fdf4; color:#16a34a; }
.light .sub-bg { background:#f9fafb; }
.dark { background:#0f172a; color:#e2e8f0; }
.dark .card { background:#1e293b; box-shadow:0 2px 14px rgba(0,0,0,0.4); }
.dark .header { background:#0a1f0f; }
.dark .section-bg { background:#1a2e1a; }
.dark .input-border { border-color:#2d4a2d; }
.dark .input-bg { background:#1e293b; color:#e2e8f0; }
.dark .muted { color:#94a3b8; }
.dark .divider { border-color:#1e293b; }
.dark .nav-bg { background:#1e293b; border-color:#334155; }
.dark .tab-inactive { background:#1e3a1e; color:#4ade80; }
.dark .sub-bg { background:#273549; }
.scroll-area { overflow-y:auto; overflow-x:hidden; padding-bottom:90px; }
.header { position:sticky; top:0; z-index:50; padding:10px 12px; display:flex; justify-content:space-between; align-items:center; width:100%; }
.bottom-nav { position:fixed; bottom:0; left:0; width:100%; display:flex; border-top:1px solid; z-index:100; }
.card-grid { display:grid; grid-template-columns:1fr; gap:12px; }
@media(min-width:600px){ .card-grid { grid-template-columns:repeat(2,1fr); } }
@media(min-width:900px){ .card-grid { grid-template-columns:repeat(3,1fr); } }
.page-pad { padding:14px; }
@media(min-width:600px){ .page-pad { padding:20px 24px; } }
@media(min-width:900px){ .page-pad { padding:24px 32px; } }
.nav-btn { flex:1; padding:10px 4px 12px; border:none; cursor:pointer; display:flex; flex-direction:column; align-items:center; gap:2px; background:transparent; }
.card { border-radius:18px; padding:16px; margin-bottom:12px; cursor:pointer; transition:transform 0.15s,box-shadow 0.15s; }
.card:active { transform:scale(0.98); }
.tag { padding:3px 10px; border-radius:20px; font-size:11px; font-weight:700; display:inline-block; }
.inf-bar-bg { border-radius:99px; height:10px; overflow:hidden; background:#e2e8f0; }
.dark .inf-bar-bg { background:#334155; }
.inf-bar-fill { height:100%; border-radius:99px; transition:width 0.6s cubic-bezier(.4,0,.2,1); }
@keyframes fadeIn { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }
.fade-in { animation:fadeIn 0.2s ease; }
.cal-day { border-radius:10px; padding:4px; cursor:pointer; text-align:center; transition:background 0.15s; min-height:52px; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:2px; }
.btn-primary { width:100%; padding:14px; color:white; border:none; border-radius:14px; font-size:15px; font-weight:700; cursor:pointer; transition:filter 0.2s,transform 0.1s; margin-bottom:10px; }
.btn-primary:disabled { opacity:0.6; cursor:not-allowed; }
.spinner { display:inline-block; width:18px; height:18px; border:2px solid rgba(255,255,255,0.3); border-top-color:white; border-radius:50%; animation:spin 0.7s linear infinite; vertical-align:middle; }
@keyframes spin { to { transform:rotate(360deg); } }
.dot-online { width:8px; height:8px; border-radius:50%; background:#4ade80; display:inline-block; }
.dot-offline { width:8px; height:8px; border-radius:50%; background:#f97316; display:inline-block; }
.leaflet-pane,.leaflet-tile,.leaflet-marker-icon,.leaflet-tile-container { z-index: 1 !important; }
.leaflet-control-container .leaflet-top, .leaflet-control-container .leaflet-bottom { z-index: 2 !important; }
.leaflet-container { z-index: 0 !important; }
::-webkit-scrollbar { width:4px; }
::-webkit-scrollbar-thumb { background:#d1d5db; border-radius:4px; }
.dark ::-webkit-scrollbar-thumb { background:#475569; }
</style>
</head>
<body>
<div id="root"></div>
<script>
window.onerror = function(message, source, lineno, colno, error) {
  alert(
    "Errore:\n" +
    message + "\n\nFile: " + source +
    "\nLinea: " + lineno
  );
};

window.addEventListener("unhandledrejection", function(event) {
  alert("Promise Error:\n" + event.reason);
});
</script>
<script type="text/babel">
const { useState, useRef, useEffect, useCallback, useMemo } = React;
const { createPortal } = ReactDOM;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SUPABASE CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SURL = "https://caphhwkuyjmrrettsghs.supabase.co";
const SKEY = "sb_publishable_yQxwladABV3GPyWXf0YEmg_vwSho6jI";
const sb = supabase.createClient(SURL, SKEY, { auth: { persistSession: false } });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// OFFLINE CACHE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const Cache = {
  set(k,v){ try{ localStorage.setItem("ot_"+k, JSON.stringify(v)); }catch(e){} },
  get(k){ try{ const v=localStorage.getItem("ot_"+k); return v?JSON.parse(v):null; }catch(e){ return null; } },
};

function useOnline(){
  const [online,setOnline]=useState(navigator.onLine);
  useEffect(()=>{
    const on=()=>setOnline(true), off=()=>setOnline(false);
    window.addEventListener("online",on); window.addEventListener("offline",off);
    return()=>{ window.removeEventListener("online",on); window.removeEventListener("offline",off); };
  },[]);
  return online;
}

function fmtDate(d){ return d?String(d).slice(0,10):""; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SOGLIE E HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let SA=30, SP=60, IA=5, IP=10;

function rischio(m){
  if(m>=SP) return {l:"PERICOLO",c:"#dc2626",bg:"rgba(220,38,38,0.12)",border:"#dc2626"};
  if(m>=SA) return {l:"ALLERTA",c:"#d97706",bg:"rgba(217,119,6,0.12)",border:"#d97706"};
  return {l:"OK",c:"#16a34a",bg:"rgba(22,163,74,0.12)",border:"#16a34a"};
}
function calcInf(s){
  if(!s||!s.camp) return null;
  return {
    att:Math.min(((s.uova+s.l1+s.l2)/s.camp)*100,100),
    tot:Math.min(((s.uova+s.l1+s.l2+s.l3+s.pupe+s.fori)/s.camp)*100,100)
  };
}
function lastOf(arr,k,v){ return [...arr].filter(x=>x[k]===v).sort((a,b)=>b.data.localeCompare(a.data))[0]||null; }
function cInf(v){ return v>=IP?"#dc2626":v>=IA?"#d97706":"#16a34a"; }
function rischioInf(v){
  if(v>=IP) return {l:"PERICOLO",c:"#dc2626",bg:"rgba(220,38,38,0.12)",border:"#dc2626"};
  if(v>=IA) return {l:"ALLERTA",c:"#d97706",bg:"rgba(217,119,6,0.12)",border:"#d97706"};
  return {l:"OK",c:"#16a34a",bg:"rgba(22,163,74,0.12)",border:"#16a34a"};
}
function dayName(d){ return ["Dom","Lun","Mar","Mer","Gio","Ven","Sab"][d]; }
function monthName(m){ return ["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"][m]; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INF BAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function InfBar({label,value,color}){
  return(
    <div style={{marginBottom:10}}>
      <div style={{display:"flex",justifyContent:"space-between",marginBottom:4}}>
        <span style={{fontSize:12,fontWeight:600}} className="muted">{label}</span>
        <span style={{fontSize:14,fontWeight:700,color}}>{value.toFixed(1)}%</span>
      </div>
      <div className="inf-bar-bg">
        <div className="inf-bar-fill" style={{width:`${Math.min(value,100)}%`,background:color}}/>
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DUAL CHART
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function DualChart({oId,rils,sters,dark}){
  const [mode,setMode]=useState("mosche");
  const W=300,H=100,P=20,LEGEND_H=22;

  function MoscheChart({data,extra}){
    if(!data||data.length<2) return(
      <div style={{textAlign:"center",padding:"24px 0",color:dark?"#64748b":"#9ca3af",fontSize:13}}>
        ğŸ“Š Dati insufficienti â€” servono almeno 2 rilevamenti
      </div>
    );
    const all=[...data,...(extra||[])];
    const max=Math.max(...all.map(d=>d.mosche),SP+10);
    const xs=d=>d.map((_,i)=>P+(i/(d.length-1))*(W-P*2));
    const ys=d=>d.map(x=>H-P-((x.mosche/max)*(H-P*2)));
    const path=(d,x,y)=>x.map((v,i)=>`${i===0?"M":"L"} ${v} ${y[i]}`).join(" ");
    const area=(d,x,y)=>`${path(d,x,y)} L ${x[x.length-1]} ${H-P} L ${x[0]} ${H-P} Z`;
    const s1y=H-P-((SA/max)*(H-P*2));
    const s2y=H-P-((SP/max)*(H-P*2));
    const x1=xs(data), y1=ys(data);
    const x2=extra?xs(extra):null, y2=extra?ys(extra):null;
    const gId="gm"+oId;
    const totalH=H+LEGEND_H+(extra?LEGEND_H:0);
    return(
      <svg width="100%" viewBox={`0 0 ${W} ${totalH}`} style={{overflow:"visible"}}>
        <defs>
          <linearGradient id={gId} x1="0" y1="0" x2="0" y2="1">
            <stop offset="0%" stopColor="#16a34a" stopOpacity="0.3"/>
            <stop offset="100%" stopColor="#16a34a" stopOpacity="0"/>
          </linearGradient>
        </defs>
        <line x1={P} y1={s2y} x2={W-P} y2={s2y} stroke="#dc2626" strokeWidth="1" strokeDasharray="4,3" opacity="0.6"/>
        <line x1={P} y1={s1y} x2={W-P} y2={s1y} stroke="#d97706" strokeWidth="1" strokeDasharray="4,3" opacity="0.6"/>
        <text x={W-P+2} y={s2y+3} fontSize="8" fill="#dc2626">{SP}</text>
        <text x={W-P+2} y={s1y+3} fontSize="8" fill="#d97706">{SA}</text>
        {extra&&x2&&<path d={path(extra,x2,y2)} fill="none" stroke="#a78bfa" strokeWidth="1.5" strokeDasharray="5,3" strokeLinecap="round"/>}
        {extra&&x2&&x2.map((x,i)=><circle key={i} cx={x} cy={y2[i]} r="2.5" fill="#a78bfa" stroke={dark?"#1e293b":"white"} strokeWidth="1"/>)}
        <path d={area(data,x1,y1)} fill={`url(#${gId})`}/>
        <path d={path(data,x1,y1)} fill="none" stroke="#16a34a" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
        {x1.map((x,i)=><circle key={i} cx={x} cy={y1[i]} r="3.5" fill={data[i].mosche>=SP?"#dc2626":data[i].mosche>=SA?"#d97706":"#16a34a"} stroke={dark?"#1e293b":"white"} strokeWidth="1.5"/>)}
        {data.map((d,i)=><text key={i} x={x1[i]} y={H+10} textAnchor="middle" fontSize="8" fill={dark?"#64748b":"#9ca3af"}>{d.data.slice(5)}</text>)}
      </svg>
    );
  }

  function InfChart({data}){
    if(!data||data.length<2) return(
      <div style={{textAlign:"center",padding:"24px 0",color:dark?"#64748b":"#9ca3af",fontSize:13}}>
        ğŸ”¬ Dati insufficienti â€” servono almeno 2 campionamenti
      </div>
    );
    const max=Math.max(...data.map(d=>Math.max(d.att,d.tot)),30);
    const xs=data.map((_,i)=>P+(i/(data.length-1))*(W-P*2));
    const ya=data.map(d=>H-P-((d.att/max)*(H-P*2)));
    const yt=data.map(d=>H-P-((d.tot/max)*(H-P*2)));
    const pa=xs.map((x,i)=>`${i===0?"M":"L"} ${x} ${ya[i]}`).join(" ");
    const pt=xs.map((x,i)=>`${i===0?"M":"L"} ${x} ${yt[i]}`).join(" ");
    const l10=H-P-((10/max)*(H-P*2));
    const l20=H-P-((20/max)*(H-P*2));
    const totalH=H+LEGEND_H+LEGEND_H;
    return(
      <svg width="100%" viewBox={`0 0 ${W} ${totalH}`} style={{overflow:"visible"}}>
        <line x1={P} y1={l10} x2={W-P} y2={l10} stroke="#d97706" strokeWidth="1" strokeDasharray="3,3" opacity="0.5"/>
        <line x1={P} y1={l20} x2={W-P} y2={l20} stroke="#dc2626" strokeWidth="1" strokeDasharray="3,3" opacity="0.5"/>
        <text x={W-P+2} y={l10+3} fontSize="8" fill="#d97706">10%</text>
        <text x={W-P+2} y={l20+3} fontSize="8" fill="#dc2626">20%</text>
        <path d={pt} fill="none" stroke="#7c3aed" strokeWidth="1.5" strokeDasharray="5,3" strokeLinecap="round"/>
        <path d={pa} fill="none" stroke="#d97706" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
        {xs.map((x,i)=><circle key={i+"a"} cx={x} cy={ya[i]} r="3.5" fill={cInf(data[i].att)} stroke={dark?"#1e293b":"white"} strokeWidth="1.5"/>)}
        {xs.map((x,i)=><circle key={i+"t"} cx={x} cy={yt[i]} r="2.5" fill="#7c3aed" stroke={dark?"#1e293b":"white"} strokeWidth="1"/>)}
        {data.map((d,i)=><text key={i} x={xs[i]} y={H+10} textAnchor="middle" fontSize="8" fill={dark?"#64748b":"#9ca3af"}>{d.data.slice(5)}</text>)}
        <g transform={`translate(0,${H+LEGEND_H})`}>
          <circle cx={P+6} cy={8} r="4" fill="#d97706"/>
          <text x={P+14} y={12} fontSize="8" fill={dark?"#94a3b8":"#6b7280"}>Attiva</text>
          <line x1={P+44} y1={8} x2={P+56} y2={8} stroke="#7c3aed" strokeWidth="2" strokeDasharray="4,2"/>
          <text x={P+60} y={12} fontSize="8" fill={dark?"#94a3b8":"#6b7280"}>Totale</text>
        </g>
      </svg>
    );
  }

  const year=new Date().getFullYear();
  const rilYear=y=>[...rils].filter(r=>r.oId===oId&&(r.stagione===y||new Date(r.data).getFullYear()===y)).sort((a,b)=>a.data.localeCompare(b.data));
  // Trova tutti gli anni disponibili
  const availYears=[...new Set(rils.filter(r=>r.oId===oId).map(r=>r.stagione||new Date(r.data).getFullYear()))].sort((a,b)=>b-a);
  const [selYear,setSelYear]=useState(year);
  const cur=rilYear(selYear), prev=rilYear(selYear-1);
  const sterData=[...sters].filter(s=>s.oId===oId).sort((a,b)=>a.data.localeCompare(b.data)).map(s=>({...calcInf(s),data:s.data}));

  const chartTabs=[{id:"mosche",label:"ğŸª¤ Mosche"},{id:"inf",label:"ğŸ”¬ Infestazione"},{id:"season",label:"ğŸ“Š Stagioni"}];
  return(
    <div>
      <div style={{display:"flex",gap:6,marginBottom:10,flexWrap:"wrap",alignItems:"center"}}>
        {chartTabs.map(t=>(
          <button key={t.id} onClick={()=>setMode(t.id)}
            style={{padding:"6px 12px",borderRadius:8,border:"none",cursor:"pointer",fontSize:12,fontWeight:600,
              background:mode===t.id?"#16a34a":(dark?"#1e3a1e":"#f0fdf4"),
              color:mode===t.id?"white":(dark?"#4ade80":"#16a34a")}}>
            {t.label}
          </button>
        ))}
        {availYears.length>1&&(mode==="mosche"||mode==="season")&&(
          <select value={selYear} onChange={e=>setSelYear(+e.target.value)}
            style={{marginLeft:"auto",padding:"5px 8px",border:`1px solid ${dark?"#334155":"#d1fae5"}`,borderRadius:8,fontSize:12,background:dark?"#1e293b":"white",color:dark?"#e2e8f0":"#1a1a2e",outline:"none"}}>
            {availYears.map(y=><option key={y} value={y}>{y}</option>)}
          </select>
        )}
      </div>
      {mode==="mosche"&&<MoscheChart data={cur.length?cur:prev}/>}
      {mode==="season"&&<MoscheChart data={cur.length?cur:prev} extra={prev.length&&cur.length?prev:null}/>}
      {mode==="inf"&&<InfChart data={sterData}/>}
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CALENDARIO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function Calendario({rils,sters,trats,oliveti,dark}){
  const today=new Date();
  const [date,setDate]=useState(new Date(today.getFullYear(),today.getMonth(),1));
  const year=date.getFullYear(), month=date.getMonth();
  const firstDay=new Date(year,month,1).getDay();
  const daysInMonth=new Date(year,month+1,0).getDate();
  const isCurrentMonth=year===today.getFullYear()&&month===today.getMonth();
  const todayDay=today.getDate();
  const prefix=`${year}-${String(month+1).padStart(2,"0")}`;
  const rilMap={}, sterMap={}, tratMap={};
  rils.forEach(r=>{ if(r.data.startsWith(prefix)){ const d=parseInt(r.data.slice(8)); if(!rilMap[d])rilMap[d]=[];rilMap[d].push(r); }});
  sters.forEach(s=>{ if(s.data.startsWith(prefix)){ const d=parseInt(s.data.slice(8)); if(!sterMap[d])sterMap[d]=[];sterMap[d].push(s); }});
  trats.forEach(t=>{ if(t.data.startsWith(prefix)){ const d=parseInt(t.data.slice(8)); if(!tratMap[d])tratMap[d]=[];tratMap[d].push(t); }});
  const cells=[];
  for(let i=0;i<(firstDay===0?6:firstDay-1);i++) cells.push(null);
  for(let d=1;d<=daysInMonth;d++) cells.push(d);
  const mutedC=dark?"#94a3b8":"#6b7280";
  function getBg(d){
    const rs=rilMap[d]||[];
    if(rs.some(r=>r.mosche>=SP)) return "rgba(220,38,38,0.15)";
    if(rs.some(r=>r.mosche>=SA)) return "rgba(217,119,6,0.12)";
    if(rs.length||sterMap[d]||tratMap[d]) return "rgba(22,163,74,0.1)";
    return "transparent";
  }
  return(
    <div className="fade-in">
      <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:16,padding:"0 2px"}}>
        <button onClick={()=>setDate(new Date(year,month-1,1))} style={{background:"none",border:"none",fontSize:20,cursor:"pointer",color:mutedC}}>â€¹</button>
        <div style={{display:"flex",alignItems:"center",gap:8}}>
          <h3 style={{fontFamily:"Lora,serif",fontSize:18,margin:0}}>{monthName(month)} {year}</h3>
          {!isCurrentMonth&&<button onClick={()=>setDate(new Date(today.getFullYear(),today.getMonth(),1))} style={{fontSize:11,padding:"3px 8px",background:dark?"#1e3a1e":"#d1fae5",color:"#16a34a",border:"none",borderRadius:8,cursor:"pointer",fontWeight:700}}>Oggi</button>}
        </div>
        <button onClick={()=>setDate(new Date(year,month+1,1))} style={{background:"none",border:"none",fontSize:20,cursor:"pointer",color:mutedC}}>â€º</button>
      </div>
      <div style={{display:"grid",gridTemplateColumns:"repeat(7,1fr)",gap:4,marginBottom:8}}>
        {["L","M","M","G","V","S","D"].map((d,i)=><div key={i} style={{textAlign:"center",fontSize:11,fontWeight:700,color:mutedC,padding:"4px 0"}}>{d}</div>)}
      </div>
      <div style={{display:"grid",gridTemplateColumns:"repeat(7,1fr)",gap:4}}>
        {cells.map((d,i)=>(
          <div key={i} className="cal-day" style={{background:d?getBg(d):"transparent",opacity:d?1:0.3,border:d&&isCurrentMonth&&d===todayDay?`2px solid #16a34a`:"2px solid transparent",borderRadius:10}}>
            {d&&<span style={{fontSize:13,fontWeight:d&&isCurrentMonth&&d===todayDay?800:600,color:d&&isCurrentMonth&&d===todayDay?(dark?"#4ade80":"#16a34a"):undefined}}>{d}</span>}
            {d&&<div style={{display:"flex",gap:2,flexWrap:"wrap",justifyContent:"center"}}>
              {rilMap[d]?.slice(0,1).map(r=><span key={r.id} style={{fontSize:8,background:rischio(r.mosche).c,color:"white",borderRadius:4,padding:"0 3px"}}>{r.mosche}ğŸª¤</span>)}
              {sterMap[d]?.length>0&&<span style={{fontSize:8,background:"#7c3aed",color:"white",borderRadius:4,padding:"0 3px"}}>ğŸ”¬</span>}
              {tratMap[d]?.length>0&&<span style={{fontSize:8,background:"#16a34a",color:"white",borderRadius:4,padding:"0 3px"}}>ğŸ’Š</span>}
            </div>}
          </div>
        ))}
      </div>
      <div style={{marginTop:14,display:"flex",gap:8,flexWrap:"wrap"}}>
        {[["ğŸª¤ Monitoraggio","#16a34a"],["ğŸ”¬ Controllo","#7c3aed"],["ğŸ’Š Trattamento","#059669"],["âš ï¸ Allerta",rischio(SA).c],["ğŸš¨ Pericolo",rischio(SP).c]].map(([l,c])=>(
          <div key={l} style={{display:"flex",alignItems:"center",gap:4,fontSize:11,color:mutedC}}>
            <div style={{width:8,height:8,borderRadius:2,background:c}}/>{l}
          </div>
        ))}
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GESTIONE TRAPPOLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function GestioneTrappole({trappole,setTrappole,oId,oliveto,dark,onBack}){
  const [showAdd,setShowAdd]=useState(false);
  const [f,setF]=useState({nome:"",tipo:"Cromotropica"});
  const [saving,setSaving]=useState(false);
  const myT=trappole.filter(t=>(t.oliveto_id||t.oId)===oId);
  const set=(k,v)=>setF(p=>({...p,[k]:v}));
  const cardBg=dark?"#1e293b":"white";
  const mutedC=dark?"#94a3b8":"#6b7280";
  const tipoIcon={"Cromotropica":"ğŸŸ¡","A feromoni":"ğŸŸ£","Attrattivo alimentare":"ğŸŸ¢","Multilure":"ğŸ”µ"};
  const selStyle={width:"100%",padding:"9px 12px",border:`1.5px solid ${dark?"#2d4a2d":"#d1fae5"}`,borderRadius:10,fontSize:14,outline:"none",background:dark?"#273549":"white",color:dark?"#e2e8f0":"#1a1a2e"};

  async function save(){
    if(!f.nome){alert("Inserisci nome trappola");return;}
    setSaving(true);
    const{data}=await sb.from("trappole").insert({nome:f.nome,tipo:f.tipo,oliveto_id:oId,attiva:true}).select().single();
    if(data) setTrappole(p=>[...p,{...data,oId:data.oliveto_id}]);
    setF({nome:"",tipo:"Cromotropica"});setShowAdd(false);setSaving(false);
  }
  async function toggle(id,cur){
    await sb.from("trappole").update({attiva:!cur}).eq("id",id);
    setTrappole(p=>p.map(t=>t.id===id?{...t,attiva:!cur}:t));
  }
  async function remove(id){
    if(!confirm("Rimuovere questa trappola?")) return;
    await sb.from("trappole").delete().eq("id",id);
    setTrappole(p=>p.filter(t=>t.id!==id));
  }
  return(
    <div>
      <div style={{background:dark?"#0a1f0f":"linear-gradient(135deg,#052e16,#166534)",padding:"20px 20px 28px"}}>
        <button onClick={onBack} style={{background:"rgba(255,255,255,0.2)",border:"none",color:"white",padding:"6px 14px",borderRadius:20,cursor:"pointer",marginBottom:14,fontSize:13}}>â† Indietro</button>
        <h2 style={{color:"white",fontFamily:"Lora,serif"}}>ğŸª¤ Gestione Trappole</h2>
        <p style={{color:"#86efac",margin:"4px 0 0",fontSize:13}}>{oliveto}</p>
      </div>
      <div style={{padding:16}}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:14}}>
          <h3 style={{fontFamily:"Lora,serif",fontSize:16}}>{myT.length} trappol{myT.length===1?"a":"e"}</h3>
          <span style={{fontSize:12,color:mutedC}}>{myT.filter(t=>t.attiva).length} attive</span>
        </div>
        {myT.map(t=>(
          <div key={t.id} style={{background:cardBg,borderRadius:14,padding:14,marginBottom:10,boxShadow:dark?"0 2px 10px rgba(0,0,0,0.3)":"0 2px 10px rgba(0,0,0,0.07)",opacity:t.attiva?1:0.55}}>
            <div style={{display:"flex",alignItems:"center",gap:12}}>
              <div style={{fontSize:26}}>{tipoIcon[t.tipo]||"ğŸ”µ"}</div>
              <div style={{flex:1}}><div style={{fontWeight:700,fontSize:15}}>{t.nome}</div><div style={{fontSize:12,color:mutedC}}>{t.tipo}</div></div>
              <div style={{display:"flex",gap:8,alignItems:"center"}}>
                <div onClick={()=>toggle(t.id,t.attiva)} style={{width:42,height:24,borderRadius:12,background:t.attiva?"#16a34a":"#94a3b8",cursor:"pointer",position:"relative",transition:"background 0.2s"}}>
                  <div style={{position:"absolute",top:2,left:t.attiva?20:2,width:20,height:20,borderRadius:10,background:"white",transition:"left 0.2s",boxShadow:"0 1px 4px rgba(0,0,0,0.2)"}}/>
                </div>
                <button onClick={()=>remove(t.id)} style={{background:"none",border:"none",fontSize:16,cursor:"pointer",color:"#dc2626",padding:4}}>ğŸ—‘</button>
              </div>
            </div>
          </div>
        ))}
        {showAdd?(
          <div style={{background:cardBg,borderRadius:14,padding:16,boxShadow:dark?"0 2px 10px rgba(0,0,0,0.3)":"0 2px 10px rgba(0,0,0,0.07)"}}>
            <h4 style={{margin:"0 0 14px",fontFamily:"Lora,serif"}}>Nuova trappola</h4>
            <div style={{marginBottom:12}}>
              <label style={{display:"block",fontSize:13,fontWeight:600,color:mutedC,marginBottom:5}}>Nome trappola *</label>
              <input value={f.nome} onChange={e=>set("nome",e.target.value)} placeholder="Es. Trappola Nord" style={{...selStyle,border:`1.5px solid ${dark?"#2d4a2d":"#d1fae5"}`}}/>
            </div>
            <div style={{marginBottom:14}}>
              <label style={{display:"block",fontSize:13,fontWeight:600,color:mutedC,marginBottom:5}}>Tipo trappola</label>
              <select value={f.tipo} onChange={e=>set("tipo",e.target.value)} style={selStyle}>
                {["Cromotropica","A feromoni","Attrattivo alimentare","Multilure"].map(o=><option key={o} value={o}>{tipoIcon[o]} {o}</option>)}
              </select>
            </div>
            <div style={{display:"flex",gap:10}}>
              <button onClick={save} disabled={saving} className="btn-primary" style={{background:"#16a34a",marginBottom:0}}>{saving?<span className="spinner"/>:"ğŸ’¾ Salva"}</button>
              <button onClick={()=>setShowAdd(false)} className="btn-primary" style={{background:dark?"#334155":"#f3f4f6",color:dark?"#e2e8f0":"#374151",marginBottom:0}}>Annulla</button>
            </div>
          </div>
        ):(
          <button onClick={()=>setShowAdd(true)} style={{width:"100%",padding:14,background:dark?"#1e3a1e":"#f0fdf4",color:"#16a34a",border:"2px dashed #86efac",borderRadius:14,fontSize:15,fontWeight:600,cursor:"pointer"}}>
            + Aggiungi trappola
          </button>
        )}
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAP PICKER â€” solo OpenStreetMap (nessun CORS)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function MapPicker({initLat,initLng,onConfirm,onClose,dark}){
  const [lat,setLat]=useState(initLat||41.9);
  const [lng,setLng]=useState(initLng||12.5);
  const [off,setOff]=useState({x:0,y:0});
  const [dragging,setDragging]=useState(false);
  const [search,setSearch]=useState("");
  const [searching,setSearching]=useState(false);
  const [suggestions,setSuggestions]=useState([]);
  const mapRef=useRef(null);
  const drag=useRef(null);
  const [zoom,setZoom]=useState(13);
  const TILE=256,MW=360,MH=280;

  function toTile(la,lo){
    const n=Math.pow(2,zoom),x=((lo+180)/360)*n;
    const lr=(la*Math.PI)/180,y=((1-Math.log(Math.tan(lr)+1/Math.cos(lr))/Math.PI)/2)*n;
    return{x,y};
  }
  const center=toTile(lat,lng);
  const nx=Math.ceil(MW/TILE)+3,ny=Math.ceil(MH/TILE)+3;
  const stx=Math.floor(center.x)-Math.floor(nx/2);
  const sty=Math.floor(center.y)-Math.floor(ny/2);
  const tiles=[];
  for(let dy=0;dy<ny;dy++) for(let dx=0;dx<nx;dx++){
    const tx=stx+dx,ty=sty+dy;
    const px=(dx-Math.floor(nx/2))*TILE+MW/2+(Math.floor(center.x)-center.x)*TILE+off.x;
    const py=(dy-Math.floor(ny/2))*TILE+MH/2+(Math.floor(center.y)-center.y)*TILE+off.y;
    const safeX=((tx%Math.pow(2,zoom))+Math.pow(2,zoom))%Math.pow(2,zoom);
    const safeY=Math.max(0,Math.min(Math.pow(2,zoom)-1,ty));
    tiles.push({sx:safeX,ty:safeY,px,py});
  }
  // Solo OSM â€” nessun problema CORS
  function tileUrl(sx,ty){ return `https://tile.openstreetmap.org/${zoom}/${sx}/${ty}.png`; }

  function pxToLL(px,py){
    const rx=(px-MW/2-off.x)/TILE+center.x,ry=(py-MH/2-off.y)/TILE+center.y,n=Math.pow(2,zoom);
    return{
      lat:parseFloat(((Math.atan(Math.sinh(Math.PI*(1-(2*ry)/n)))*180)/Math.PI).toFixed(6)),
      lng:parseFloat(((rx/n)*360-180).toFixed(6))
    };
  }
  function onClick(e){if(dragging)return;const r=mapRef.current.getBoundingClientRect();const{lat:nl,lng:nlo}=pxToLL(e.clientX-r.left,e.clientY-r.top);setLat(nl);setLng(nlo);setOff({x:0,y:0});}
  const touch=useRef({});
  function onTouchStart(e){
    if(e.touches.length===1){ drag.current={x:e.touches[0].clientX,y:e.touches[0].clientY,ox:off.x,oy:off.y}; }
    else if(e.touches.length===2){
      const dx=e.touches[0].clientX-e.touches[1].clientX,dy=e.touches[0].clientY-e.touches[1].clientY;
      touch.current.pinchDist=Math.sqrt(dx*dx+dy*dy);touch.current.pinchZoom=zoom;
    }
  }
  function onTouchMove(e){
    e.preventDefault();
    if(e.touches.length===1&&drag.current){
      const dx=e.touches[0].clientX-drag.current.x,dy=e.touches[0].clientY-drag.current.y;
      if(Math.abs(dx)>3||Math.abs(dy)>3) setDragging(true);
      setOff({x:drag.current.ox+dx,y:drag.current.oy+dy});
    } else if(e.touches.length===2&&touch.current.pinchDist){
      const dx=e.touches[0].clientX-e.touches[1].clientX,dy=e.touches[0].clientY-e.touches[1].clientY;
      const dist=Math.sqrt(dx*dx+dy*dy);
      const ratio=dist/touch.current.pinchDist;
      const newZoom=Math.round(Math.max(3,Math.min(19,touch.current.pinchZoom+Math.log2(ratio))));
      if(newZoom!==zoom){setZoom(newZoom);setOff({x:0,y:0});}
    }
  }
  function onTouchEnd(){
    if(dragging){const{lat:nl,lng:nlo}=pxToLL(MW/2-off.x,MH/2-off.y);setLat(nl);setLng(nlo);setOff({x:0,y:0});}
    setTimeout(()=>setDragging(false),10);drag.current=null;touch.current={};
  }
  function onMD(e){drag.current={x:e.clientX,y:e.clientY,ox:off.x,oy:off.y};}
  function onMM(e){if(!drag.current)return;const dx=e.clientX-drag.current.x,dy=e.clientY-drag.current.y;if(Math.abs(dx)>3||Math.abs(dy)>3)setDragging(true);setOff({x:drag.current.ox+dx,y:drag.current.oy+dy});}
  function onMU(){if(dragging){const{lat:nl,lng:nlo}=pxToLL(MW/2-off.x,MH/2-off.y);setLat(nl);setLng(nlo);setOff({x:0,y:0});}setTimeout(()=>setDragging(false),10);drag.current=null;}
  function useGPS(){navigator.geolocation?.getCurrentPosition(p=>{setLat(+p.coords.latitude.toFixed(6));setLng(+p.coords.longitude.toFixed(6));setOff({x:0,y:0});},()=>alert("GPS non disponibile"));}

  // Ricerca con Nominatim â€” senza header User-Agent custom (browser non lo permette)
  async function doSearch(){
    if(!search.trim()) return;
    setSearching(true);setSuggestions([]);
    try{
      const url=`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(search)}&format=json&limit=6&countrycodes=it&accept-language=it`;
      const r=await fetch(url);
      const data=await r.json();
      setSuggestions(data);
    }catch(e){ alert("Ricerca non disponibile, inserisci le coordinate manualmente"); }
    setSearching(false);
  }
  function pickSuggestion(s){
    setLat(+parseFloat(s.lat).toFixed(6));setLng(+parseFloat(s.lon).toFixed(6));
    setOff({x:0,y:0});setSuggestions([]);setSearch(s.display_name.split(",")[0]);
  }

  return(
    <div style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.85)",zIndex:1000,display:"flex",alignItems:"center",justifyContent:"center",padding:12,overflowY:"auto"}}>
      <div style={{background:dark?"#1e293b":"white",borderRadius:20,overflow:"hidden",width:"100%",maxWidth:400,boxShadow:"0 30px 80px rgba(0,0,0,0.6)"}}>
        <div style={{background:"linear-gradient(135deg,#052e16,#166534)",padding:"12px 16px",display:"flex",justifyContent:"space-between",alignItems:"center"}}>
          <div>
            <h3 style={{color:"white",fontFamily:"Lora,serif",fontSize:16,margin:0}}>ğŸ“ Posizione oliveto</h3>
            <p style={{color:"#86efac",fontSize:11,margin:"2px 0 0"}}>Cerca Â· clicca Â· trascina Â· GPS</p>
          </div>
          <button onClick={onClose} style={{background:"rgba(255,255,255,0.2)",border:"none",color:"white",width:30,height:30,borderRadius:15,cursor:"pointer",fontSize:18}}>Ã—</button>
        </div>
        {/* Ricerca */}
        <div style={{padding:"10px 12px",background:dark?"#273549":"#f0fdf4",borderBottom:`1px solid ${dark?"#334155":"#d1fae5"}`,position:"relative"}}>
          <div style={{display:"flex",gap:8}}>
            <input value={search} onChange={e=>setSearch(e.target.value)} onKeyDown={e=>e.key==="Enter"&&doSearch()}
              placeholder="ğŸ” Cerca comune o indirizzo..."
              style={{flex:1,padding:"9px 12px",border:`1.5px solid ${dark?"#334155":"#86efac"}`,borderRadius:10,fontSize:13,outline:"none",background:dark?"#1e293b":"white",color:dark?"#e2e8f0":"#1a1a2e"}}/>
            <button onClick={doSearch} disabled={searching}
              style={{padding:"9px 14px",background:"#16a34a",color:"white",border:"none",borderRadius:10,cursor:"pointer",fontSize:13,fontWeight:700,flexShrink:0}}>
              {searching?<span className="spinner"/>:"Cerca"}
            </button>
          </div>
          {suggestions.length>0&&<div style={{position:"absolute",top:"100%",left:12,right:12,background:dark?"#1e293b":"white",borderRadius:10,boxShadow:"0 8px 24px rgba(0,0,0,0.2)",zIndex:50,overflow:"hidden",maxHeight:180,overflowY:"auto"}}>
            {suggestions.map((s,i)=><div key={i} onClick={()=>pickSuggestion(s)}
              style={{padding:"10px 14px",cursor:"pointer",borderBottom:`1px solid ${dark?"#334155":"#f3f4f6"}`,fontSize:13,color:dark?"#e2e8f0":"#1a1a2e"}}>
              ğŸ“ {s.display_name.split(",").slice(0,3).join(",")}
            </div>)}
          </div>}
        </div>
        {/* Mappa OSM */}
        <div ref={mapRef} style={{position:"relative",width:"100%",height:MH,overflow:"hidden",cursor:dragging?"grabbing":"crosshair",userSelect:"none",background:"#c8d8c8"}}
          onClick={onClick} onMouseDown={onMD} onMouseMove={onMM} onMouseUp={onMU} onMouseLeave={onMU}
          onTouchStart={onTouchStart} onTouchMove={onTouchMove} onTouchEnd={onTouchEnd}>
          {tiles.map((t,i)=>(
            <img key={i} src={tileUrl(t.sx,t.ty)}
              style={{position:"absolute",width:TILE,height:TILE,left:t.px,top:t.py,pointerEvents:"none"}}
              alt="" draggable={false}
              onError={e=>{e.target.style.opacity="0";}}/>
          ))}
          <div style={{position:"absolute",left:"50%",top:"50%",transform:"translate(-50%,-100%)",pointerEvents:"none",zIndex:10,fontSize:32,filter:"drop-shadow(0 2px 8px rgba(0,0,0,0.8))"}}>ğŸ“</div>
          <div style={{position:"absolute",bottom:8,left:8,background:"rgba(0,0,0,0.65)",color:"white",padding:"3px 8px",borderRadius:6,fontSize:11,fontFamily:"monospace",zIndex:10,pointerEvents:"none"}}>
            {lat.toFixed(5)}, {lng.toFixed(5)} Â· z{zoom}
          </div>
          <div style={{position:"absolute",top:8,right:8,display:"flex",flexDirection:"column",gap:4,zIndex:20}}>
            <button onClick={e=>{e.stopPropagation();setZoom(z=>Math.min(z+1,19));setOff({x:0,y:0});}}
              style={{width:32,height:32,background:"white",border:"none",borderRadius:8,cursor:"pointer",fontSize:20,fontWeight:700,boxShadow:"0 2px 8px rgba(0,0,0,0.35)",color:"#16a34a",display:"flex",alignItems:"center",justifyContent:"center"}}>+</button>
            <button onClick={e=>{e.stopPropagation();setZoom(z=>Math.max(z-1,3));setOff({x:0,y:0});}}
              style={{width:32,height:32,background:"white",border:"none",borderRadius:8,cursor:"pointer",fontSize:20,fontWeight:700,boxShadow:"0 2px 8px rgba(0,0,0,0.35)",color:"#16a34a",display:"flex",alignItems:"center",justifyContent:"center"}}>âˆ’</button>
          </div>
          <button onClick={e=>{e.stopPropagation();useGPS();}}
            style={{position:"absolute",bottom:8,right:8,background:"white",border:"none",borderRadius:8,padding:"6px 11px",cursor:"pointer",fontSize:12,fontWeight:700,boxShadow:"0 2px 8px rgba(0,0,0,0.35)",zIndex:20,color:"#16a34a"}}>
            ğŸ¯ GPS
          </button>
        </div>
        {/* Coordinate manuali */}
        <div style={{padding:"10px 12px",background:dark?"#1e293b":"#f8fafc",borderTop:`1px solid ${dark?"#334155":"#e5e7eb"}`,display:"flex",gap:8}}>
          {[["LAT",lat,setLat],["LNG",lng,setLng]].map(([lbl,val,fn])=>(
            <div key={lbl} style={{flex:1}}>
              <label style={{fontSize:10,fontWeight:700,color:dark?"#94a3b8":"#6b7280",display:"block",marginBottom:3}}>{lbl}</label>
              <input type="number" value={val} onChange={e=>{fn(+e.target.value);setOff({x:0,y:0});}} step="0.000001"
                style={{width:"100%",padding:"6px 8px",border:`1.5px solid ${dark?"#334155":"#d1fae5"}`,borderRadius:7,fontSize:12,outline:"none",boxSizing:"border-box",fontFamily:"monospace",background:dark?"#273549":"white",color:dark?"#e2e8f0":"#1a1a2e"}}/>
            </div>
          ))}
        </div>
        <div style={{padding:"8px 12px 14px"}}>
          <button onClick={()=>onConfirm(lat,lng)} className="btn-primary" style={{background:"#16a34a",marginBottom:0}}>âœ… Conferma posizione</button>
        </div>
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIELD INPUT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function FieldInput({label,value,onChange,type="text",placeholder="",dark,borderColor}){
  const bc=borderColor||(dark?"#2d4a2d":"#d1fae5");
  return(
    <div style={{marginBottom:14}}>
      <label style={{display:"block",fontSize:13,fontWeight:600,color:dark?"#94a3b8":"#374151",marginBottom:6}}>{label}</label>
      <input type={type} value={value} onChange={onChange} placeholder={placeholder}
        style={{width:"100%",padding:"10px 14px",border:`1.5px solid ${bc}`,borderRadius:10,fontSize:14,outline:"none",boxSizing:"border-box",background:dark?"#1e293b":"white",color:dark?"#e2e8f0":"#1a1a2e"}}/>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ADD CLIENTE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function AddCliente({onBack,onSave,dark}){
  const [f,setF]=useState({nome:"",telefono:"",email:"",note:""});
  const [saving,setSaving]=useState(false);
  const set=(k,v)=>setF(p=>({...p,[k]:v}));
  const grad=dark?"linear-gradient(135deg,#0f0c29,#1e1b4b)":"linear-gradient(135deg,#1e1b4b,#3730a3)";
  async function save(){
    if(!f.nome.trim()){alert("Inserisci il nome del cliente");return;}
    setSaving(true);
    await onSave(f);
    setSaving(false);
  }
  return(
    <div>
      <div style={{background:grad,padding:"20px 20px 28px"}}>
        <button onClick={onBack} style={{background:"rgba(255,255,255,0.2)",border:"none",color:"white",padding:"6px 14px",borderRadius:20,cursor:"pointer",marginBottom:14,fontSize:13}}>â† Indietro</button>
        <h2 style={{color:"white",fontFamily:"Lora,serif"}}>ğŸ‘¤ Nuovo cliente</h2>
        <p style={{color:"#a5b4fc",margin:"4px 0 0",fontSize:13}}>Aggiungi i dati del cliente</p>
      </div>
      <div style={{padding:16}}>
        <FieldInput label="Nome e cognome *" value={f.nome} onChange={e=>set("nome",e.target.value)} placeholder="Es. Mario Rossi" dark={dark} borderColor={dark?"#2d2b6b":"#c7d2fe"}/>
        <FieldInput label="Telefono" value={f.telefono} onChange={e=>set("telefono",e.target.value)} placeholder="Es. 333 1234567" type="tel" dark={dark} borderColor={dark?"#2d2b6b":"#c7d2fe"}/>
        <FieldInput label="Email" value={f.email} onChange={e=>set("email",e.target.value)} placeholder="mario@email.it" type="email" dark={dark} borderColor={dark?"#2d2b6b":"#c7d2fe"}/>
        <FieldInput label="Note" value={f.note} onChange={e=>set("note",e.target.value)} placeholder="Annotazioni..." dark={dark} borderColor={dark?"#2d2b6b":"#c7d2fe"}/>
        <button onClick={save} disabled={saving} className="btn-primary" style={{background:dark?"#2d2b6b":"#3730a3"}}>
          {saving?<span className="spinner"/>:"ğŸ’¾ Salva cliente"}
        </button>
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ADD OLIVETO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function AddOliveto({clienteId,clienteNome,onBack,onSave,dark}){
  const [f,setF]=useState({nome:"",comune:"",varieta:"",piante:"",ha:"",lat:"",lng:""});
  const [showMap,setShowMap]=useState(false);
  const [saving,setSaving]=useState(false);
  const set=(k,v)=>setF(p=>({...p,[k]:v}));
  const grad=dark?"linear-gradient(135deg,#051a08,#0a2e0a)":"linear-gradient(135deg,#052e16,#166534)";

  const mapModal=showMap?createPortal(
    <MapPicker
      initLat={f.lat?+f.lat:41.9}
      initLng={f.lng?+f.lng:12.5}
      onConfirm={(la,lo)=>{set("lat",la+"");set("lng",lo+"");setShowMap(false);}}
      onClose={()=>setShowMap(false)}
      dark={dark}
    />,document.body
  ):null;

  async function save(){
    if(!f.nome.trim()||!f.comune.trim()){alert("Nome oliveto e comune sono obbligatori");return;}
    setSaving(true);
    await onSave({...f,clienteId});
    setSaving(false);
  }

  return(<>
    {mapModal}
    <div>
      <div style={{background:grad,padding:"20px 20px 28px"}}>
        <button onClick={onBack} style={{background:"rgba(255,255,255,0.2)",border:"none",color:"white",padding:"6px 14px",borderRadius:20,cursor:"pointer",marginBottom:14,fontSize:13}}>â† Indietro</button>
        <h2 style={{color:"white",fontFamily:"Lora,serif"}}>ğŸ«’ Nuovo oliveto</h2>
        {clienteNome&&<p style={{color:"#86efac",margin:"4px 0 0",fontSize:13}}>Cliente: {clienteNome}</p>}
      </div>
      <div style={{padding:16}}>
        <FieldInput label="Nome oliveto *" value={f.nome} onChange={e=>set("nome",e.target.value)} placeholder="Es. Oliveto Collina" dark={dark}/>
        <FieldInput label="Comune / LocalitÃ  *" value={f.comune} onChange={e=>set("comune",e.target.value)} placeholder="Es. Imperia" dark={dark}/>
        <FieldInput label="VarietÃ " value={f.varieta} onChange={e=>set("varieta",e.target.value)} placeholder="Es. Taggiasca" dark={dark}/>
        <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12,marginBottom:4}}>
          <FieldInput label="NÂ° piante" value={f.piante} onChange={e=>set("piante",e.target.value)} type="number" placeholder="Es. 320" dark={dark}/>
          <FieldInput label="Ettari" value={f.ha} onChange={e=>set("ha",e.target.value)} type="number" placeholder="Es. 2.5" dark={dark}/>
        </div>
        <label style={{display:"block",fontSize:13,fontWeight:600,color:dark?"#94a3b8":"#374151",marginBottom:8}}>Coordinate GPS (opzionale)</label>
        {f.lat&&f.lng?(
          <div style={{background:dark?"#1e3a1e":"#f0fdf4",border:"1.5px solid #86efac",borderRadius:12,padding:14,display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:14}}>
            <div>
              <div style={{fontSize:13,color:"#4ade80",fontWeight:600}}>ğŸ“ Posizione impostata</div>
              <div style={{fontSize:12,color:dark?"#94a3b8":"#6b7280",fontFamily:"monospace"}}>{f.lat}, {f.lng}</div>
            </div>
            <button onClick={()=>setShowMap(true)} style={{background:"#16a34a",color:"white",border:"none",borderRadius:8,padding:"6px 12px",cursor:"pointer",fontSize:12,fontWeight:700}}>âœï¸ Modifica</button>
          </div>
        ):(
          <button onClick={()=>setShowMap(true)} className="btn-primary" style={{background:dark?"#051505":"#052e16",display:"flex",alignItems:"center",justifyContent:"center",gap:8}}>ğŸ—ºï¸ Apri mappa</button>
        )}
        <button onClick={save} disabled={saving} className="btn-primary" style={{background:"#16a34a"}}>
          {saving?<span className="spinner"/>:"ğŸ’¾ Salva oliveto"}
        </button>
      </div>
    </div>
  </>);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ADD TRATTAMENTO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function AddTrattamento({oliveto,onBack,onSave,dark}){
  const [f,setF]=useState({data:new Date().toISOString().slice(0,10),prodotto:"",dose:"",note:""});
  const [saving,setSaving]=useState(false);
  const set=(k,v)=>setF(p=>({...p,[k]:v}));
  const grad=dark?"linear-gradient(135deg,#051a08,#0a2e0a)":"linear-gradient(135deg,#052e16,#166534)";
  async function save(){
    if(!f.prodotto){alert("Inserisci il prodotto");return;}
    setSaving(true);
    await onSave({...f,oId:oliveto.id});
    setSaving(false);
  }
  return(
    <div>
      <div style={{background:grad,padding:"20px 20px 28px"}}>
        <button onClick={onBack} style={{background:"rgba(255,255,255,0.2)",border:"none",color:"white",padding:"6px 14px",borderRadius:20,cursor:"pointer",marginBottom:14,fontSize:13}}>â† Indietro</button>
        <h2 style={{color:"white",fontFamily:"Lora,serif"}}>ğŸ’Š Nuovo trattamento</h2>
        <p style={{color:"#86efac",margin:"4px 0 0",fontSize:13}}>{oliveto.nome}</p>
      </div>
      <div style={{padding:16}}>
        {[["data","Data","date"],["prodotto","Prodotto *","text"],["dose","Dose","text"],["note","Note","text"]].map(([k,lbl,type])=>(
          <FieldInput key={k} label={lbl} value={f[k]} onChange={e=>set(k,e.target.value)} type={type} dark={dark}/>
        ))}
        <button onClick={save} disabled={saving} className="btn-primary" style={{background:"#16a34a"}}>
          {saving?<span className="spinner"/>:"ğŸ’¾ Salva trattamento"}
        </button>
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ADD RILEVAMENTO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function AddRilevamento({oliveti,traps,clienteId,preOId,onBack,onSave,dark}){
  const [oId,setOId]=useState(preOId||"");
  const [trapId,setTrapId]=useState("");
  const [f,setF]=useState({data:new Date().toISOString().slice(0,10),mosche:"",meteo:"",fase:""});
  const [saving,setSaving]=useState(false);
  const set=(k,v)=>setF(p=>({...p,[k]:v}));
  const myOl=clienteId?oliveti.filter(o=>o.cliente_id===clienteId):oliveti;
  const myTraps=(traps||[]).filter(t=>(t.oliveto_id||t.oId)===oId&&t.attiva);
  const m=parseInt(f.mosche)||0;
  const selStyle={width:"100%",padding:"10px 14px",border:`1.5px solid ${dark?"#2d2b6b":"#ddd5fe"}`,borderRadius:10,fontSize:14,outline:"none",background:dark?"#1e293b":"white",color:dark?"#e2e8f0":"#1a1a2e",marginBottom:14};
  const grad=dark?"linear-gradient(135deg,#080614,#110e2e)":"linear-gradient(135deg,#1e1b4b,#3730a3)";

  async function save(){
    if(!oId||!trapId||!f.mosche){alert("Seleziona oliveto, trappola e inserisci nÂ° mosche");return;}
    setSaving(true);
    await onSave({...f,mosche:m,oId,trapId});
    setSaving(false);
  }
  return(
    <div>
      <div style={{background:grad,padding:"20px 20px 28px"}}>
        <button onClick={onBack} style={{background:"rgba(255,255,255,0.2)",border:"none",color:"white",padding:"6px 14px",borderRadius:20,cursor:"pointer",marginBottom:14,fontSize:13}}>â† Indietro</button>
        <h2 style={{color:"white",fontFamily:"Lora,serif"}}>ğŸª¤ Nuovo monitoraggio</h2>
      </div>
      <div style={{padding:16}}>
        {!preOId&&<>
          <label style={{display:"block",fontSize:13,fontWeight:600,color:dark?"#94a3b8":"#374151",marginBottom:6}}>Oliveto *</label>
          <select value={oId} onChange={e=>{setOId(e.target.value);setTrapId("");}} style={selStyle}>
            <option value="">â€” seleziona â€”</option>
            {myOl.map(o=><option key={o.id} value={o.id}>{o.nome} ({o.comune||o.loc||""})</option>)}
          </select>
        </>}
        <label style={{display:"block",fontSize:13,fontWeight:600,color:dark?"#94a3b8":"#374151",marginBottom:6}}>Trappola *</label>
        {oId&&myTraps.length===0?(
          <div style={{background:"rgba(220,38,38,0.1)",border:"1.5px solid #dc2626",borderRadius:10,padding:"10px 14px",fontSize:13,color:"#dc2626",marginBottom:14}}>
            âš ï¸ Nessuna trappola attiva per questo oliveto. Aggiungila dalla scheda oliveto.
          </div>
        ):(
          <select value={trapId} onChange={e=>setTrapId(e.target.value)} disabled={!oId} style={{...selStyle,opacity:!oId?0.5:1}}>
            <option value="">â€” seleziona trappola â€”</option>
            {myTraps.map(t=><option key={t.id} value={t.id}>{t.nome} ({t.tipo})</option>)}
          </select>
        )}
        <FieldInput label="Data *" value={f.data} onChange={e=>set("data",e.target.value)} type="date" dark={dark} borderColor={dark?"#2d2b6b":"#ddd5fe"}/>
        <FieldInput label="Mosche catturate *" value={f.mosche} onChange={e=>set("mosche",e.target.value)} type="number" placeholder="Es. 25" dark={dark} borderColor={dark?"#2d2b6b":"#ddd5fe"}/>
        {[["meteo","Meteo",["Soleggiato","Nuvoloso","Variabile","Caldo umido","Fresco","Piovoso"]],
          ["fase","Fase fenologica",["Allegagione","Ingrossamento frutto","Indurimento nocciolo","Invaiatura","Maturazione","Raccolta"]]
        ].map(([k,lbl,opts])=>(
          <div key={k} style={{marginBottom:14}}>
            <label style={{display:"block",fontSize:13,fontWeight:600,color:dark?"#94a3b8":"#374151",marginBottom:6}}>{lbl}</label>
            <select value={f[k]} onChange={e=>set(k,e.target.value)} style={selStyle}>
              <option value="">â€” seleziona â€”</option>
              {opts.map(o=><option key={o} value={o}>{o}</option>)}
            </select>
          </div>
        ))}
        {m>=SA&&<div style={{background:m>=SP?"rgba(220,38,38,0.1)":"rgba(217,119,6,0.1)",border:`1.5px solid ${m>=SP?"#dc2626":"#d97706"}`,borderRadius:12,padding:12,marginBottom:14}}>
          <strong style={{color:m>=SP?"#dc2626":"#d97706"}}>{m>=SP?"ğŸš¨ Soglia PERICOLO superata!":"âš ï¸ Soglia ALLERTA superata!"}</strong>
        </div>}
        <button onClick={save} disabled={saving} className="btn-primary" style={{background:dark?"#2d2b6b":"#3730a3"}}>
          {saving?<span className="spinner"/>:"ğŸ’¾ Salva monitoraggio"}
        </button>
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ADD STEREOSCOPIO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function AddStereoscopio({oliveti,clienteId,preOId,onBack,onSave,dark}){
  const [oId,setOId]=useState(preOId||"");
  const [f,setF]=useState({data:new Date().toISOString().slice(0,10),camp:"",uova:"",l1:"",l2:"",l3:"",pupe:"",fori:""});
  const [saving,setSaving]=useState(false);
  const set=(k,v)=>setF(p=>({...p,[k]:v}));
  const n=k=>parseInt(f[k])||0;
  const camp=n("camp"),uova=n("uova"),l1=n("l1"),l2=n("l2"),l3=n("l3"),pupe=n("pupe"),fori=n("fori");
  const att=camp>0?Math.min(((uova+l1+l2)/camp)*100,100):0;
  const tot=camp>0?Math.min(((uova+l1+l2+l3+pupe+fori)/camp)*100,100):0;
  const myOl=clienteId?oliveti.filter(o=>o.cliente_id===clienteId):oliveti;
  const selStyle={width:"100%",padding:"10px 14px",border:`1.5px solid ${dark?"#2d2b6b":"#ddd5fe"}`,borderRadius:10,fontSize:14,outline:"none",background:dark?"#1e293b":"white",color:dark?"#e2e8f0":"#1a1a2e",marginBottom:14};
  const cardBg=dark?"#1e293b":"white";
  const stadi=[["uova","ğŸ¥š Uova","#f59e0b",true],["l1","L1","#10b981",true],["l2","L2","#059669",true],["l3","L3","#047857",false],["pupe","ğŸ«˜ Pupe","#7c3aed",false],["fori","ğŸ•³ï¸ Fori","#6b7280",false]];
  const grad=dark?"linear-gradient(135deg,#080614,#110e2e)":"linear-gradient(135deg,#1e1b4b,#3730a3)";

  async function save(){
    if(!oId||!f.camp){alert("Seleziona oliveto e inserisci nÂ° campioni");return;}
    setSaving(true);
    await onSave({data:f.data,camp,uova,l1,l2,l3,pupe,fori,oId,stagione:new Date(f.data).getFullYear()});
    setSaving(false);
  }
  return(
    <div>
      <div style={{background:grad,padding:"20px 20px 28px"}}>
        <button onClick={onBack} style={{background:"rgba(255,255,255,0.2)",border:"none",color:"white",padding:"6px 14px",borderRadius:20,cursor:"pointer",marginBottom:14,fontSize:13}}>â† Indietro</button>
        <h2 style={{color:"white",fontFamily:"Lora,serif"}}>ğŸ”¬ Campionamento stereoscopio</h2>
      </div>
      <div style={{padding:16}}>
        {!preOId&&<>
          <label style={{display:"block",fontSize:13,fontWeight:600,color:dark?"#94a3b8":"#374151",marginBottom:6}}>Oliveto *</label>
          <select value={oId} onChange={e=>setOId(e.target.value)} style={selStyle}>
            <option value="">â€” seleziona â€”</option>
            {myOl.map(o=><option key={o.id} value={o.id}>{o.nome} ({o.comune||o.loc||""})</option>)}
          </select>
        </>}
        <FieldInput label="Data *" value={f.data} onChange={e=>set("data",e.target.value)} type="date" dark={dark} borderColor={dark?"#2d2b6b":"#ddd5fe"}/>
        <FieldInput label="NÂ° olive campionate *" value={f.camp} onChange={e=>set("camp",e.target.value)} type="number" dark={dark} borderColor={dark?"#2d2b6b":"#ddd5ve"}/>
        <div style={{background:cardBg,borderRadius:16,padding:16,marginBottom:16,boxShadow:dark?"0 2px 10px rgba(0,0,0,0.3)":"0 2px 10px rgba(0,0,0,0.07)"}}>
          <h4 style={{margin:"0 0 14px",fontFamily:"Lora,serif",fontSize:15}}>Stadi rilevati (nÂ° olive)</h4>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12}}>
            {stadi.map(([k,lbl,color,isAtt])=>(
              <div key={k}>
                <label style={{display:"block",fontSize:11,fontWeight:700,color,marginBottom:5}}>
                  {lbl} {isAtt&&<span style={{background:"rgba(253,224,71,0.2)",color:"#d97706",padding:"1px 5px",borderRadius:4,fontSize:9,fontWeight:700}}>ATTIVA</span>}
                </label>
                <input type="number" min="0" value={f[k]} onChange={e=>set(k,e.target.value)}
                  style={{width:"100%",padding:"9px",border:`1.5px solid ${color}40`,borderRadius:10,fontSize:18,fontWeight:700,outline:"none",boxSizing:"border-box",textAlign:"center",color,background:dark?"#273549":"white"}}/>
              </div>
            ))}
          </div>
        </div>
        {camp>0&&<div style={{background:cardBg,borderRadius:16,padding:16,marginBottom:16,boxShadow:dark?"0 2px 10px rgba(0,0,0,0.3)":"0 2px 10px rgba(0,0,0,0.07)"}}>
          <h4 style={{margin:"0 0 12px",fontFamily:"Lora,serif",fontSize:14}}>ğŸ“Š Anteprima</h4>
          <InfBar label="Inf. ATTIVA (Uova+L1+L2)" value={att} color={cInf(att)}/>
          <InfBar label="Inf. TOTALE (tutti gli stadi)" value={tot} color={tot>20?"#dc2626":tot>10?"#d97706":"#7c3aed"}/>
        </div>}
        <button onClick={save} disabled={saving} className="btn-primary" style={{background:dark?"#2d2b6b":"#3730a3"}}>
          {saving?<span className="spinner"/>:"ğŸ’¾ Salva campionamento"}
        </button>
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SOGLIE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function Soglie({onBack,dark}){
  const [s1,setS1]=useState(SA),[s2,setS2]=useState(SP);
  const [i1,setI1]=useState(IA),[i2,setI2]=useState(IP);
  const [ok,setOk]=useState(false);
  function save(){SA=+s1;SP=+s2;IA=+i1;IP=+i2;setOk(true);setTimeout(()=>setOk(false),2000);}
  const cardBg=dark?"#1e293b":"white";
  const grad=dark?"linear-gradient(135deg,#080614,#110e2e)":"linear-gradient(135deg,#1e1b4b,#3730a3)";
  const mutedC=dark?"#94a3b8":"#6b7280";
  return(
    <div>
      <div style={{background:grad,padding:"20px 20px 28px"}}>
        <button onClick={onBack} style={{background:"rgba(255,255,255,0.2)",border:"none",color:"white",padding:"6px 14px",borderRadius:20,cursor:"pointer",marginBottom:14,fontSize:13}}>â† Indietro</button>
        <h2 style={{color:"white",fontFamily:"Lora,serif"}}>âš™ï¸ Soglie di allerta</h2>
      </div>
      <div style={{padding:16}}>
        <div style={{background:cardBg,borderRadius:16,padding:20,boxShadow:dark?"0 2px 10px rgba(0,0,0,0.3)":"0 2px 10px rgba(0,0,0,0.07)",marginBottom:16}}>
          <h4 style={{fontFamily:"Lora,serif",fontSize:15,margin:"0 0 14px"}}>ğŸª¤ Soglie mosche (nÂ°)</h4>
          {[["âš ï¸ Allerta","#d97706",s1,setS1],["ğŸš¨ Pericolo","#dc2626",s2,setS2]].map(([lbl,color,val,fn])=>(
            <div key={lbl} style={{marginBottom:16}}>
              <label style={{display:"block",fontSize:13,fontWeight:600,marginBottom:6,color}}>{lbl}</label>
              <input type="number" value={val} onChange={e=>fn(e.target.value)}
                style={{width:"100%",padding:"11px 14px",border:`1.5px solid ${color}60`,borderRadius:10,fontSize:20,fontWeight:700,outline:"none",boxSizing:"border-box",background:dark?"#273549":"white",color:dark?"#e2e8f0":"#1a1a2e"}}/>
            </div>
          ))}
        </div>
        <div style={{background:cardBg,borderRadius:16,padding:20,boxShadow:dark?"0 2px 10px rgba(0,0,0,0.3)":"0 2px 10px rgba(0,0,0,0.07)",marginBottom:16}}>
          <h4 style={{fontFamily:"Lora,serif",fontSize:15,margin:"0 0 14px"}}>ğŸ”¬ Soglie infestazione (%)</h4>
          {[["âš ï¸ Allerta %","#d97706",i1,setI1],["ğŸš¨ Pericolo %","#dc2626",i2,setI2]].map(([lbl,color,val,fn])=>(
            <div key={lbl} style={{marginBottom:16}}>
              <label style={{display:"block",fontSize:13,fontWeight:600,marginBottom:6,color}}>{lbl}</label>
              <input type="number" value={val} onChange={e=>fn(e.target.value)}
                style={{width:"100%",padding:"11px 14px",border:`1.5px solid ${color}60`,borderRadius:10,fontSize:20,fontWeight:700,outline:"none",boxSizing:"border-box",background:dark?"#273549":"white",color:dark?"#e2e8f0":"#1a1a2e"}}/>
            </div>
          ))}
          <p style={{fontSize:11,color:mutedC,margin:0}}>Basato sull&#39;infestazione ATTIVA (Uova+L1+L2)</p>
        </div>
        <button onClick={save} className="btn-primary" style={{background:ok?"#16a34a":(dark?"#2d2b6b":"#3730a3"),transition:"background 0.3s",marginBottom:0}}>
          {ok?"âœ… Salvato!":"ğŸ’¾ Salva soglie"}
        </button>
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function Export({oliveti,clienti,rils,sters,trats,onBack,dark}){
  const cardBg=dark?"#1e293b":"white";
  const grad=dark?"linear-gradient(135deg,#080614,#110e2e)":"linear-gradient(135deg,#1e1b4b,#3730a3)";
  const mutedC=dark?"#94a3b8":"#6b7280";
  const [selCliente,setSelCliente]=useState("");
  const selStyle={width:"100%",padding:"10px 14px",border:`1.5px solid ${dark?"#334155":"#d1fae5"}`,borderRadius:10,fontSize:13,outline:"none",background:dark?"#1e293b":"white",color:dark?"#e2e8f0":"#1a1a2e",marginBottom:14};

  function dl(rows,name){
    const q=String.fromCharCode(34);
    const csv=rows.map(r=>r.map(v=>q+(v||"")+q).join(",")).join("\n");
    const a=document.createElement("a");a.href=URL.createObjectURL(new Blob(["\uFEFF"+csv],{type:"text/csv;charset=utf-8"}));a.download=name;a.click();
  }
  function myOl(){ return selCliente?oliveti.filter(o=>o.cliente_id===selCliente):oliveti; }
  function filterByOl(items){ const ids=myOl().map(o=>o.id); return items.filter(x=>ids.includes(x.oliveto_id)||ids.includes(x.oId)); }

  function expRil(){
    const rows=[["Cliente","Oliveto","Data","Mosche","Trappola","Meteo","Fase","Rischio"]];
    filterByOl(rils).forEach(r=>{
      const o=oliveti.find(x=>x.id===r.oliveto_id||x.id===r.oId);
      const c=clienti.find(x=>x.id===o?.cliente_id);
      rows.push([c?.nome||"",o?.nome||"",r.data,r.mosche,r.trappola||"",r.meteo||"",r.fase||"",rischio(r.mosche).l]);
    });
    dl(rows,"olivetrack_monitoraggi.csv");
  }
  function expSter(){
    const rows=[["Cliente","Oliveto","Data","Campione","Uova","L1","L2","L3","Pupe","Fori","Att%","Tot%"]];
    filterByOl(sters).forEach(s=>{
      const o=oliveti.find(x=>x.id===s.oliveto_id||x.id===s.oId);
      const c=clienti.find(x=>x.id===o?.cliente_id);
      const i=calcInf(s);
      if(i) rows.push([c?.nome||"",o?.nome||"",s.data,s.camp,s.uova,s.l1,s.l2,s.l3,s.pupe,s.fori,i.att.toFixed(1),i.tot.toFixed(1)]);
    });
    dl(rows,"olivetrack_campionamenti.csv");
  }

  function stampaPDF(){
    const c=selCliente?clienti.find(x=>x.id===selCliente):null;
    const ol=myOl();
    const myRils=filterByOl(rils);
    const mySters=filterByOl(sters);
    const now=new Date().toLocaleDateString("it-IT");
    const css="body{font-family:Georgia,serif;color:#1a1a2e;max-width:800px;margin:0 auto;padding:20px}h1{color:#052e16;border-bottom:3px solid #052e16;padding-bottom:8px}h2{color:#166534;margin-top:24px}h3{color:#374151;font-size:15px;margin-top:16px}table{width:100%;border-collapse:collapse;font-size:12px;margin-top:8px}th{background:#052e16;color:white;padding:6px 8px;text-align:left}td{padding:5px 8px;border-bottom:1px solid #e5e7eb}tr:nth-child(even){background:#f9fafb}.tag{display:inline-block;padding:2px 8px;border-radius:10px;font-size:11px;font-weight:bold}.ok{background:#d1fae5;color:#065f46}.alert{background:#fee2e2;color:#991b1b}.warn{background:#fef3c7;color:#92400e}.footer{margin-top:32px;font-size:11px;color:#9ca3af;border-top:1px solid #e5e7eb;padding-top:8px}";
    let html="<!DOCTYPE html><html><head><meta charset='utf-8'><title>OliveTrack Report</title><style>"+css+"</style></head><body>";
    html+="<div style='display:flex;align-items:center;gap:12px;margin-bottom:20px'><span style='font-size:36px'>ğŸ«’</span>";
    html+="<div><h1 style='margin:0;border:none'>OliveTrack</h1>";
    html+="<p style='margin:0;color:#6b7280;font-size:13px'>Report "+now+(c?" Â· "+c.nome:"")+"</p></div></div>";
    ol.forEach(o=>{
      const cc=clienti.find(x=>x.id===o.cliente_id);
      const oRils=myRils.filter(r=>r.oliveto_id===o.id||r.oId===o.id).sort((a,b)=>b.data.localeCompare(a.data));
      const oSters=mySters.filter(s=>s.oliveto_id===o.id||s.oId===o.id).sort((a,b)=>b.data.localeCompare(a.data));
      const lr=oRils[0]; const ls=oSters[0];
      const rv=lr?rischio(lr.mosche):{l:"Nessun dato"};
      const inf=ls?calcInf(ls):null;
      const details=[o.comune,o.varieta,o.piante?o.piante+" piante":null,o.ha?o.ha+" ha":null,cc&&!selCliente?"ğŸ‘¤ "+cc.nome:null].filter(Boolean).join(" Â· ");
      const tagClass=rv.l==="OK"?"ok":rv.l.includes("ALLERTA")?"warn":"alert";
      html+="<h2>ğŸ«’ "+o.nome+"</h2>";
      html+="<p style='color:#6b7280;font-size:13px;margin:4px 0'>"+details+"</p>";
      html+="<p>Rischio: <span class='tag "+tagClass+"'>"+rv.l+"</span>";
      if(inf) html+=" &nbsp; Inf. attiva: <span class='tag "+(inf.att>=IP?"alert":inf.att>=IA?"warn":"ok")+"'>"+inf.att.toFixed(1)+"%</span>";
      html+="</p>";
      if(oRils.length){
        html+="<h3>Monitoraggi</h3><table><tr><th>Data</th><th>Mosche</th><th>Trappola</th><th>Meteo</th><th>Fase</th><th>Rischio</th></tr>";
        oRils.forEach(r=>{const rv2=rischio(r.mosche);const tc=rv2.l==="OK"?"ok":rv2.l.includes("ALLERTA")?"warn":"alert";html+="<tr><td>"+r.data+"</td><td>"+r.mosche+"</td><td>"+(r.trappola||"â€”")+"</td><td>"+(r.meteo||"â€”")+"</td><td>"+(r.fase||"â€”")+"</td><td><span class='tag "+tc+"'>"+rv2.l+"</span></td></tr>";});
        html+="</table>";
      }
      if(oSters.length){
        html+="<h3>Campionamenti</h3><table><tr><th>Data</th><th>Olive</th><th>Uova</th><th>L1</th><th>L2</th><th>L3</th><th>Pupe</th><th>Fori</th><th>Att%</th><th>Tot%</th></tr>";
        oSters.forEach(s=>{const i=calcInf(s);html+="<tr><td>"+s.data+"</td><td>"+s.camp+"</td><td>"+s.uova+"</td><td>"+s.l1+"</td><td>"+s.l2+"</td><td>"+s.l3+"</td><td>"+s.pupe+"</td><td>"+s.fori+"</td><td>"+i.att.toFixed(1)+"%</td><td>"+i.tot.toFixed(1)+"%</td></tr>";});
        html+="</table>";
      }
    });
    html+="<div class='footer'>OliveTrack â€” Monitoraggio Mosca delle Olive</div></body></html>";
    const w=window.open("","_blank");w.document.write(html);w.document.close();setTimeout(()=>w.print(),500);
  }

  const selStyle={width:"100%",padding:"10px 14px",border:`1.5px solid ${dark?"#334155":"#d1fae5"}`,borderRadius:10,fontSize:13,outline:"none",background:dark?"#1e293b":"white",color:dark?"#e2e8f0":"#1a1a2e",marginBottom:14};
  const statCl=selCliente?1:clienti.length;
  const statOl=myOl().length;
  const statRil=filterByOl(rils).length;
  const statSter=filterByOl(sters).length;
  return(
    <div>
      <div style={{background:grad,padding:"20px 20px 28px"}}>
        <button onClick={onBack} style={{background:"rgba(255,255,255,0.2)",border:"none",color:"white",padding:"6px 14px",borderRadius:20,cursor:"pointer",marginBottom:14,fontSize:13}}>â† Indietro</button>
        <h2 style={{color:"white",fontFamily:"Lora,serif"}}>ğŸ“Š Export dati</h2>
      </div>
      <div style={{padding:16}}>
        <label style={{display:"block",fontSize:13,fontWeight:600,color:mutedC,marginBottom:6}}>Filtra per cliente</label>
        <select value={selCliente} onChange={e=>setSelCliente(e.target.value)} style={selStyle}>
          <option value="">Tutti i clienti</option>
          {clienti.map(c=><option key={c.id} value={c.id}>{c.nome}</option>)}
        </select>
        <div style={{background:cardBg,borderRadius:16,padding:18,marginBottom:14}}>
          {[["ğŸ‘¥ Clienti",statCl],["ğŸ«’ Oliveti",statOl],["ğŸª¤ Monitoraggi",statRil],["ğŸ”¬ Campionamenti",statSter]].map(([l,v])=>(
            <div key={l} style={{display:"flex",justifyContent:"space-between",padding:"7px 0",borderBottom:`1px solid ${dark?"#334155":"#f3f4f6"}`,fontSize:14}}>
              <span>{l}</span><strong>{v}</strong>
            </div>
          ))}
        </div>
        <button onClick={stampaPDF} className="btn-primary" style={{background:"#dc2626"}}>ğŸ“„ Stampa / Salva PDF</button>
        <button onClick={expRil} className="btn-primary" style={{background:"#16a34a"}}>ğŸ“¥ CSV Monitoraggi</button>
        <button onClick={expSter} className="btn-primary" style={{background:dark?"#2d2b6b":"#3730a3"}}>ğŸ“¥ CSV Campionamenti</button>
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// OLIVETO DETAIL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function OlivetoDetail({oliveto,onBack,nav,rils,sters,trats,traps,setTraps,dark,onDeleteOliveto,onDeleteRil,onDeleteSter,onDeleteTrat,onUpdateRil,onUpdateSter,onUpdateTrat}){
  const [tab,setTab]=useState("grafici");
  const myRil=[...rils].filter(r=>r.oId===oliveto.id||r.oliveto_id===oliveto.id).sort((a,b)=>b.data.localeCompare(a.data));
  const mySter=[...sters].filter(s=>s.oId===oliveto.id||s.oliveto_id===oliveto.id).sort((a,b)=>b.data.localeCompare(a.data));
  const myTrat=[...trats].filter(t=>t.oId===oliveto.id||t.oliveto_id===oliveto.id).sort((a,b)=>b.data.localeCompare(a.data));
  const lr=myRil[0], ls=mySter[0];
  const r=lr?rischio(lr.mosche):{l:"Nessun dato",c:"#9ca3af",bg:"rgba(156,163,175,0.1)",border:"#9ca3af"};
  const infD=ls?calcInf(ls):null;
  const cardBg=dark?"#1e293b":"white";
  const mutedC=dark?"#94a3b8":"#6b7280";
  const grad=dark?"linear-gradient(135deg,#0a1f0f,#1a3a1a)":"linear-gradient(135deg,#052e16,#166534)";

  const tabs=[["grafici","ğŸ“Š Grafici"],["trappole","ğŸª¤ Monitoraggi"],["stereo","ğŸ”¬ Controlli"],["trattamenti","ğŸ’Š Trattamenti"],["potatura","ğŸŒ¿ Potatura"],["note","ğŸ“ Note"],["foto","ğŸ“· Foto"],["calendario","ğŸ“… Calendario"]];

  const oggi=new Date();
  const lastDate=lr?new Date(lr.data):null;
  const diff=lastDate?Math.floor((oggi-lastDate)/(1000*60*60*24)):null;
  const INTERVALLO=7;

  return(
    <div>
      <div style={{background:grad,padding:"16px 16px 20px"}}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:10}}>
          <button onClick={onBack} style={{background:"rgba(255,255,255,0.2)",border:"none",color:"white",padding:"6px 14px",borderRadius:20,cursor:"pointer",fontSize:13}}>â† Indietro</button>
          <button onClick={()=>{if(confirm("Eliminare \""+oliveto.nome+"\"?"))onDeleteOliveto&&onDeleteOliveto(oliveto.id);}}
            style={{background:"rgba(220,38,38,0.3)",border:"none",color:"white",padding:"6px 12px",borderRadius:20,cursor:"pointer",fontSize:12}}>ğŸ—‘</button>
        </div>
        <h2 style={{color:"white",fontFamily:"Lora,serif",fontSize:20,marginBottom:4}}>{oliveto.nome}</h2>
        <p style={{color:"rgba(255,255,255,0.7)",fontSize:13,margin:0}}>{[oliveto.comune,oliveto.varieta,oliveto.piante?oliveto.piante+" piante":null,oliveto.ha?oliveto.ha+" ha":null].filter(Boolean).join(" Â· ")}</p>
        <div style={{display:"flex",gap:8,marginTop:10,flexWrap:"wrap"}}>
          <span className="tag" style={{background:r.bg,color:r.c,border:"1px solid "+r.border}}>{r.l}</span>
          {infD&&<span className="tag" style={{background:infD.att>=IA?"rgba(217,119,6,0.2)":"rgba(22,163,74,0.2)",color:infD.att>=IA?"#d97706":"#16a34a",border:"1px solid "+(infD.att>=IA?"#d97706":"#16a34a")}}>ğŸ”¬ {infD.att.toFixed(1)}%</span>}
        </div>
      </div>

      <div style={{display:"flex",gap:6,padding:"10px 14px 0",overflowX:"auto",scrollbarWidth:"none"}}>
        {tabs.map(([id,lbl])=>(
          <button key={id} onClick={()=>setTab(id)}
            style={{padding:"7px 14px",borderRadius:20,border:"none",cursor:"pointer",fontSize:12,fontWeight:600,whiteSpace:"nowrap",flexShrink:0,
              background:tab===id?"#16a34a":(dark?"#1e3a1e":"#f0fdf4"),
              color:tab===id?"white":(dark?"#4ade80":"#16a34a")}}>
            {lbl}
          </button>
        ))}
      </div>

      <div style={{padding:14}}>
        {tab==="grafici"&&(
          <div>
            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10,marginBottom:14}}>
              {[
                [lr?lr.mosche+" mosche":"â€”","ğŸª¤","Ultima conta",r.c],
                [infD?infD.att.toFixed(1)+"%":"â€”","ğŸ”¬","Inf. attiva",infD&&infD.att>=IA?"#d97706":"#16a34a"],
                [myRil.length,"ğŸ“…","Monitoraggi","#3b82f6"],
                [mySter.length,"ğŸ”¬","Campionamenti","#8b5cf6"],
              ].map(([val,icon,lbl,color])=>(
                <div key={lbl} style={{background:cardBg,borderRadius:14,padding:14,textAlign:"center",boxShadow:dark?"0 2px 10px rgba(0,0,0,0.3)":"0 2px 10px rgba(0,0,0,0.07)"}}>
                  <div style={{fontSize:20}}>{icon}</div>
                  <div style={{fontSize:20,fontWeight:700,fontFamily:"Lora,serif",color}}>{val}</div>
                  <div style={{fontSize:11,color:mutedC}}>{lbl}</div>
                </div>
              ))}
            </div>
            {diff!==null&&(
              <div style={{background:cardBg,borderRadius:14,padding:14,marginBottom:14,boxShadow:dark?"0 2px 10px rgba(0,0,0,0.3)":"0 2px 10px rgba(0,0,0,0.07)"}}>
                <div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}>
                  <div>
                    <div style={{fontWeight:700,color:diff>=INTERVALLO?"#dc2626":diff>=INTERVALLO-2?"#d97706":"#16a34a",fontSize:13}}>
                      {diff>=INTERVALLO?"âš ï¸ Monitoraggio in ritardo di "+(diff-INTERVALLO)+" giorni":diff>=INTERVALLO-2?"ğŸ”” Monitoraggio tra "+(INTERVALLO-diff)+" giorni":"âœ… Prossimo monitoraggio tra "+(INTERVALLO-diff)+" giorni"}
                    </div>
                    <div style={{fontSize:11,color:mutedC,marginTop:2}}>Ultimo: {lr.data} Â· Cadenza: {INTERVALLO} giorni</div>
                  </div>
                  <div style={{fontSize:28,fontWeight:700,fontFamily:"Lora,serif",color:diff>=INTERVALLO?"#dc2626":diff>=INTERVALLO-2?"#d97706":"#16a34a"}}>{diff}gg</div>
                </div>
              </div>
            )}
            <DualChart oId={oliveto.id} rils={rils} sters={sters} dark={dark}/>
          </div>
        )}

        {tab==="trappole"&&(
          <div>
            <div style={{display:"flex",gap:8,marginBottom:12}}>
              <button onClick={()=>nav("add-rilevamento",{oId:oliveto.id})} style={{flex:1,padding:12,background:"#16a34a",color:"white",border:"none",borderRadius:12,fontSize:13,fontWeight:700,cursor:"pointer"}}>+ Monitoraggio</button>
              <button onClick={()=>nav("gestione-trappole",{oId:oliveto.id})} style={{padding:"10px 14px",background:dark?"#1e3a1e":"#f0fdf4",color:"#16a34a",border:"none",borderRadius:12,fontSize:13,fontWeight:600,cursor:"pointer"}}>ğŸª¤ Trappole</button>
            </div>
            {myRil.length===0&&<p style={{textAlign:"center",color:mutedC,padding:20}}>Nessun monitoraggio</p>}
            {myRil.map(r=>{
              const rv=rischio(r.mosche);
              return(
                <div key={r.id} style={{background:cardBg,borderRadius:14,padding:14,marginBottom:10,boxShadow:dark?"0 2px 8px rgba(0,0,0,0.3)":"0 2px 8px rgba(0,0,0,0.06)"}}>
                  <div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}>
                    <div>
                      <div style={{fontWeight:700,fontSize:15}}>{r.data}</div>
                      <div style={{fontSize:13,color:mutedC}}>ğŸª¤ {r.trappola||"â€”"} Â· {r.meteo||"â€”"} Â· {r.fase||"â€”"}</div>
                    </div>
                    <div style={{display:"flex",flexDirection:"column",alignItems:"flex-end",gap:4}}>
                      <span style={{fontSize:20,fontWeight:700,color:rv.c}}>{r.mosche}</span>
                      <span className="tag" style={{background:rv.bg,color:rv.c,border:"1px solid "+rv.border}}>{rv.l}</span>
                    </div>
                  </div>
                  {r._offline&&<div style={{fontSize:11,color:"#d97706",marginTop:6}}>â³ In attesa di sincronizzazione</div>}
                  {!r._offline&&<button onClick={()=>onDeleteRil(r.id)} style={{marginTop:8,background:"none",border:"none",color:"#dc2626",cursor:"pointer",fontSize:12}}>ğŸ—‘ Elimina</button>}
                </div>
              );
            })}
          </div>
        )}

        {tab==="stereo"&&(
          <div>
            <button onClick={()=>nav("add-stereoscopio",{oId:oliveto.id})} style={{width:"100%",padding:12,background:"#7c3aed",color:"white",border:"none",borderRadius:12,fontSize:13,fontWeight:700,cursor:"pointer",marginBottom:12}}>+ Campionamento</button>
            {mySter.length===0&&<p style={{textAlign:"center",color:mutedC,padding:20}}>Nessun campionamento</p>}
            {mySter.map(s=>{
              const inf=calcInf(s);
              return(
                <div key={s.id} style={{background:cardBg,borderRadius:14,padding:14,marginBottom:10,boxShadow:dark?"0 2px 8px rgba(0,0,0,0.3)":"0 2px 8px rgba(0,0,0,0.06)"}}>
                  <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8}}>
                    <div style={{fontWeight:700,fontSize:15}}>{s.data}</div>
                    <div style={{textAlign:"right"}}>
                      <div style={{fontSize:16,fontWeight:700,color:inf.att>=IA?"#d97706":"#16a34a"}}>{inf.att.toFixed(1)}% att</div>
                      <div style={{fontSize:12,color:mutedC}}>{inf.tot.toFixed(1)}% tot</div>
                    </div>
                  </div>
                  <InfBar label="Attiva" value={inf.att} color={cInf(inf.att)}/>
                  <div style={{fontSize:12,color:mutedC,marginTop:6}}>ğŸ«’ {s.camp} olive Â· Uova {s.uova} Â· L1 {s.l1} Â· L2 {s.l2} Â· L3 {s.l3} Â· Pupe {s.pupe} Â· Fori {s.fori}</div>
                  {!s._offline&&<button onClick={()=>onDeleteSter(s.id)} style={{marginTop:6,background:"none",border:"none",color:"#dc2626",cursor:"pointer",fontSize:12}}>ğŸ—‘ Elimina</button>}
                </div>
              );
            })}
          </div>
        )}

        {tab==="trattamenti"&&(
          <div>
            <button onClick={()=>nav("add-trattamento",{oId:oliveto.id})} style={{width:"100%",padding:12,background:"#059669",color:"white",border:"none",borderRadius:12,fontSize:13,fontWeight:700,cursor:"pointer",marginBottom:12}}>+ Trattamento</button>
            {myTrat.length===0&&<p style={{textAlign:"center",color:mutedC,padding:20}}>Nessun trattamento</p>}
            {myTrat.map(t=>(
              <div key={t.id} style={{background:cardBg,borderRadius:14,padding:14,marginBottom:10,boxShadow:dark?"0 2px 8px rgba(0,0,0,0.3)":"0 2px 8px rgba(0,0,0,0.06)"}}>
                <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start"}}>
                  <div>
                    <div style={{fontWeight:700,fontSize:15}}>{t.data}</div>
                    <div style={{fontSize:13,marginTop:2}}>ğŸ’Š {t.prodotto}</div>
                    {t.dose&&<div style={{fontSize:12,color:mutedC}}>Dose: {t.dose}</div>}
                    {t.note&&<div style={{fontSize:12,color:mutedC}}>{t.note}</div>}
                  </div>
                  <button onClick={()=>onDeleteTrat(t.id)} style={{background:"none",border:"none",color:"#dc2626",cursor:"pointer",fontSize:12}}>ğŸ—‘</button>
                </div>
              </div>
            ))}
          </div>
        )}

        {tab==="potatura"&&<PotaturaOliveto oliveto={oliveto} dark={dark} cardBg={cardBg} mutedC={mutedC}/>}
        {tab==="note"&&<NoteOliveto oliveto={oliveto} dark={dark} cardBg={cardBg} mutedC={mutedC}/>}
        {tab==="foto"&&<FotoOliveto oliveto={oliveto} dark={dark} cardBg={cardBg} mutedC={mutedC}/>}
        {tab==="calendario"&&<Calendario rils={myRil} sters={mySter} trats={myTrat} oliveti={[oliveto]} dark={dark}/>}
      </div>
    </div>
  );
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// POTATURA OLIVETO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function PotaturaOliveto({oliveto,dark,cardBg,mutedC}){
  const [preventivo,setPreventivo]=useState(null);
  const [sessioni,setSessioni]=useState([]);
  const [loading,setLoading]=useState(true);
  const [editPreventivo,setEditPreventivo]=useState(false);
  const [showAddSessione,setShowAddSessione]=useState(false);
  const [fp,setFp]=useState({anno:new Date().getFullYear(),piante:"",prezzo_pianta:"",ore_stimate:"",note:""});
  const [fs,setFs]=useState({data:new Date().toISOString().slice(0,10),ore:"",operai:"1",note:""});
  const [saving,setSaving]=useState(false);

  useEffect(()=>{ load(); },[oliveto.id]);

  async function load(){
    setLoading(true);
    const[{data:prev},{data:sess}]=await Promise.all([
      sb.from("potatura_preventivi").select("*").eq("oliveto_id",oliveto.id).order("anno",{ascending:false}).limit(1),
      sb.from("potatura_sessioni").select("*").eq("oliveto_id",oliveto.id).order("data",{ascending:false})
    ]);
    if(prev&&prev.length>0){setPreventivo(prev[0]);setFp({anno:prev[0].anno,piante:prev[0].piante||"",prezzo_pianta:prev[0].prezzo_pianta||"",ore_stimate:prev[0].ore_stimate||"",note:prev[0].note||""});}
    setSessioni(sess||[]);
    setLoading(false);
  }

  async function salvaPreventivo(){
    if(!fp.piante||!fp.prezzo_pianta){alert("Inserisci nÂ° piante e prezzo a pianta");return;}
    setSaving(true);
    const payload={oliveto_id:oliveto.id,anno:+fp.anno,piante:+fp.piante,prezzo_pianta:+fp.prezzo_pianta,ore_stimate:+fp.ore_stimate||null,note:fp.note||null};
    if(preventivo){
      const{data}=await sb.from("potatura_preventivi").update(payload).eq("id",preventivo.id).select().single();
      if(data) setPreventivo(data);
    } else {
      const{data}=await sb.from("potatura_preventivi").insert(payload).select().single();
      if(data) setPreventivo(data);
    }
    setEditPreventivo(false);
    setSaving(false);
  }

  async function salvaSessione(){
    if(!fs.ore){alert("Inserisci le ore lavorate");return;}
    setSaving(true);
    const payload={oliveto_id:oliveto.id,data:fs.data,ore:+fs.ore,operai:+fs.operai||1,note:fs.note||null};
    const{data,error}=await sb.from("potatura_sessioni").insert(payload).select().single();
    if(error){alert("Errore: "+error.message);}
    else if(data) setSessioni(p=>[data,...p]);
    setFs({data:new Date().toISOString().slice(0,10),ore:"",operai:"1",note:""});
    setShowAddSessione(false);
    setSaving(false);
  }

  async function deleteSessione(id){
    if(!confirm("Eliminare questa sessione?")) return;
    await sb.from("potatura_sessioni").delete().eq("id",id);
    setSessioni(p=>p.filter(s=>s.id!==id));
  }

  const oreTotali=sessioni.reduce((a,s)=>a+(+s.ore||0),0);
  const totalePreventivo=preventivo?(preventivo.piante*preventivo.prezzo_pianta):0;
  const oreStimate=preventivo?.ore_stimate||0;
  const pctOre=oreStimate>0?Math.min((oreTotali/oreStimate)*100,120):0;
  const inp={width:"100%",padding:"10px 14px",border:`1.5px solid ${dark?"#334155":"#d1fae5"}`,borderRadius:10,fontSize:14,outline:"none",boxSizing:"border-box",background:dark?"#1e293b":"white",color:dark?"#e2e8f0":"#1a1a2e",marginBottom:12};

  function inviaWhatsAppPreventivo(){
    const testo="ğŸŒ¿ Preventivo Potatura "+preventivo.anno+"\n\nOliveto: "+oliveto.nome+" ("+(oliveto.comune||"")+")\n\nPiante da potare: "+preventivo.piante+"\nPrezzo a pianta: â‚¬"+preventivo.prezzo_pianta+"\nğŸ’° Totale: â‚¬"+totalePreventivo.toFixed(2)+(preventivo.ore_stimate?"\nOre stimate: "+preventivo.ore_stimate+" h":"")+(preventivo.note?"\n"+preventivo.note:"")+"\n\nA presto!";
    window.__waPreventivo&&window.__waPreventivo(testo);
  }

  function stampaPDFPreventivo(){
    const now=new Date().toLocaleDateString("it-IT");
    const css=".row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #e5e7eb}body{font-family:Georgia,serif;max-width:700px;margin:0 auto;padding:30px;color:#1a1a2e}.footer{margin-top:40px;font-size:11px;color:#9ca3af;border-top:1px solid #e5e7eb;padding-top:8px}";
    let html="<!DOCTYPE html><html><head><meta charset='utf-8'><title>Preventivo Potatura</title><style>"+css+"</style></head><body>";
    html+="<div style='display:flex;align-items:center;gap:12px;margin-bottom:20px'><span style='font-size:40px'>ğŸŒ¿</span>";
    html+="<div><h1 style='margin:0;color:#166534;font-size:22px'>Preventivo Potatura "+preventivo.anno+"</h1>";
    html+="<p style='margin:0;color:#6b7280;font-size:13px'>Emesso il "+now+"</p></div></div>";
    html+="<h2 style='color:#374151;font-size:16px'>ğŸ«’ "+oliveto.nome+"</h2>";
    html+="<p style='color:#6b7280;font-size:13px'>"+(oliveto.comune||"")+" Â· "+(oliveto.varieta||"")+"</p>";
    html+="<div style='margin-top:20px'>";
    html+="<div class='row'><span>NÂ° piante</span><strong>"+preventivo.piante+"</strong></div>";
    html+="<div class='row'><span>Prezzo a pianta</span><strong>â‚¬ "+preventivo.prezzo_pianta+"</strong></div>";
    if(preventivo.ore_stimate) html+="<div class='row'><span>Ore stimate</span><strong>"+preventivo.ore_stimate+" h</strong></div>";
    if(preventivo.note) html+="<div class='row'><span>Note</span><span>"+preventivo.note+"</span></div>";
    html+="</div><div style='font-size:22px;font-weight:bold;color:#166534;margin-top:16px;padding:12px;background:#f0fdf4;border-radius:8px;text-align:center'>Totale: â‚¬ "+totalePreventivo.toFixed(2)+"</div>";
    html+="<div class='footer'>OliveTrack â€” Gestione oliveti</div></body></html>";
    const w=window.open("","_blank");w.document.write(html);w.document.close();setTimeout(()=>w.print(),400);
  }

  if(loading) return <p style={{textAlign:"center",color:mutedC,padding:20}}>Caricamento...</p>;

  return(
    <div>
      <div style={{background:cardBg,borderRadius:16,padding:16,marginBottom:14,boxShadow:dark?"0 2px 10px rgba(0,0,0,0.3)":"0 2px 10px rgba(0,0,0,0.07)"}}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:12}}>
          <h4 style={{fontFamily:"Lora,serif",fontSize:15,margin:0}}>ğŸ’° Preventivo</h4>
          <button onClick={()=>setEditPreventivo(v=>!v)}
            style={{background:dark?"#1e3a1e":"#f0fdf4",color:"#16a34a",border:"none",borderRadius:8,padding:"5px 12px",fontSize:12,fontWeight:700,cursor:"pointer"}}>
            {editPreventivo?"Annulla":"âœï¸ "+(preventivo?"Modifica":"Nuovo")}
          </button>
        </div>
        {editPreventivo?(
          <div>
            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10,marginBottom:4}}>
              {[["Anno","anno","number"],["NÂ° piante","piante","number"],["â‚¬ / pianta","prezzo_pianta","number"],["Ore stimate","ore_stimate","number"]].map(([lbl,k,type])=>(
                <div key={k}>
                  <label style={{display:"block",fontSize:12,fontWeight:600,color:mutedC,marginBottom:4}}>{lbl}</label>
                  <input type={type} value={fp[k]} onChange={e=>setFp(p=>({...p,[k]:e.target.value}))} style={{...inp,marginBottom:0}}/>
                </div>
              ))}
            </div>
            <label style={{display:"block",fontSize:12,fontWeight:600,color:mutedC,marginBottom:4,marginTop:8}}>Note</label>
            <textarea value={fp.note} onChange={e=>setFp(p=>({...p,note:e.target.value}))} rows={2} placeholder="Note aggiuntive..."
              style={{...inp,resize:"vertical",fontFamily:"inherit"}}/>
            <button onClick={salvaPreventivo} disabled={saving}
              style={{width:"100%",padding:12,background:"#16a34a",color:"white",border:"none",borderRadius:12,fontSize:14,fontWeight:700,cursor:"pointer"}}>
              {saving?<span className="spinner"/>:"ğŸ’¾ Salva preventivo"}
            </button>
          </div>
        ):preventivo?(
          <div>
            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10,marginBottom:12}}>
              {[[preventivo.piante,"ğŸ«’","Piante"],["â‚¬"+preventivo.prezzo_pianta,"ğŸ’¶","â‚¬/pianta"],["â‚¬"+totalePreventivo.toFixed(0),"ğŸ’°","Totale"],[preventivo.ore_stimate?preventivo.ore_stimate+" h":"â€”","â±ï¸","Ore stimate"]].map(([val,icon,lbl])=>(
                <div key={lbl} style={{background:dark?"#273549":"#f9fafb",borderRadius:12,padding:12,textAlign:"center"}}>
                  <div style={{fontSize:16}}>{icon}</div>
                  <div style={{fontSize:18,fontWeight:700,fontFamily:"Lora,serif",color:lbl==="Totale"?"#16a34a":dark?"#e2e8f0":"#1a1a2e"}}>{val}</div>
                  <div style={{fontSize:11,color:mutedC}}>{lbl}</div>
                </div>
              ))}
            </div>
            {preventivo.note&&<p style={{fontSize:13,color:mutedC,margin:"0 0 12px",fontStyle:"italic"}}>ğŸ“ {preventivo.note}</p>}
            <div style={{display:"flex",gap:8}}>
              <button onClick={stampaPDFPreventivo} style={{flex:1,padding:10,background:"#dc2626",color:"white",border:"none",borderRadius:10,fontSize:12,fontWeight:700,cursor:"pointer"}}>ğŸ“„ PDF</button>
              <button onClick={inviaWhatsAppPreventivo} style={{flex:1,padding:10,background:"#25d366",color:"white",border:"none",borderRadius:10,fontSize:12,fontWeight:700,cursor:"pointer"}}>ğŸ’¬ WhatsApp</button>
            </div>
          </div>
        ):(
          <p style={{textAlign:"center",color:mutedC,padding:8,fontSize:13}}>Nessun preventivo ancora. Premi "Nuovo" per crearne uno.</p>
        )}
      </div>
      <div style={{background:cardBg,borderRadius:16,padding:16,boxShadow:dark?"0 2px 10px rgba(0,0,0,0.3)":"0 2px 10px rgba(0,0,0,0.07)"}}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:12}}>
          <h4 style={{fontFamily:"Lora,serif",fontSize:15,margin:0}}>â±ï¸ Ore lavorate</h4>
          {oreStimate>0&&<span style={{fontSize:12,fontWeight:700,color:pctOre>100?"#dc2626":pctOre>80?"#d97706":"#16a34a"}}>{oreTotali}h / {oreStimate}h ({pctOre.toFixed(0)}%)</span>}
        </div>
        {oreStimate>0&&(
          <div style={{background:dark?"#334155":"#e5e7eb",borderRadius:8,height:8,marginBottom:14,overflow:"hidden"}}>
            <div style={{height:"100%",borderRadius:8,width:`${Math.min(pctOre,100)}%`,background:pctOre>100?"#dc2626":pctOre>80?"#d97706":"#16a34a",transition:"width 0.4s"}}/>
          </div>
        )}
        {sessioni.length>0&&(
          <div style={{display:"flex",gap:10,marginBottom:14}}>
            {[[oreTotali+" h","â±ï¸","Tot. ore"],[sessioni.length,"ğŸ“…","Sessioni"],[sessioni.reduce((a,s)=>Math.max(a,+s.operai||1),0),"ğŸ‘·","Max operai"]].map(([val,icon,lbl])=>(
              <div key={lbl} style={{flex:1,background:dark?"#273549":"#f9fafb",borderRadius:10,padding:"8px 4px",textAlign:"center"}}>
                <div style={{fontSize:13}}>{icon}</div>
                <div style={{fontSize:16,fontWeight:700,fontFamily:"Lora,serif"}}>{val}</div>
                <div style={{fontSize:10,color:mutedC}}>{lbl}</div>
              </div>
            ))}
          </div>
        )}
        {showAddSessione?(
          <div style={{background:dark?"#273549":"#f9fafb",borderRadius:12,padding:14,marginBottom:12}}>
            <h5 style={{margin:"0 0 12px",fontSize:13,color:mutedC}}>Nuova sessione</h5>
            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:8,marginBottom:4}}>
              {[["Data","data","date"],["Ore","ore","number"],["Operai","operai","number"]].map(([lbl,k,type])=>(
                <div key={k}>
                  <label style={{display:"block",fontSize:11,fontWeight:600,color:mutedC,marginBottom:3}}>{lbl}</label>
                  <input type={type} min="0" step={k==="ore"?"0.5":"1"} value={fs[k]} onChange={e=>setFs(p=>({...p,[k]:e.target.value}))} style={{...inp,marginBottom:0,textAlign:"center"}}/>
                </div>
              ))}
            </div>
            <label style={{display:"block",fontSize:11,fontWeight:600,color:mutedC,marginBottom:3,marginTop:8}}>Note</label>
            <input value={fs.note} onChange={e=>setFs(p=>({...p,note:e.target.value}))} placeholder="Note sessione..." style={{...inp}}/>
            <div style={{display:"flex",gap:8}}>
              <button onClick={salvaSessione} disabled={saving} style={{flex:1,padding:10,background:"#16a34a",color:"white",border:"none",borderRadius:10,fontSize:13,fontWeight:700,cursor:"pointer"}}>{saving?<span className="spinner"/>:"ğŸ’¾ Salva"}</button>
              <button onClick={()=>setShowAddSessione(false)} style={{flex:1,padding:10,background:dark?"#334155":"#f3f4f6",color:dark?"#e2e8f0":"#374151",border:"none",borderRadius:10,fontSize:13,cursor:"pointer"}}>Annulla</button>
            </div>
          </div>
        ):(
          <button onClick={()=>setShowAddSessione(true)} style={{width:"100%",padding:12,background:dark?"#1e3a1e":"#f0fdf4",color:"#16a34a",border:"2px dashed #86efac",borderRadius:12,fontSize:14,fontWeight:600,cursor:"pointer",marginBottom:sessioni.length>0?12:0}}>
            + Aggiungi sessione di lavoro
          </button>
        )}
        {sessioni.length===0&&!showAddSessione&&<p style={{textAlign:"center",color:mutedC,fontSize:13,padding:8}}>Nessuna sessione registrata</p>}
        {sessioni.map(s=>(
          <div key={s.id} style={{display:"flex",alignItems:"center",gap:12,padding:"10px 0",borderTop:`1px solid ${dark?"#334155":"#f3f4f6"}`}}>
            <div style={{flex:1}}>
              <div style={{fontWeight:700,fontSize:14}}>{s.data}</div>
              <div style={{fontSize:12,color:mutedC}}>ğŸ‘· {s.operai||1} operai Â· â±ï¸ {s.ore} h{s.operai>1?" ("+(s.ore*(s.operai||1)).toFixed(1)+" h/uomo)":""}</div>
              {s.note&&<div style={{fontSize:12,color:mutedC,fontStyle:"italic"}}>{s.note}</div>}
            </div>
            <button onClick={()=>deleteSessione(s.id)} style={{background:"rgba(220,38,38,0.1)",color:"#dc2626",border:"none",borderRadius:8,padding:"5px 8px",cursor:"pointer",fontSize:13}}>ğŸ—‘</button>
          </div>
        ))}
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FOTO OLIVETO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function FotoOliveto({oliveto,dark,cardBg,mutedC}){
  const [foto,setFoto]=useState([]);
  const [loading,setLoading]=useState(true);
  const [uploading,setUploading]=useState(false);
  const [preview,setPreview]=useState(null);
  const inputRef=React.useRef(null);

  useEffect(()=>{ loadFoto(); },[oliveto.id]);

  async function loadFoto(){
    setLoading(true);
    const{data}=await sb.from("foto_oliveto").select("*").eq("oliveto_id",oliveto.id).order("created_at",{ascending:false});
    setFoto(data||[]);
    setLoading(false);
  }

  async function upload(e){
    const file=e.target.files[0];
    if(!file) return;
    if(file.size>5*1024*1024){alert("File troppo grande (max 5MB)");return;}
    setUploading(true);
    const ext=file.name.split(".").pop();
    const path=oliveto.id+"/"+Date.now()+"."+ext;
    const{error:upErr}=await sb.storage.from("olive-foto").upload(path,file,{contentType:file.type});
    if(upErr){alert("Errore upload: "+upErr.message);setUploading(false);return;}
    const{data:{publicUrl}}=sb.storage.from("olive-foto").getPublicUrl(path);
    const{data,error}=await sb.from("foto_oliveto").insert({oliveto_id:oliveto.id,url:publicUrl,path,nome:file.name,data:new Date().toISOString().slice(0,10)}).select().single();
    if(error){alert("Errore salvataggio: "+error.message);}
    else if(data) setFoto(p=>[data,...p]);
    setUploading(false);
    e.target.value="";
  }

  async function deleteFoto(f){
    if(!confirm("Eliminare questa foto?")) return;
    await sb.storage.from("olive-foto").remove([f.path]);
    await sb.from("foto_oliveto").delete().eq("id",f.id);
    setFoto(p=>p.filter(x=>x.id!==f.id));
  }

  return(
    <div>
      <input ref={inputRef} type="file" accept="image/*" capture="environment" onChange={upload} style={{display:"none"}}/>
      <div style={{display:"flex",gap:10,marginBottom:16}}>
        <button onClick={()=>inputRef.current.click()} disabled={uploading}
          style={{flex:1,padding:12,background:"#16a34a",color:"white",border:"none",borderRadius:12,fontSize:13,fontWeight:700,cursor:"pointer"}}>
          {uploading?<span className="spinner"/>:"ğŸ“· Scatta / Carica foto"}
        </button>
      </div>
      {loading?<p style={{textAlign:"center",color:mutedC}}>Caricamento...</p>:
        foto.length===0?<p style={{textAlign:"center",color:mutedC,padding:20}}>Nessuna foto ancora</p>:
        <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10}}>
          {foto.map(f=>(
            <div key={f.id} style={{position:"relative",borderRadius:12,overflow:"hidden",aspectRatio:"1",background:dark?"#273549":"#f3f4f6"}}>
              <img src={f.url} alt={f.nome} style={{width:"100%",height:"100%",objectFit:"cover",cursor:"pointer"}} onClick={()=>setPreview(f.url)}/>
              <div style={{position:"absolute",bottom:0,left:0,right:0,background:"rgba(0,0,0,0.55)",padding:"4px 8px",display:"flex",justifyContent:"space-between",alignItems:"center"}}>
                <span style={{color:"white",fontSize:10}}>{f.data}</span>
                <button onClick={()=>deleteFoto(f)} style={{background:"none",border:"none",color:"#fca5a5",cursor:"pointer",fontSize:14,padding:0}}>ğŸ—‘</button>
              </div>
            </div>
          ))}
        </div>
      }
      {preview&&createPortal(
        <div onClick={()=>setPreview(null)} style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.9)",zIndex:3000,display:"flex",alignItems:"center",justifyContent:"center",padding:16}}>
          <img src={preview} style={{maxWidth:"100%",maxHeight:"90vh",borderRadius:12,objectFit:"contain"}}/>
          <button onClick={()=>setPreview(null)} style={{position:"absolute",top:20,right:20,background:"rgba(255,255,255,0.2)",border:"none",color:"white",width:36,height:36,borderRadius:18,fontSize:20,cursor:"pointer"}}>Ã—</button>
        </div>, document.body
      )}
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NOTE OLIVETO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function NoteOliveto({oliveto,dark,cardBg,mutedC}){
  const [note,setNote]=useState([]);
  const [loading,setLoading]=useState(true);
  const [showForm,setShowForm]=useState(false);
  const [f,setF]=useState({data:new Date().toISOString().slice(0,10),testo:""});
  const [saving,setSaving]=useState(false);

  useEffect(()=>{ load(); },[oliveto.id]);

  async function load(){
    setLoading(true);
    const{data}=await sb.from("note_oliveto").select("*").eq("oliveto_id",oliveto.id).order("data",{ascending:false});
    setNote(data||[]);
    setLoading(false);
  }

  async function save(){
    if(!f.testo.trim()){alert("Inserisci il testo della nota");return;}
    setSaving(true);
    const{data,error}=await sb.from("note_oliveto").insert({oliveto_id:oliveto.id,data:f.data,testo:f.testo.trim()}).select().single();
    if(error){alert("Errore: "+error.message);setSaving(false);return;}
    setNote(p=>[data,...p]);
    setF({data:new Date().toISOString().slice(0,10),testo:""});
    setShowForm(false);
    setSaving(false);
  }

  async function remove(id){
    if(!confirm("Eliminare questa nota?")) return;
    await sb.from("note_oliveto").delete().eq("id",id);
    setNote(p=>p.filter(n=>n.id!==id));
  }

  const inp={width:"100%",padding:"10px 14px",border:`1.5px solid ${dark?"#334155":"#d1fae5"}`,borderRadius:10,fontSize:14,outline:"none",boxSizing:"border-box",background:dark?"#1e293b":"white",color:dark?"#e2e8f0":"#1a1a2e",marginBottom:12};

  return(
    <div>
      {loading?<p style={{textAlign:"center",color:mutedC,padding:20}}>Caricamento...</p>:<>
        {showForm?(
          <div style={{background:cardBg,borderRadius:16,padding:16,marginBottom:14,boxShadow:dark?"0 2px 10px rgba(0,0,0,0.3)":"0 2px 10px rgba(0,0,0,0.07)"}}>
            <h4 style={{fontFamily:"Lora,serif",fontSize:15,margin:"0 0 14px"}}>ğŸ“ Nuova nota</h4>
            <label style={{display:"block",fontSize:13,fontWeight:600,color:mutedC,marginBottom:6}}>Data</label>
            <input type="date" value={f.data} onChange={e=>setF(p=>({...p,data:e.target.value}))} style={inp}/>
            <label style={{display:"block",fontSize:13,fontWeight:600,color:mutedC,marginBottom:6}}>Nota *</label>
            <textarea value={f.testo} onChange={e=>setF(p=>({...p,testo:e.target.value}))} placeholder="Scrivi una nota..." rows={4}
              style={{...inp,resize:"vertical",fontFamily:"inherit",lineHeight:1.5}}/>
            <div style={{display:"flex",gap:10}}>
              <button onClick={save} disabled={saving} className="btn-primary" style={{background:"#16a34a",marginBottom:0}}>{saving?<span className="spinner"/>:"ğŸ’¾ Salva"}</button>
              <button onClick={()=>setShowForm(false)} className="btn-primary" style={{background:dark?"#334155":"#f3f4f6",color:dark?"#e2e8f0":"#374151",marginBottom:0}}>Annulla</button>
            </div>
          </div>
        ):(
          <button onClick={()=>setShowForm(true)} style={{width:"100%",padding:14,background:dark?"#1a2e1a":"#f0fdf4",color:"#16a34a",border:"2px dashed #86efac",borderRadius:14,fontSize:15,fontWeight:600,cursor:"pointer",marginBottom:14}}>
            + Aggiungi nota
          </button>
        )}
        {note.length===0&&!showForm&&<p style={{textAlign:"center",color:mutedC,padding:20}}>Nessuna nota ancora</p>}
        {note.map(n=>(
          <div key={n.id} style={{background:cardBg,borderRadius:14,padding:16,marginBottom:10,boxShadow:dark?"0 2px 10px rgba(0,0,0,0.3)":"0 2px 10px rgba(0,0,0,0.07)"}}>
            <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:8}}>
              <span style={{fontSize:12,fontWeight:700,color:dark?"#4ade80":"#16a34a"}}>{n.data}</span>
              <button onClick={()=>remove(n.id)} style={{background:"none",border:"none",color:"#dc2626",cursor:"pointer",fontSize:16,padding:0}}>ğŸ—‘</button>
            </div>
            <p style={{margin:0,fontSize:14,lineHeight:1.6,color:dark?"#e2e8f0":"#1a1a2e",whiteSpace:"pre-wrap"}}>{n.testo}</p>
          </div>
        ))}
      </>}
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// POTATURA CLIENTE (riepilogo multi-oliveto)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function PotaturaCliente({cliente,oliveti,preventivi,dark,cardBg,mutedC,nav}){
  const totPiante=preventivi.reduce((a,p)=>a+(+p.piante||0),0);
  const totImporto=preventivi.reduce((a,p)=>a+((+p.piante||0)*(+p.prezzo_pianta||0)),0);
  const totOreStimate=preventivi.reduce((a,p)=>a+(+p.ore_stimate||0),0);
  const [sessioni,setSessioni]=useState([]);
  const anno=new Date().getFullYear();

  useEffect(()=>{
    if(!oliveti.length) return;
    sb.from("potatura_sessioni").select("*").in("oliveto_id",oliveti.map(o=>o.id))
      .then(({data})=>setSessioni(data||[]));
  },[cliente.id]);

  const totOreReali=sessioni.reduce((a,s)=>a+(+s.ore||0),0);

  function stampaPDFCliente(){
    const now=new Date().toLocaleDateString("it-IT");
    let righe="";
    oliveti.forEach(o=>{
      const p=preventivi.find(x=>x.oliveto_id===o.id);
      if(!p) return;
      const tot=(+p.piante||0)*(+p.prezzo_pianta||0);
      righe+="<tr><td>"+o.nome+"</td><td>"+(o.comune||"")+"</td><td>"+p.piante+"</td><td>â‚¬"+p.prezzo_pianta+"</td><td>"+(p.ore_stimate||"â€”")+"</td><td><strong>â‚¬"+tot.toFixed(2)+"</strong></td></tr>";
    });
    const css="body{font-family:Georgia,serif;max-width:780px;margin:0 auto;padding:30px;color:#1a1a2e}h1{color:#166534;border-bottom:2px solid #166534;padding-bottom:8px}table{width:100%;border-collapse:collapse;margin-top:16px;font-size:13px}th{background:#166534;color:white;padding:8px 10px;text-align:left}td{padding:7px 10px;border-bottom:1px solid #e5e7eb}tr:nth-child(even){background:#f9fafb}.footer{margin-top:40px;font-size:11px;color:#9ca3af;border-top:1px solid #e5e7eb;padding-top:8px}";
    let html="<!DOCTYPE html><html><head><meta charset='utf-8'><title>Preventivo Potatura</title><style>"+css+"</style></head><body>";
    html+="<div style='display:flex;align-items:center;gap:14px;margin-bottom:24px'><span style='font-size:44px'>ğŸŒ¿</span>";
    html+="<div><h1 style='margin:0;border:none;font-size:26px'>Preventivo Potatura "+anno+"</h1>";
    html+="<p style='margin:4px 0 0;color:#6b7280;font-size:13px'>Cliente: <strong>"+cliente.nome+"</strong> Â· Emesso il "+now+"</p></div></div>";
    html+="<table><tr><th>Oliveto</th><th>Comune</th><th>Piante</th><th>â‚¬/pianta</th><th>Ore stimate</th><th>Totale</th></tr>";
    html+=righe;
    html+="<tr style='background:#f0fdf4'><td colspan='2'><strong>TOTALE</strong></td><td><strong>"+totPiante+"</strong></td><td>â€”</td><td><strong>"+(totOreStimate||"â€”")+"</strong></td><td><strong style='color:#166534;font-size:15px'>â‚¬"+totImporto.toFixed(2)+"</strong></td></tr></table>";
    html+="<div class='footer'>OliveTrack â€” Gestione oliveti</div></body></html>";
    const w=window.open("","_blank");w.document.write(html);w.document.close();setTimeout(()=>w.print(),400);
  }

  function inviaWhatsApp(){
    if(!cliente.telefono){alert("Nessun numero di telefono per questo cliente");return;}
    let righe="";
    oliveti.forEach(o=>{
      const p=preventivi.find(x=>x.oliveto_id===o.id);
      if(!p) return;
      const tot=(+p.piante||0)*(+p.prezzo_pianta||0);
      righe+="\nğŸ«’ "+o.nome+": "+p.piante+" piante Ã— â‚¬"+p.prezzo_pianta+" = â‚¬"+tot.toFixed(2);
    });
    const testo="ğŸŒ¿ Preventivo Potatura "+anno+"\nCliente: "+cliente.nome+righe+"\n\nğŸ’° Totale: â‚¬"+totImporto.toFixed(2)+(totOreStimate?"\nâ±ï¸ Ore stimate: "+totOreStimate+" h":"")+"\n\nA presto!";
    apriWhatsApp(cliente.telefono,testo);
  }

  if(!preventivi.length&&!oliveti.length){
    return <p style={{textAlign:"center",color:mutedC,padding:24,fontSize:13}}>Nessun preventivo ancora.<br/>Vai nella scheda di ogni oliveto â†’ tab ğŸŒ¿ Potatura.</p>;
  }

  return(
    <div>
      <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10,marginBottom:14}}>
        {[[("â‚¬"+totImporto.toFixed(0)),"ğŸ’°","Totale preventivo","#16a34a"],[totPiante,"ğŸ«’","Piante totali",null],[(totOreStimate||"â€”"),"â±ï¸","Ore stimate",null],[(totOreReali||"â€”"),"âœ…","Ore reali",null]].map(([val,icon,lbl,color])=>(
          <div key={lbl} style={{background:cardBg,borderRadius:14,padding:14,textAlign:"center",boxShadow:dark?"0 2px 8px rgba(0,0,0,0.3)":"0 2px 8px rgba(0,0,0,0.06)"}}>
            <div style={{fontSize:22}}>{icon}</div>
            <div style={{fontSize:20,fontWeight:700,fontFamily:"Lora,serif",color:color||(dark?"#e2e8f0":"#1a1a2e")}}>{val}</div>
            <div style={{fontSize:11,color:mutedC}}>{lbl}</div>
          </div>
        ))}
      </div>
      {oliveti.map(o=>{
        const p=preventivi.find(x=>x.oliveto_id===o.id);
        const sess=sessioni.filter(s=>s.oliveto_id===o.id);
        const oreReali=sess.reduce((a,s)=>a+(+s.ore||0),0);
        const tot=p?(+p.piante||0)*(+p.prezzo_pianta||0):0;
        return(
          <div key={o.id} onClick={()=>nav("oliveto-detail",o)}
            style={{background:cardBg,borderRadius:14,padding:14,marginBottom:10,cursor:"pointer",boxShadow:dark?"0 2px 8px rgba(0,0,0,0.3)":"0 2px 8px rgba(0,0,0,0.06)"}} className="card">
            <div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}>
              <div>
                <div style={{fontWeight:700,fontFamily:"Lora,serif",fontSize:14}}>ğŸ«’ {o.nome}</div>
                <div style={{fontSize:12,color:mutedC}}>{o.comune||""}</div>
              </div>
              <div style={{textAlign:"right"}}>
                {p?<div style={{fontSize:17,fontWeight:700,color:"#16a34a"}}>â‚¬{tot.toFixed(0)}</div>:<div style={{fontSize:12,color:mutedC}}>Nessun preventivo</div>}
                {p&&<div style={{fontSize:11,color:mutedC}}>{p.piante} piante Â· â‚¬{p.prezzo_pianta}/pianta</div>}
                {oreReali>0&&<div style={{fontSize:11,color:"#16a34a"}}>âœ… {oreReali}h lavorate</div>}
              </div>
            </div>
            {p&&p.ore_stimate&&oreReali>0&&(
              <div style={{marginTop:8,background:dark?"#334155":"#e5e7eb",borderRadius:6,height:6,overflow:"hidden"}}>
                <div style={{height:"100%",borderRadius:6,width:(Math.min((oreReali/p.ore_stimate)*100,100))+"%",background:oreReali>p.ore_stimate?"#dc2626":"#16a34a"}}/>
              </div>
            )}
          </div>
        );
      })}
      {preventivi.length>0&&(
        <div style={{display:"flex",gap:10,marginTop:8}}>
          <button onClick={stampaPDFCliente} style={{flex:1,padding:13,background:"#dc2626",color:"white",border:"none",borderRadius:12,fontSize:14,fontWeight:700,cursor:"pointer"}}>ğŸ“„ PDF completo</button>
          {cliente.telefono&&<button onClick={inviaWhatsApp} style={{flex:1,padding:13,background:"#25d366",color:"white",border:"none",borderRadius:12,fontSize:14,fontWeight:700,cursor:"pointer"}}>ğŸ’¬ WhatsApp</button>}
        </div>
      )}
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CLIENTE DETAIL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function ClienteDetail({cliente,oliveti,rils,sters,trats,traps,setTraps,onBack,nav,dark,onDeleteCliente,onDeleteOliveto,onDeleteRil,onDeleteSter,onDeleteTrat,onUpdateRil,onUpdateSter,onUpdateTrat}){
  const myOl=oliveti.filter(o=>o.cliente_id===cliente.id);
  const [olSort,setOlSort]=useState("nome");
  const [ctab,setCtab]=useState("oliveti");
  const [preventiviOl,setPreventiviOl]=useState([]);
  const cardBg=dark?"#1e293b":"white";
  const mutedC=dark?"#94a3b8":"#6b7280";
  const alerts=myOl.filter(o=>{const l=lastOf(rils,"oId",o.id);return l&&l.mosche>=SA;}).length;

  useEffect(()=>{
    if(!myOl.length) return;
    sb.from("potatura_preventivi").select("*").in("oliveto_id",myOl.map(o=>o.id)).then(({data})=>setPreventiviOl(data||[]));
  },[cliente.id]);

  return(
    <div>
      <div style={{background:dark?"linear-gradient(135deg,#080614,#110e2e)":"linear-gradient(135deg,#1e1b4b,#3730a3)",padding:"20px 20px 28px"}}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start"}}>
          <button onClick={onBack} style={{background:"rgba(255,255,255,0.2)",border:"none",color:"white",padding:"6px 14px",borderRadius:20,cursor:"pointer",marginBottom:14,fontSize:13}}>â† Indietro</button>
          <button onClick={()=>{if(confirm("Eliminare " + cliente.nome + "? Verranno eliminati tutti gli oliveti e dati associati."))onDeleteCliente&&onDeleteCliente(cliente.id);}}
            style={{background:"rgba(220,38,38,0.3)",border:"none",color:"white",padding:"6px 12px",borderRadius:20,cursor:"pointer",fontSize:12}}>ğŸ—‘ Elimina</button>
        </div>
        <h2 style={{color:"white",fontFamily:"Lora,serif"}}>{cliente.nome}</h2>
        <p style={{color:"#a5b4fc",margin:"4px 0 0",fontSize:13}}>
          {cliente.telefono&&<span>ğŸ“ {cliente.telefono} Â· </span>}
          {myOl.length} oliveti Â· {alerts>0&&<span style={{color:"#fca5a5"}}>âš ï¸ {alerts} alert</span>}
        </p>
      </div>
      <div style={{padding:14}}>
        <div style={{display:"flex",gap:6,marginBottom:14}}>
          {[["oliveti","ğŸ«’ Oliveti"],["potatura","ğŸŒ¿ Potatura"]].map(([id,lbl])=>(
            <button key={id} onClick={()=>setCtab(id)}
              style={{padding:"7px 14px",borderRadius:10,border:"none",cursor:"pointer",fontSize:13,fontWeight:600,
                background:ctab===id?"#16a34a":(dark?"#1e3a1e":"#f0fdf4"),
                color:ctab===id?"white":(dark?"#4ade80":"#16a34a")}}>
              {lbl}
            </button>
          ))}
        </div>
        {ctab==="potatura"&&(
          <PotaturaCliente cliente={cliente} oliveti={myOl} preventivi={preventiviOl} dark={dark} cardBg={cardBg} mutedC={mutedC} nav={nav}/>
        )}
        {ctab==="oliveti"&&(
          <div>
            <div style={{display:"flex",gap:8,marginBottom:12,alignItems:"center"}}>
              <span style={{fontSize:13,color:mutedC,fontWeight:600}}>Ordina:</span>
              {[["nome","Aâ†’Z"],["alert","âš ï¸"],["data","ğŸ“…"]].map(([v,l])=>(
                <button key={v} onClick={()=>setOlSort(v)}
                  style={{padding:"5px 10px",borderRadius:8,border:"none",cursor:"pointer",fontSize:11,fontWeight:600,
                    background:olSort===v?"#16a34a":(dark?"#1e3a1e":"#f0fdf4"),
                    color:olSort===v?"white":(dark?"#4ade80":"#16a34a")}}>
                  {l}
                </button>
              ))}
            </div>
            {[...myOl]
              .map(o=>{
                const lr=lastOf(rils,"oId",o.id);
                const ls=lastOf(sters,"oId",o.id);
                const alertM=lr&&lr.mosche>=SA?1:0;
                const alertI=ls&&calcInf(ls).att>=IA?1:0;
                return{o,lr,ls,alertM,alertI};
              })
              .sort((a,b)=>{
                if(olSort==="alert") return (b.alertM+b.alertI)-(a.alertM+a.alertI);
                if(olSort==="data") return (b.lr?.data||"").localeCompare(a.lr?.data||"");
                return a.o.nome.localeCompare(b.o.nome);
              })
              .map(({o,lr,ls,alertM,alertI})=>{
                const r=lr?rischio(lr.mosche):{l:"â€”",c:"#9ca3af",bg:"rgba(156,163,175,0.1)",border:"#9ca3af"};
                const inf=ls?calcInf(ls):null;
                return(
                  <div key={o.id} onClick={()=>nav("oliveto-detail",o)} style={{background:cardBg,borderRadius:14,padding:16,marginBottom:10,cursor:"pointer",boxShadow:dark?"0 2px 14px rgba(0,0,0,0.4)":"0 2px 14px rgba(0,0,0,0.07)"}} className="card">
                    <div style={{display:"flex",alignItems:"center",gap:12}}>
                      <div style={{fontSize:28}}>ğŸ«’</div>
                      <div style={{flex:1}}>
                        <div style={{fontWeight:700,fontFamily:"Lora,serif"}}>{o.nome}</div>
                        <div style={{fontSize:12,color:mutedC}}>{o.comune||o.loc}</div>
                        {lr&&<div style={{fontSize:12,color:mutedC}}>ğŸª¤ {lr.data}: {lr.mosche} mosche</div>}
                      </div>
                      <div style={{display:"flex",flexDirection:"column",gap:3,alignItems:"flex-end"}}>
                        <span className="tag" style={{background:r.bg,color:r.c,border:"1px solid "+r.border}}>{r.l}</span>
                        {inf&&alertI>0&&<span className="tag" style={{background:"rgba(217,119,6,0.15)",color:"#d97706",border:"1px solid #d97706"}}>ğŸ”¬ {inf.att.toFixed(0)}%</span>}
                      </div>
                    </div>
                  </div>
                );
              })}
            <button onClick={()=>nav("add-oliveto",{clienteId:cliente.id,clienteNome:cliente.nome})}
              style={{width:"100%",padding:14,background:dark?"#1e3a1e":"#f0fdf4",color:"#16a34a",border:"2px dashed #86efac",borderRadius:14,fontSize:15,fontWeight:600,cursor:"pointer",marginTop:4}}>
              + Aggiungi oliveto
            </button>
          </div>
        )}
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAPPA OLIVETI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function MappaOliveti({oliveti,rils,sters,clienti,nav,dark}){
  const mapRef=React.useRef(null);
  const leafRef=React.useRef(null);
  const mutedC=dark?"#94a3b8":"#6b7280";
  const [filtro,setFiltro]=useState("tutti");

  useEffect(()=>{
    if(!window.L) return;
    if(!leafRef.current){
      leafRef.current=window.L.map(mapRef.current,{zoomControl:true}).setView([41.9,12.5],6);
      window.L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"Â© OpenStreetMap",maxZoom:19}).addTo(leafRef.current);
    }
    const map=leafRef.current;
    map.eachLayer(l=>{ if(l._isMarker) map.removeLayer(l); });
    const olConCoord=oliveti.filter(o=>o.lat&&o.lng);
    const filtered=olConCoord.filter(o=>{
      const lr=lastOf(rils,"oId",o.id);
      const ls=lastOf(sters,"oId",o.id);
      const hasAlertM=lr&&lr.mosche>=SA;
      const hasAlertI=ls&&calcInf(ls).att>=IA;
      if(filtro==="alert") return hasAlertM||hasAlertI;
      if(filtro==="ok") return !hasAlertM&&!hasAlertI;
      return true;
    });
    const bounds=[];
    filtered.forEach(o=>{
      const lr=lastOf(rils,"oId",o.id);
      const ls=lastOf(sters,"oId",o.id);
      const hasAlertM=lr&&lr.mosche>=SA;
      const hasAlertI=ls&&calcInf(ls).att>=IA;
      const color=hasAlertM?"#dc2626":hasAlertI?"#d97706":"#16a34a";
      const icon=window.L.divIcon({className:"",html:"<div style='background:"+color+";width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;border:3px solid white;box-shadow:0 2px 8px rgba(0,0,0,0.3)'>ğŸ«’</div>",iconSize:[36,36],iconAnchor:[18,18]});
      const inf=ls?calcInf(ls):null;
      const cliente=clienti.find(c=>c.id===o.cliente_id);
      const popupHtml="<div style='font-family:sans-serif;min-width:160px'><strong>"+o.nome+"</strong><br><small style='color:#6b7280'>"+o.comune+"</small>"+(cliente?"<br><small>ğŸ‘¤ "+cliente.nome+"</small>":"")+(lr?"<br>ğŸª¤ "+lr.data+": "+lr.mosche+" mosche":"")+(inf?"<br>ğŸ”¬ Inf: "+inf.att.toFixed(1)+"%":"")+"<br><br><button onclick='window.__mapNav(""+o.id+"")' style='background:#16a34a;color:white;border:none;padding:5px 12px;border-radius:8px;cursor:pointer;font-size:12px'>Apri scheda â†’</button></div>";
      const marker=window.L.marker([+o.lat,+o.lng],{icon});
      marker._isMarker=true;
      marker.bindPopup(popupHtml).addTo(map);
      bounds.push([+o.lat,+o.lng]);
    });
    if(bounds.length>0) map.fitBounds(bounds,{padding:[40,40]});
  },[oliveti,rils,sters,filtro]);

  useEffect(()=>{
    window.__mapNav=(oId)=>{ const o=oliveti.find(x=>x.id===oId); if(o) nav("oliveto-detail",o); };
    return()=>{ delete window.__mapNav; };
  },[oliveti,nav]);

  const olConGPS=oliveti.filter(o=>o.lat&&o.lng).length;

  return(
    <div style={{display:"flex",flexDirection:"column",height:"calc(100vh - 64px)",position:"relative",overflow:"hidden"}}>
      <div style={{padding:"12px 14px 8px",flexShrink:0}}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8}}>
          <h3 style={{fontFamily:"Lora,serif",fontSize:17,margin:0}}>ğŸ—ºï¸ Mappa oliveti</h3>
          <span style={{fontSize:12,color:mutedC}}>{olConGPS} su {oliveti.length} con GPS</span>
        </div>
        <div style={{display:"flex",gap:8}}>
          {[["tutti","Tutti"],["alert","âš ï¸ Avviso"],["ok","âœ… Va bene"]].map(([v,l])=>(
            <button key={v} onClick={()=>setFiltro(v)}
              style={{padding:"6px 14px",borderRadius:20,border:"none",cursor:"pointer",fontSize:12,fontWeight:600,
                background:filtro===v?"white":(dark?"#1e3a1e":"#f0fdf4"),
                color:filtro===v?"#16a34a":(dark?"#4ade80":"#16a34a"),
                boxShadow:filtro===v?"0 2px 8px rgba(0,0,0,0.15)":"none"}}>
              {l}
            </button>
          ))}
        </div>
      </div>
      {!window.L?(
        <div style={{flex:1,display:"flex",alignItems:"center",justifyContent:"center",flexDirection:"column",gap:12}}>
          <div style={{fontSize:48}}>ğŸ—ºï¸</div>
          <p style={{color:mutedC}}>Leaflet non caricato.</p>
        </div>
      ):(
        <div ref={mapRef} style={{flex:1,position:"relative",zIndex:0}}/>
      )}
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HOME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function Home({clienti,oliveti,rils,sters,nav,dark}){
  const [search,setSearch]=useState("");
  const [sort,setSort]=useState("nome");
  const [showAlert,setShowAlert]=useState(false);
  const mutedC=dark?"#94a3b8":"#6b7280";
  const cardBg=dark?"#1e293b":"white";
  const grad=dark?"linear-gradient(135deg,#0a1f0f,#052e16)":"linear-gradient(135deg,#052e16,#166534)";

  const alertOl=oliveti.filter(o=>{
    const lr=lastOf(rils,"oId",o.id);
    const ls=lastOf(sters,"oId",o.id);
    return (lr&&lr.mosche>=SA)||(ls&&calcInf(ls).att>=IA);
  });

  const enriched=clienti.map(c=>{
    const myOl=oliveti.filter(o=>o.cliente_id===c.id);
    const myRils=rils.filter(r=>myOl.map(o=>o.id).includes(r.oId));
    const myS=sters.filter(s=>myOl.map(o=>o.id).includes(s.oId));
    const alertM=myOl.filter(o=>{const l=lastOf(rils,"oId",o.id);return l&&l.mosche>=SA;}).length;
    const alertI=myOl.filter(o=>{const l=lastOf(sters,"oId",o.id);return l&&calcInf(l).att>=IA;}).length;
    const lastRil=myRils.sort((a,b)=>b.data.localeCompare(a.data))[0];
    return{c,myOl,alertM,alertI,lastRil};
  });

  const filtered=enriched
    .filter(({c})=>c.nome.toLowerCase().includes(search.toLowerCase()))
    .sort((a,b)=>{
      if(sort==="alert") return (b.alertM+b.alertI)-(a.alertM+a.alertI);
      if(sort==="data") return (b.lastRil?.data||"").localeCompare(a.lastRil?.data||"");
      return a.c.nome.localeCompare(b.c.nome);
    });

  return(
    <div>
      <div style={{background:grad,padding:"20px 16px 28px"}}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16}}>
          <div style={{display:"flex",alignItems:"center",gap:8}}>
            <span style={{fontSize:28}}>ğŸ«’</span>
            <h1 style={{color:"white",fontFamily:"Lora,serif",fontSize:22,margin:0}}>OliveTrack</h1>
          </div>
        </div>
        {alertOl.length>0&&(
          <div onClick={()=>setShowAlert(true)} style={{background:"rgba(220,38,38,0.2)",border:"1px solid rgba(220,38,38,0.4)",borderRadius:12,padding:"10px 14px",cursor:"pointer",marginBottom:12}}>
            <div style={{color:"#fca5a5",fontWeight:700,fontSize:13}}>âš ï¸ {alertOl.length} olivet{alertOl.length>1?"i":"o"} in allerta â€” tocca per vedere</div>
          </div>
        )}
        <div style={{position:"relative"}}>
          <span style={{position:"absolute",left:12,top:"50%",transform:"translateY(-50%)",fontSize:16}}>ğŸ”</span>
          <input value={search} onChange={e=>setSearch(e.target.value)} placeholder="Cerca cliente..." style={{width:"100%",padding:"10px 12px 10px 36px",borderRadius:12,border:"none",background:"rgba(255,255,255,0.15)",color:"white",fontSize:14,outline:"none"}}/>
        </div>
      </div>
      <div style={{padding:"12px 14px"}}>
        <div style={{display:"flex",gap:6,marginBottom:12,alignItems:"center"}}>
          <span style={{fontSize:12,color:mutedC,fontWeight:600}}>Ordina:</span>
          {[["nome","Aâ†’Z"],["alert","âš ï¸"],["data","ğŸ“…"]].map(([v,l])=>(
            <button key={v} onClick={()=>setSort(v)} style={{padding:"5px 10px",borderRadius:8,border:"none",cursor:"pointer",fontSize:11,fontWeight:600,background:sort===v?"#16a34a":(dark?"#1e3a1e":"#f0fdf4"),color:sort===v?"white":(dark?"#4ade80":"#16a34a")}}>{l}</button>
          ))}
        </div>
        {filtered.map(({c,myOl,alertM,alertI})=>(
          <div key={c.id} onClick={()=>nav("cliente-detail",c)} style={{background:cardBg,borderRadius:16,padding:16,marginBottom:10,cursor:"pointer",boxShadow:dark?"0 2px 14px rgba(0,0,0,0.4)":"0 2px 14px rgba(0,0,0,0.07)"}} className="card">
            <div style={{display:"flex",alignItems:"center",gap:12}}>
              <div style={{width:44,height:44,borderRadius:22,background:"linear-gradient(135deg,#052e16,#16a34a)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:20,flexShrink:0}}>ğŸ‘¤</div>
              <div style={{flex:1,minWidth:0}}>
                <div style={{fontWeight:700,fontFamily:"Lora,serif",fontSize:15,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{c.nome}</div>
                <div style={{fontSize:12,color:mutedC}}>{myOl.length} olivet{myOl.length===1?"o":"i"}{c.telefono?" Â· ğŸ“ "+c.telefono:""}</div>
              </div>
              <div style={{display:"flex",gap:4,flexShrink:0}}>
                {alertM>0&&<span className="tag" style={{background:"rgba(220,38,38,0.15)",color:"#dc2626",border:"1px solid #dc2626"}}>ğŸª¤ {alertM}</span>}
                {alertI>0&&<span className="tag" style={{background:"rgba(217,119,6,0.15)",color:"#d97706",border:"1px solid #d97706"}}>ğŸ”¬ {alertI}</span>}
              </div>
            </div>
          </div>
        ))}
        {filtered.length===0&&<p style={{textAlign:"center",color:mutedC,padding:32}}>Nessun cliente trovato</p>}
        <button onClick={()=>nav("add-cliente",null)} style={{width:"100%",padding:14,background:dark?"#1e3a1e":"#f0fdf4",color:"#16a34a",border:"2px dashed #86efac",borderRadius:14,fontSize:15,fontWeight:600,cursor:"pointer",marginTop:4}}>
          + Aggiungi cliente
        </button>
      </div>
      {showAlert&&createPortal(
        <div style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.5)",zIndex:2000,display:"flex",alignItems:"flex-end"}} onClick={()=>setShowAlert(false)}>
          <div style={{background:dark?"#1e293b":"white",borderRadius:"20px 20px 0 0",padding:20,width:"100%",maxHeight:"70vh",overflowY:"auto"}} onClick={e=>e.stopPropagation()}>
            <h3 style={{fontFamily:"Lora,serif",marginBottom:16}}>âš ï¸ Oliveti in allerta</h3>
            {alertOl.map(o=>{
              const lr=lastOf(rils,"oId",o.id);
              const ls=lastOf(sters,"oId",o.id);
              const hasM=lr&&lr.mosche>=SA;
              const hasI=ls&&calcInf(ls).att>=IA;
              const cliente=clienti.find(c=>c.id===o.cliente_id);
              return(
                <div key={o.id} onClick={()=>{setShowAlert(false);nav("oliveto-detail",o);}} style={{background:dark?"#273549":"#f9fafb",borderRadius:12,padding:14,marginBottom:8,cursor:"pointer"}}>
                  <div style={{fontWeight:700}}>{o.nome}</div>
                  <div style={{fontSize:12,color:mutedC}}>{cliente?.nome}</div>
                  <div style={{display:"flex",gap:6,marginTop:6}}>
                    {hasM&&<span className="tag" style={{background:"rgba(220,38,38,0.15)",color:"#dc2626",border:"1px solid #dc2626"}}>ğŸª¤ {lr.mosche} mosche</span>}
                    {hasI&&<span className="tag" style={{background:"rgba(217,119,6,0.15)",color:"#d97706",border:"1px solid #d97706"}}>ğŸ”¬ {calcInf(ls).att.toFixed(1)}%</span>}
                  </div>
                </div>
              );
            })}
          </div>
        </div>, document.body
      )}
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WHATSAPP HELPER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function apriWhatsApp(telefono,testo){
  const num=telefono.split("").filter(c=>c>="0"&&c<="9").join("");
  const full=num.startsWith("39")?num:"39"+num;
  window.open("https://wa.me/"+full+"?text="+encodeURIComponent(testo),"_blank");
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// APP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function App(){
  const [dark,setDark]=useState(()=>window.matchMedia?.("(prefers-color-scheme:dark)").matches||false);
  const [page,setPage]=useState("home");
  const [pdata,setPdata]=useState(null);
  const [clienti,setClienti]=useState([]);
  const [oliveti,setOliveti]=useState([]);
  const [rils,setRils]=useState([]);
  const [sters,setSters]=useState([]);
  const [trats,setTrats]=useState([]);
  const [traps,setTraps]=useState([]);
  const [loading,setLoading]=useState(true);
  const [waPending,setWaPending]=useState(null);
  const online=useOnline();

  const PendingQueue={
    get:()=>{try{return JSON.parse(localStorage.getItem("ot_queue")||"[]");}catch{return[];}},
    add:(op)=>{const q=PendingQueue.get();q.push({...op,_qid:Date.now()});localStorage.setItem("ot_queue",JSON.stringify(q));},
    remove:(qid)=>{const q=PendingQueue.get().filter(x=>x._qid!==qid);localStorage.setItem("ot_queue",JSON.stringify(q));},
    clear:()=>localStorage.removeItem("ot_queue"),
  };

  useEffect(()=>{ loadAll(); },[]);

  useEffect(()=>{
    if(online) syncPending();
  },[online]);

  useEffect(()=>{
    window.__waPreventivo=(testo)=>{
      if(page==="oliveto-detail"&&pdata){
        const ol=oliveti.find(o=>o.id===pdata.id)||pdata;
        const c=clienti.find(x=>x.id===ol.cliente_id);
        if(c?.telefono) setWaPending({nome:c.nome,telefono:c.telefono,testo,goTo:()=>{}});
        else alert("Nessun numero di telefono per questo cliente");
      }
    };
    return()=>{ delete window.__waPreventivo; };
  },[page,pdata,oliveti,clienti]);

  async function syncPending(){
    const q=PendingQueue.get();
    for(const op of q){
      if(op.type==="ril"){
        const{error}=await sb.from("monitoraggi").insert(op.data);
        if(!error) PendingQueue.remove(op._qid);
      } else if(op.type==="ster"){
        const{error}=await sb.from("campionamenti").insert(op.data);
        if(!error) PendingQueue.remove(op._qid);
      }
    }
    if(q.length) loadAll();
  }

  async function loadAll(){
    setLoading(true);
    const[{data:cl},{data:ol},{data:ri},{data:st},{data:tr},{data:tp}]=await Promise.all([
      sb.from("clienti").select("*").order("nome"),
      sb.from("oliveti").select("*").order("nome"),
      sb.from("monitoraggi").select("*").order("data",{ascending:false}),
      sb.from("campionamenti").select("*").order("data",{ascending:false}),
      sb.from("trattamenti").select("*").order("data",{ascending:false}),
      sb.from("trappole").select("*"),
    ]);
    const fixRil=(r)=>({...r,oId:r.oId||r.oliveto_id,mosche:+r.mosche||0});
    const fixSter=(s)=>({...s,oId:s.oId||s.oliveto_id});
    const fixTrat=(t)=>({...t,oId:t.oId||t.oliveto_id});
    setClienti(cl||[]);
    setOliveti(ol||[]);
    setRils((ri||[]).map(fixRil));
    setSters((st||[]).map(fixSter));
    setTrats((tr||[]).map(fixTrat));
    setTraps(tp||[]);
    setLoading(false);
  }

  function nav(p,d){ setPage(p); setPdata(d); window.scrollTo(0,0); }
  function goHome(){ nav("home",null); }

  const trapsC=traps.filter(t=>t.oliveto_id===(pdata?.id||pdata?.oId));

  async function saveCliente(f){
    const{data,error}=await sb.from("clienti").insert({nome:f.nome,telefono:f.telefono||null,email:f.email||null,indirizzo:f.indirizzo||null}).select().single();
    if(error){alert("Errore: "+error.message);return;}
    if(data){setClienti(p=>[...p,data]);goHome();}
  }

  async function deleteCliente(id){
    await sb.from("clienti").delete().eq("id",id);
    setClienti(p=>p.filter(c=>c.id!==id));
    setOliveti(p=>p.filter(o=>o.cliente_id!==id));
    goHome();
  }

  async function saveOliveto(f){
    const payload={nome:f.nome,comune:f.comune||null,varieta:f.varieta||null,piante:+f.piante||null,ha:+f.ha||null,lat:+f.lat||null,lng:+f.lng||null,cliente_id:f.clienteId};
    const{data,error}=await sb.from("oliveti").insert(payload).select().single();
    if(error){alert("Errore: "+error.message);return;}
    if(data){
      setOliveti(p=>[...p,data]);
      const c=clienti.find(x=>x.id===f.clienteId);
      if(c) nav("cliente-detail",c); else goHome();
    }
  }

  async function deleteOliveto(id){
    const ol=oliveti.find(o=>o.id===id);
    setOliveti(p=>p.filter(o=>o.id!==id));
    setRils(p=>p.filter(r=>r.oliveto_id!==id));
    setSters(p=>p.filter(s=>s.oliveto_id!==id));
    setTrats(p=>p.filter(t=>t.oliveto_id!==id));
    setTraps(p=>p.filter(t=>t.oliveto_id!==id));
    const cliente=ol?clienti.find(c=>c.id===ol.cliente_id):null;
    if(cliente) nav("cliente-detail",cliente); else goHome();
  }

  async function deleteRil(id){ await sb.from("monitoraggi").delete().eq("id",id); setRils(p=>p.filter(r=>r.id!==id)); }
  async function deleteSter(id){ await sb.from("campionamenti").delete().eq("id",id); setSters(p=>p.filter(s=>s.id!==id)); }
  async function deleteTrat(id){ await sb.from("trattamenti").delete().eq("id",id); setTrats(p=>p.filter(t=>t.id!==id)); }
  async function updateRil(f){ setRils(p=>p.map(r=>r.id===f.id?{...r,...f,mosche:+f.mosche}:r)); }
  async function updateSter(f){ setSters(p=>p.map(s=>s.id===f.id?{...s,...f}:s)); }
  async function updateTrat(f){ setTrats(p=>p.map(t=>t.id===f.id?{...t,...f}:t)); }

  async function saveRil(f){
    const trap=trapsC.find(t=>t.id===f.trapId);
    const payload={data:f.data,mosche:f.mosche,meteo:f.meteo,fase:f.fase,oliveto_id:f.oId,trappola_id:f.trapId,trappola:trap?.nome||"",stagione:new Date(f.data).getFullYear()};
    if(!online){
      PendingQueue.add({type:"ril",data:payload});
      setRils(p=>[...p,{...payload,id:"offline_"+Date.now(),oId:f.oId,_offline:true}]);
      const ol=oliveti.find(o=>o.id===f.oId);
      if(ol) nav("oliveto-detail",ol); else goHome();
      return;
    }
    const{data,error}=await sb.from("monitoraggi").insert(payload).select().single();
    if(error){alert("Errore: "+error.message);return;}
    if(data){
      setRils(p=>[...p,data]);
      const ol=oliveti.find(o=>o.id===f.oId);
      const cliente=ol?clienti.find(c=>c.id===ol.cliente_id):null;
      if(cliente?.telefono){
        const rv=rischio(data.mosche);
        const testo="ğŸ«’ OliveTrack â€” Monitoraggio del "+data.data+"\n\nOliveto: "+ol.nome+" ("+(ol.comune||"")+")"+"\nTrappola: "+(data.trappola||"â€”")+"\nMosche catturate: "+data.mosche+"\nRischio: "+rv.l+(data.meteo?"\nMeteo: "+data.meteo:"")+(data.fase?"\nFase: "+data.fase:"")+"\n\nA presto!";
        setWaPending({nome:cliente.nome,telefono:cliente.telefono,testo,goTo:()=>{if(ol) nav("oliveto-detail",ol); else goHome();}});
      } else {
        if(ol) nav("oliveto-detail",ol); else goHome();
      }
    } else goHome();
  }

  async function saveSter(f){
    const payload={data:f.data,camp:+f.camp,uova:+f.uova,l1:+f.l1,l2:+f.l2,l3:+f.l3,pupe:+f.pupe,fori:+f.fori,oliveto_id:f.oId,stagione:new Date(f.data).getFullYear()};
    if(!online){
      PendingQueue.add({type:"ster",data:payload});
      setSters(p=>[...p,{...payload,id:"offline_"+Date.now(),oId:f.oId,_offline:true}]);
      const ol=oliveti.find(o=>o.id===f.oId);
      if(ol) nav("oliveto-detail",ol); else goHome();
      return;
    }
    const{data,error}=await sb.from("campionamenti").insert(payload).select().single();
    if(error){alert("Errore: "+error.message);return;}
    if(data){
      setSters(p=>[...p,data]);
      const ol=oliveti.find(o=>o.id===f.oId);
      const cliente=ol?clienti.find(c=>c.id===ol.cliente_id):null;
      if(cliente?.telefono){
        const inf=calcInf(data);
        const testo="ğŸ«’ OliveTrack â€” Campionamento del "+data.data+"\n\nOliveto: "+ol.nome+" ("+(ol.comune||"")+")"+"\nOlive campionate: "+data.camp+"\nStadi attivi: Uova "+data.uova+" Â· L1 "+data.l1+" Â· L2 "+data.l2+"\nStadi passivi: L3 "+data.l3+" Â· Pupe "+data.pupe+" Â· Fori "+data.fori+"\nInfestazione attiva: "+inf.att.toFixed(1)+"%\nInfestazione totale: "+inf.tot.toFixed(1)+"%\n\nA presto!";
        setWaPending({nome:cliente.nome,telefono:cliente.telefono,testo,goTo:()=>{if(ol) nav("oliveto-detail",ol); else goHome();}});
      } else {
        if(ol) nav("oliveto-detail",ol); else goHome();
      }
    } else goHome();
  }

  async function saveTrat(f){
    const{data,error}=await sb.from("trattamenti").insert({data:f.data,prodotto:f.prodotto,dose:f.dose||null,note:f.note||null,oliveto_id:f.oId}).select().single();
    if(error){alert("Errore: "+error.message);return;}
    if(data) setTrats(p=>[...p,data]);
    const ol=oliveti.find(o=>o.id===f.oId);
    if(ol) nav("oliveto-detail",ol); else goHome();
  }

  const theme=dark?"dark":"light";
  const headerBg=dark?"#0a1f0f":"#052e16";
  const grad=dark?"linear-gradient(135deg,#0a1f0f,#1a3a1a)":"linear-gradient(135deg,#052e16,#166534)";
  const cardBg=dark?"#1e293b":"white";
  const mutedC=dark?"#94a3b8":"#6b7280";
  const pendingCount=PendingQueue.get().length;

  function renderPage(){
    if(loading) return <div style={{display:"flex",alignItems:"center",justifyContent:"center",height:"60vh",flexDirection:"column",gap:16}}><span className="spinner" style={{width:36,height:36,borderWidth:3}}/><p style={{color:mutedC}}>Caricamento...</p></div>;
    switch(page){
      case "home": return <Home clienti={clienti} oliveti={oliveti} rils={rils} sters={sters} nav={nav} dark={dark}/>;
      case "mappa": return <MappaOliveti oliveti={oliveti} rils={rils} sters={sters} clienti={clienti} nav={nav} dark={dark}/>;
      case "cliente-detail": return <ClienteDetail cliente={pdata} oliveti={oliveti} rils={rils} sters={sters} trats={trats} traps={traps} setTraps={setTraps} onBack={goHome} nav={nav} dark={dark} onDeleteCliente={deleteCliente} onDeleteOliveto={deleteOliveto} onDeleteRil={deleteRil} onDeleteSter={deleteSter} onDeleteTrat={deleteTrat} onUpdateRil={updateRil} onUpdateSter={updateSter} onUpdateTrat={updateTrat}/>;
      case "oliveto-detail": return <OlivetoDetail oliveto={pdata} onBack={()=>{const c=clienti.find(x=>x.id===pdata?.cliente_id);if(c)nav("cliente-detail",c);else goHome();}} nav={nav} rils={rils} sters={sters} trats={trats} traps={traps} setTraps={setTraps} dark={dark} onDeleteOliveto={deleteOliveto} onDeleteRil={deleteRil} onDeleteSter={deleteSter} onDeleteTrat={deleteTrat} onUpdateRil={updateRil} onUpdateSter={updateSter} onUpdateTrat={updateTrat}/>;
      case "add-cliente": return <AddCliente onBack={goHome} onSave={saveCliente} dark={dark}/>;
      case "add-oliveto": return <AddOliveto onBack={()=>{const c=clienti.find(x=>x.id===pdata?.clienteId);if(c)nav("cliente-detail",c);else goHome();}} onSave={saveOliveto} clienti={clienti} preCliente={pdata?.clienteId} dark={dark}/>;
      case "add-rilevamento": return <AddRilevamento oliveti={oliveti} traps={traps} onBack={()=>{const ol=oliveti.find(o=>o.id===pdata?.oId);if(ol)nav("oliveto-detail",ol);else goHome();}} onSave={saveRil} preOliveto={pdata?.oId} dark={dark}/>;
      case "add-stereoscopio": return <AddStereoscopio oliveti={oliveti} onBack={()=>{const ol=oliveti.find(o=>o.id===pdata?.oId);if(ol)nav("oliveto-detail",ol);else goHome();}} onSave={saveSter} preOliveto={pdata?.oId} dark={dark}/>;
      case "add-trattamento": return <AddTrattamento oliveto={oliveti.find(o=>o.id===pdata?.oId)} onBack={()=>{const ol=oliveti.find(o=>o.id===pdata?.oId);if(ol)nav("oliveto-detail",ol);else goHome();}} onSave={saveTrat} dark={dark}/>;
      case "soglie": return <Soglie onBack={goHome} dark={dark}/>;
      case "export": return <Export oliveti={oliveti} clienti={clienti} rils={rils} sters={sters} onBack={goHome} dark={dark}/>;
      case "gestione-trappole": return <GestioneTrappole trappole={traps.filter(t=>t.oliveto_id===pdata?.oId)} setTrappole={setTraps} oId={pdata?.oId} oliveto={oliveti.find(o=>o.id===pdata?.oId)} dark={dark} onBack={()=>{const ol=oliveti.find(o=>o.id===pdata?.oId);if(ol)nav("oliveto-detail",ol);else goHome();}}/>;
      default: return <Home clienti={clienti} oliveti={oliveti} rils={rils} sters={sters} nav={nav} dark={dark}/>;
    }
  }

  const NAV=[["home","ğŸ ","Home"],["mappa","ğŸ—ºï¸","Mappa"],["export","ğŸ“Š","Export"],["soglie","âš™ï¸","Soglie"]];

  return(
    <div className={"page "+theme}>
      <div className="content-wrap">
        <header className="header" style={{background:headerBg}}>
          <div style={{display:"flex",alignItems:"center",gap:8}}>
            <span style={{fontSize:22}}>ğŸ«’</span>
            <span style={{color:"white",fontFamily:"Lora,serif",fontWeight:700,fontSize:17}}>OliveTrack</span>
            <span title={online?"Online":"Offline"} style={{marginLeft:4}}>{online?<span className="dot-online"/>:<span className="dot-offline"/>}</span>
            {!online&&pendingCount>0&&<span style={{background:"#d97706",color:"white",borderRadius:10,padding:"2px 7px",fontSize:10,fontWeight:700}}>â³ {pendingCount} da sync</span>}
          </div>
          <button onClick={()=>setDark(d=>!d)} style={{background:"rgba(255,255,255,0.15)",border:"none",color:"white",padding:"6px 12px",borderRadius:20,cursor:"pointer",fontSize:13}}>
            {dark?"â˜€ï¸":"ğŸŒ™"}
          </button>
        </header>
        <div className="scroll-area">{renderPage()}</div>
        {waPending&&createPortal(
          <div style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.6)",zIndex:9000,display:"flex",alignItems:"center",justifyContent:"center",padding:20}}>
            <div style={{background:"white",borderRadius:20,padding:24,width:"100%",maxWidth:360,boxShadow:"0 8px 32px rgba(0,0,0,0.3)"}}>
              <div style={{fontSize:40,textAlign:"center",marginBottom:12}}>ğŸ’¬</div>
              <h3 style={{fontFamily:"Lora,serif",margin:"0 0 8px",textAlign:"center",fontSize:18,color:"#1a1a2e"}}>Invia su WhatsApp</h3>
              <p style={{color:"#6b7280",fontSize:14,textAlign:"center",margin:"0 0 16px"}}>Vuoi inviare il report a <strong>{waPending.nome}</strong>?</p>
              <div style={{background:"#f0fdf4",border:"1px solid #86efac",borderRadius:12,padding:12,marginBottom:16,fontSize:12,color:"#166534",whiteSpace:"pre-wrap",maxHeight:160,overflowY:"auto",fontFamily:"monospace"}}>{waPending.testo}</div>
              <div style={{display:"flex",gap:10}}>
                <button onClick={()=>{apriWhatsApp(waPending.telefono,waPending.testo);waPending.goTo();setWaPending(null);}}
                  style={{flex:1,padding:"12px",background:"#25d366",color:"white",border:"none",borderRadius:12,fontSize:14,fontWeight:700,cursor:"pointer"}}>
                  ğŸ“¤ Invia
                </button>
                <button onClick={()=>{waPending.goTo();setWaPending(null);}}
                  style={{flex:1,padding:"12px",background:"#f3f4f6",color:"#374151",border:"none",borderRadius:12,fontSize:14,fontWeight:700,cursor:"pointer"}}>
                  Salta
                </button>
              </div>
            </div>
          </div>, document.body
        )}
        {page==="home"&&(
          <div className="bottom-nav nav-bg" style={{zIndex:1000}}>
            {NAV.map(([id,icon,lbl])=>(
              <button key={id} onClick={()=>nav(id,null)} className="nav-btn"
                style={{color:page===id?"#16a34a":mutedC,fontWeight:page===id?700:400}}>
                <span style={{fontSize:22}}>{icon}</span>
                <span style={{fontSize:10}}>{lbl}</span>
              </button>
            ))}
          </div>
        )}
      </div>
    </div>
  );
}

ReactDOM.render(<App/>, document.getElementById("root"));
</script>

<div id="install-banner" style="display:none;position:fixed;bottom:90px;left:50%;transform:translateX(-50%);width:calc(100% - 32px);max-width:398px;background:#052e16;color:white;border-radius:16px;padding:14px 18px;align-items:center;gap:12px;z-index:9999;box-shadow:0 8px 32px rgba(0,0,0,0.4);">
  <span style="font-size:28px">ğŸ«’</span>
  <div style="flex:1"><div style="font-weight:700;font-size:14px">Installa OliveTrack</div><div style="font-size:12px;opacity:0.8">Aggiungi alla schermata home</div></div>
  <button onclick="deferredPrompt.prompt();document.getElementById('install-banner').style.display='none';" style="background:#16a34a;border:none;color:white;padding:8px 14px;border-radius:10px;font-weight:700;cursor:pointer;font-size:13px">Installa</button>
  <button onclick="document.getElementById('install-banner').style.display='none';" style="background:rgba(255,255,255,0.2);border:none;color:white;padding:8px 10px;border-radius:10px;cursor:pointer">âœ•</button>
</div>
<script>
let deferredPrompt;
window.addEventListener("beforeinstallprompt",e=>{e.preventDefault();deferredPrompt=e;document.getElementById("install-banner").style.display="flex";});
</script>
</body>
</html>
