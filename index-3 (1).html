<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>OliveTrack</title>
<meta name="application-name" content="OliveTrack">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="OliveTrack">
<meta name="theme-color" content="#052e16">
<meta name="mobile-web-app-capable" content="yes">
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%23052e16'/><text y='.9em' font-size='80' x='10'>ğŸ«’</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,600;0,700;1,400&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
* { box-sizing:border-box; margin:0; padding:0; }
body { font-family:'DM Sans',sans-serif; transition:background 0.3s; overflow-x:hidden; }
html { overflow-x:hidden; }
input,select,button,textarea { font-family:inherit; }
.page { width:100%; min-height:100vh; position:relative; transition:background 0.3s,color 0.3s; overflow-x:hidden; }
.content-wrap { width:100%; max-width:100%; padding:0; }
@media(min-width:600px){ .content-wrap { max-width:640px; margin:0 auto; } }
@media(min-width:900px){ .content-wrap { max-width:860px; } }
@media(min-width:1200px){ .content-wrap { max-width:1000px; } }
.light { background:#f8fafc; color:#1a1a2e; }
.light .card { background:white; box-shadow:0 2px 14px rgba(0,0,0,0.07); }
.light .header { background:#052e16; }
.light .section-bg { background:#f0fdf4; }
.light .input-border { border-color:#d1fae5; }
.light .input-bg { background:white; color:#1a1a2e; }
.light .muted { color:#6b7280; }
.light .divider { border-color:#f3f4f6; }
.light .nav-bg { background:white; border-color:#e5e7eb; }
.light .tab-inactive { background:#f0fdf4; color:#16a34a; }
.light .sub-bg { background:#f9fafb; }
.dark { background:#0f172a; color:#e2e8f0; }
.dark .card { background:#1e293b; box-shadow:0 2px 14px rgba(0,0,0,0.4); }
.dark .header { background:#0a1f0f; }
.dark .section-bg { background:#1a2e1a; }
.dark .input-border { border-color:#2d4a2d; }
.dark .input-bg { background:#1e293b; color:#e2e8f0; }
.dark .muted { color:#94a3b8; }
.dark .divider { border-color:#1e293b; }
.dark .nav-bg { background:#1e293b; border-color:#334155; }
.dark .tab-inactive { background:#1e3a1e; color:#4ade80; }
.dark .sub-bg { background:#273549; }
.scroll-area { overflow-y:auto; overflow-x:hidden; padding-bottom:90px; }
.header { position:sticky; top:0; z-index:50; padding:10px 12px; display:flex; justify-content:space-between; align-items:center; width:100%; }
.bottom-nav { position:fixed; bottom:0; left:0; width:100%; display:flex; border-top:1px solid; z-index:100; }
.card-grid { display:grid; grid-template-columns:1fr; gap:12px; }
@media(min-width:600px){ .card-grid { grid-template-columns:repeat(2,1fr); } }
@media(min-width:900px){ .card-grid { grid-template-columns:repeat(3,1fr); } }
.page-pad { padding:14px; }
@media(min-width:600px){ .page-pad { padding:20px 24px; } }
@media(min-width:900px){ .page-pad { padding:24px 32px; } }
.nav-btn { flex:1; padding:10px 4px 12px; border:none; cursor:pointer; display:flex; flex-direction:column; align-items:center; gap:2px; background:transparent; }
.card { border-radius:18px; padding:16px; margin-bottom:12px; cursor:pointer; transition:transform 0.15s,box-shadow 0.15s; }
.card:active { transform:scale(0.98); }
.tag { padding:3px 10px; border-radius:20px; font-size:11px; font-weight:700; display:inline-block; }
.inf-bar-bg { border-radius:99px; height:10px; overflow:hidden; background:#e2e8f0; }
.dark .inf-bar-bg { background:#334155; }
.inf-bar-fill { height:100%; border-radius:99px; transition:width 0.6s cubic-bezier(.4,0,.2,1); }
@keyframes fadeIn { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }
.fade-in { animation:fadeIn 0.2s ease; }
.cal-day { border-radius:10px; padding:4px; cursor:pointer; text-align:center; transition:background 0.15s; min-height:52px; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:2px; }
.btn-primary { width:100%; padding:14px; color:white; border:none; border-radius:14px; font-size:15px; font-weight:700; cursor:pointer; transition:filter 0.2s,transform 0.1s; margin-bottom:10px; }
.btn-primary:disabled { opacity:0.6; cursor:not-allowed; }
.spinner { display:inline-block; width:18px; height:18px; border:2px solid rgba(255,255,255,0.3); border-top-color:white; border-radius:50%; animation:spin 0.7s linear infinite; vertical-align:middle; }
@keyframes spin { to { transform:rotate(360deg); } }
.dot-online { width:8px; height:8px; border-radius:50%; background:#4ade80; display:inline-block; }
.dot-offline { width:8px; height:8px; border-radius:50%; background:#f97316; display:inline-block; }
::-webkit-scrollbar { width:4px; }
::-webkit-scrollbar-thumb { background:#d1d5db; border-radius:4px; }
.dark ::-webkit-scrollbar-thumb { background:#475569; }
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useRef, useEffect, useCallback, useMemo } = React;
const { createPortal } = ReactDOM;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SUPABASE CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SURL = "https://caphhwkuyjmrrettsghs.supabase.co";
const SKEY = "sb_publishable_yQxwladABV3GPyWXf0YEmg_vwSho6jI";
const sb = supabase.createClient(SURL, SKEY, { auth: { persistSession: false } });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// OFFLINE CACHE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const Cache = {
  set(k,v){ try{ localStorage.setItem("ot_"+k, JSON.stringify(v)); }catch(e){} },
  get(k){ try{ const v=localStorage.getItem("ot_"+k); return v?JSON.parse(v):null; }catch(e){ return null; } },
};
const PendingQueue = {
  add(op){ const q=this.get(); q.push({...op,_qid:Date.now()}); this.set(q); },
  get(){ return Cache.get("pending")||[]; },
  set(q){ Cache.set("pending",q); },
  remove(qid){ this.set(this.get().filter(x=>x._qid!==qid)); }
};

function useOnline(){
  const [online,setOnline]=useState(navigator.onLine);
  useEffect(()=>{
    const on=()=>setOnline(true), off=()=>setOnline(false);
    window.addEventListener("online",on); window.addEventListener("offline",off);
    return()=>{ window.removeEventListener("online",on); window.removeEventListener("offline",off); };
  },[]);
  return online;
}

function fmtDate(d){ return d?String(d).slice(0,10):""; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SOGLIE E HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let SA=30, SP=60, IA=5, IP=10;

function rischio(m){
  if(m>=SP) return {l:"PERICOLO",c:"#dc2626",bg:"rgba(220,38,38,0.12)",border:"#dc2626"};
  if(m>=SA) return {l:"ALLERTA",c:"#d97706",bg:"rgba(217,119,6,0.12)",border:"#d97706"};
  return {l:"OK",c:"#16a34a",bg:"rgba(22,163,74,0.12)",border:"#16a34a"};
}
function calcInf(s){
  if(!s||!s.camp) return null;
  return {
    att:Math.min(((s.uova+s.l1+s.l2)/s.camp)*100,100),
    tot:Math.min(((s.uova+s.l1+s.l2+s.l3+s.pupe+s.fori)/s.camp)*100,100)
  };
}
function lastOf(arr,k,v){ return [...arr].filter(x=>x[k]===v).sort((a,b)=>b.data.localeCompare(a.data))[0]||null; }
function cInf(v){ return v>=IP?"#dc2626":v>=IA?"#d97706":"#16a34a"; }
function rischioInf(v){
  if(v>=IP) return {l:"PERICOLO",c:"#dc2626",bg:"rgba(220,38,38,0.12)",border:"#dc2626"};
  if(v>=IA) return {l:"ALLERTA",c:"#d97706",bg:"rgba(217,119,6,0.12)",border:"#d97706"};
  return {l:"OK",c:"#16a34a",bg:"rgba(22,163,74,0.12)",border:"#16a34a"};
}
function dayName(d){ return ["Dom","Lun","Mar","Mer","Gio","Ven","Sab"][d]; }
function monthName(m){ return ["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"][m]; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INF BAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function InfBar({label,value,color}){
  return(
    <div style={{marginBottom:10}}>
      <div style={{display:"flex",justifyContent:"space-between",marginBottom:4}}>
        <span style={{fontSize:12,fontWeight:600}} className="muted">{label}</span>
        <span style={{fontSize:14,fontWeight:700,color}}>{value.toFixed(1)}%</span>
      </div>
      <div className="inf-bar-bg">
        <div className="inf-bar-fill" style={{width:`${Math.min(value,100)}%`,background:color}}/>
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DUAL CHART
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function DualChart({oId,rils,sters,dark,selectedYear}){
  const [mode,setMode]=useState("mosche");
  const W=300,H=100,P=20,LEGEND_H=22;

  function MoscheChart({data,extra}){
    if(!data||data.length<2) return(
      <div style={{textAlign:"center",padding:"24px 0",color:dark?"#64748b":"#9ca3af",fontSize:13}}>
        ğŸ“Š Dati insufficienti â€” servono almeno 2 rilevamenti
      </div>
    );
    const all=[...data,...(extra||[])];
    const max=Math.max(...all.map(d=>d.mosche),SP+10);
    const xs=d=>d.map((_,i)=>P+(i/(d.length-1))*(W-P*2));
    const ys=d=>d.map(x=>H-P-((x.mosche/max)*(H-P*2)));
    const path=(d,x,y)=>x.map((v,i)=>`${i===0?"M":"L"} ${v} ${y[i]}`).join(" ");
    const area=(d,x,y)=>`${path(d,x,y)} L ${x[x.length-1]} ${H-P} L ${x[0]} ${H-P} Z`;
    const s1y=H-P-((SA/max)*(H-P*2));
    const s2y=H-P-((SP/max)*(H-P*2));
    const x1=xs(data), y1=ys(data);
    const x2=extra?xs(extra):null, y2=extra?ys(extra):null;
    const gId="gm"+oId;
    const totalH=H+LEGEND_H+(extra?LEGEND_H:0);
    return(
      <svg width="100%" viewBox={`0 0 ${W} ${totalH}`} style={{overflow:"visible"}}>
        <defs>
          <linearGradient id={gId} x1="0" y1="0" x2="0" y2="1">
            <stop offset="0%" stopColor="#16a34a" stopOpacity="0.3"/>
            <stop offset="100%" stopColor="#16a34a" stopOpacity="0"/>
          </linearGradient>
        </defs>
        <line x1={P} y1={s2y} x2={W-P} y2={s2y} stroke="#dc2626" strokeWidth="1" strokeDasharray="4,3" opacity="0.6"/>
        <line x1={P} y1={s1y} x2={W-P} y2={s1y} stroke="#d97706" strokeWidth="1" strokeDasharray="4,3" opacity="0.6"/>
        <text x={W-P+2} y={s2y+3} fontSize="8" fill="#dc2626">{SP}</text>
        <text x={W-P+2} y={s1y+3} fontSize="8" fill="#d97706">{SA}</text>
        {extra&&x2&&<path d={path(extra,x2,y2)} fill="none" stroke="#a78bfa" strokeWidth="1.5" strokeDasharray="5,3" strokeLinecap="round"/>}
        {extra&&x2&&x2.map((x,i)=><circle key={i} cx={x} cy={y2[i]} r="2.5" fill="#a78bfa" stroke={dark?"#1e293b":"white"} strokeWidth="1"/>)}
        <path d={area(data,x1,y1)} fill={`url(#${gId})`}/>
        <path d={path(data,x1,y1)} fill="none" stroke="#16a34a" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
        {x1.map((x,i)=><circle key={i} cx={x} cy={y1[i]} r="3.5" fill={data[i].mosche>=SP?"#dc2626":data[i].mosche>=SA?"#d97706":"#16a34a"} stroke={dark?"#1e293b":"white"} strokeWidth="1.5"/>)}
        {data.map((d,i)=><text key={i} x={x1[i]} y={H+10} textAnchor="middle" fontSize="8" fill={dark?"#64748b":"#9ca3af"}>{d.data.slice(5)}</text>)}
      </svg>
    );
  }

  function InfChart({data}){
    if(!data||data.length<2) return(
      <div style={{textAlign:"center",padding:"24px 0",color:dark?"#64748b":"#9ca3af",fontSize:13}}>
        ğŸ”¬ Dati insufficienti â€” servono almeno 2 campionamenti
      </div>
    );
    const max=Math.max(...data.map(d=>Math.max(d.att,d.tot)),30);
    const xs=data.map((_,i)=>P+(i/(data.length-1))*(W-P*2));
    const ya=data.map(d=>H-P-((d.att/max)*(H-P*2)));
    const yt=data.map(d=>H-P-((d.tot/max)*(H-P*2)));
    const pa=xs.map((x,i)=>`${i===0?"M":"L"} ${x} ${ya[i]}`).join(" ");
    const pt=xs.map((x,i)=>`${i===0?"M":"L"} ${x} ${yt[i]}`).join(" ");
    const l10=H-P-((10/max)*(H-P*2));
    const l20=H-P-((20/max)*(H-P*2));
    const totalH=H+LEGEND_H+LEGEND_H;
    return(
      <svg width="100%" viewBox={`0 0 ${W} ${totalH}`} style={{overflow:"visible"}}>
        <line x1={P} y1={l10} x2={W-P} y2={l10} stroke="#d97706" strokeWidth="1" strokeDasharray="3,3" opacity="0.5"/>
        <line x1={P} y1={l20} x2={W-P} y2={l20} stroke="#dc2626" strokeWidth="1" strokeDasharray="3,3" opacity="0.5"/>
        <text x={W-P+2} y={l10+3} fontSize="8" fill="#d97706">10%</text>
        <text x={W-P+2} y={l20+3} fontSize="8" fill="#dc2626">20%</text>
        <path d={pt} fill="none" stroke="#7c3aed" strokeWidth="1.5" strokeDasharray="5,3" strokeLinecap="round"/>
        <path d={pa} fill="none" stroke="#d97706" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
        {xs.map((x,i)=><circle key={i+"a"} cx={x} cy={ya[i]} r="3.5" fill={cInf(data[i].att)} stroke={dark?"#1e293b":"white"} strokeWidth="1.5"/>)}
        {xs.map((x,i)=><circle key={i+"t"} cx={x} cy={yt[i]} r="2.5" fill="#7c3aed" stroke={dark?"#1e293b":"white"} strokeWidth="1"/>)}
        {data.map((d,i)=><text key={i} x={xs[i]} y={H+10} textAnchor="middle" fontSize="8" fill={dark?"#64748b":"#9ca3af"}>{d.data.slice(5)}</text>)}
        <g transform={`translate(0,${H+LEGEND_H})`}>
          <circle cx={P+6} cy={8} r="4" fill="#d97706"/>
          <text x={P+14} y={12} fontSize="8" fill={dark?"#94a3b8":"#6b7280"}>Attiva</text>
          <line x1={P+44} y1={8} x2={P+56} y2={8} stroke="#7c3aed" strokeWidth="2" strokeDasharray="4,2"/>
          <text x={P+60} y={12} fontSize="8" fill={dark?"#94a3b8":"#6b7280"}>Totale</text>
        </g>
      </svg>
    );
  }

  const year=new Date().getFullYear();
  const rilYear=y=>[...rils].filter(r=>r.oId===oId&&(r.stagione===y||new Date(r.data).getFullYear()===y)).sort((a,b)=>a.data.localeCompare(b.data));
  // Trova tutti gli anni disponibili
  const availYears=[...new Set(rils.filter(r=>r.oId===oId).map(r=>r.stagione||new Date(r.data).getFullYear()))].sort((a,b)=>b-a);
  const [selYear,setSelYear]=useState(year);
  useEffect(() => { setSelYear(selectedYear); }, [selectedYear]); 
  const cur=rilYear(selYear), prev=rilYear(selYear-1);
  const sterData=[...sters].filter(s=>s.oId===oId).sort((a,b)=>a.data.localeCompare(b.data)).map(s=>({...calcInf(s),data:s.data}));

  const chartTabs=[{id:"mosche",label:"ğŸª¤ Mosche"},{id:"inf",label:"ğŸ”¬ Infestazione"},{id:"season",label:"ğŸ“Š Stagioni"}];
  return(
    <div>
      <div style={{display:"flex",gap:6,marginBottom:10,flexWrap:"wrap",alignItems:"center"}}>
        {chartTabs.map(t=>(
          <button key={t.id} onClick={()=>setMode(t.id)}
            style={{padding:"6px 12px",borderRadius:8,border:"none",cursor:"pointer",fontSize:12,fontWeight:600,
              background:mode===t.id?"#16a34a":(dark?"#1e3a1e":"#f0fdf4"),
              color:mode===t.id?"white":(dark?"#4ade80":"#16a34a")}}>
            {t.label}
          </button>
        ))}
        {availYears.length>1&&(mode==="mosche"||mode==="season")&&(
          <select value={selYear} onChange={e=>setSelYear(+e.target.value)}
            style={{marginLeft:"auto",padding:"5px 8px",border:`1px solid ${dark?"#334155":"#d1fae5"}`,borderRadius:8,fontSize:12,background:dark?"#1e293b":"white",color:dark?"#e2e8f0":"#1a1a2e",outline:"none"}}>
            {availYears.map(y=><option key={y} value={y}>{y}</option>)}
          </select>
        )}
      </div>
      {mode==="mosche"&&<MoscheChart data={cur.length?cur:prev}/>}
      {mode==="season"&&<MoscheChart data={cur.length?cur:prev} extra={prev.length&&cur.length?prev:null}/>}
      {mode==="inf"&&<InfChart data={sterData}/>}
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CALENDARIO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function Calendario({rils,sters,trats,oliveti,dark,selectedYear}){
  const today=new Date();
  const [date,setDate]=useState(new Date(selectedYear || today.getFullYear(), today.getMonth(), 1));
  useEffect(() => { setDate(new Date(selectedYear || today.getFullYear(), today.getMonth(), 1)); }, [selectedYear]);
  const year=date.getFullYear(), month=date.getMonth();
  const firstDay=new Date(year,month,1).getDay();
  const daysInMonth=new Date(year,month+1,0).getDate();
  const isCurrentMonth=year===today.getFullYear()&&month===today.getMonth();
  const todayDay=today.getDate();
  const prefix=`${year}-${String(month+1).padStart(2,"0")}`;
  const rilMap={}, sterMap={}, tratMap={};
  rils.forEach(r=>{ if(r.data.startsWith(prefix)){ const d=parseInt(r.data.slice(8)); if(!rilMap[d])rilMap[d]=[];rilMap[d].push(r); }});
  sters.forEach(s=>{ if(s.data.startsWith(prefix)){ const d=parseInt(s.data.slice(8)); if(!sterMap[d])sterMap[d]=[];sterMap[d].push(s); }});
  trats.forEach(t=>{ if(t.data.startsWith(prefix)){ const d=parseInt(t.data.slice(8)); if(!tratMap[d])tratMap[d]=[];tratMap[d].push(t); }});
  const cells=[];
  for(let i=0;i<(firstDay===0?6:firstDay-1);i++) cells.push(null);
  for(let d=1;d<=daysInMonth;d++) cells.push(d);
  const mutedC=dark?"#94a3b8":"#6b7280";
  function getBg(d){
    const rs=rilMap[d]||[];
    if(rs.some(r=>r.mosche>=SP)) return "rgba(220,38,38,0.15)";
    if(rs.some(r=>r.mosche>=SA)) return "rgba(217,119,6,0.12)";
    if(rs.length||sterMap[d]||tratMap[d]) return "rgba(22,163,74,0.1)";
    return "transparent";
  }
  return(
    <div className="fade-in">
      <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:16,padding:"0 2px"}}>
        <button onClick={()=>setDate(new Date(year,month-1,1))} style={{background:"none",border:"none",fontSize:20,cursor:"pointer",color:mutedC}}>â€¹</button>
        <div style={{display:"flex",alignItems:"center",gap:8}}>
          <h3 style={{fontFamily:"Lora,serif",fontSize:18,margin:0}}>{monthName(month)} {year}</h3>
          {!isCurrentMonth&&<button onClick={()=>setDate(new Date(today.getFullYear(),today.getMonth(),1))} style={{fontSize:11,padding:"3px 8px",background:dark?"#1e3a1e":"#d1fae5",color:"#16a34a",border:"none",borderRadius:8,cursor:"pointer",fontWeight:700}}>Oggi</button>}
        </div>
        <button onClick={()=>setDate(new Date(year,month+1,1))} style={{background:"none",border:"none",fontSize:20,cursor:"pointer",color:mutedC}}>â€º</button>
      </div>
      <div style={{display:"grid",gridTemplateColumns:"repeat(7,1fr)",gap:4,marginBottom:8}}>
        {["L","M","M","G","V","S","D"].map((d,i)=><div key={i} style={{textAlign:"center",fontSize:11,fontWeight:700,color:mutedC,padding:"4px 0"}}>{d}</div>)}
      </div>
      <div style={{display:"grid",gridTemplateColumns:"repeat(7,1fr)",gap:4}}>
        {cells.map((d,i)=>(
          <div key={i} className="cal-day" style={{background:d?getBg(d):"transparent",opacity:d?1:0.3,border:d&&isCurrentMonth&&d===todayDay?`2px solid #16a34a`:"2px solid transparent",borderRadius:10}}>
            {d&&<span style={{fontSize:13,fontWeight:d&&isCurrentMonth&&d===todayDay?800:600,color:d&&isCurrentMonth&&d===todayDay?(dark?"#4ade80":"#16a34a"):undefined}}>{d}</span>}
            {d&&<div style={{display:"flex",gap:2,flexWrap:"wrap",justifyContent:"center"}}>
              {rilMap[d]?.slice(0,1).map(r=><span key={r.id} style={{fontSize:8,background:rischio(r.mosche).c,color:"white",borderRadius:4,padding:"0 3px"}}>{r.mosche}ğŸª¤</span>)}
              {sterMap[d]?.length>0&&<span style={{fontSize:8,background:"#7c3aed",color:"white",borderRadius:4,padding:"0 3px"}}>ğŸ”¬</span>}
              {tratMap[d]?.length>0&&<span style={{fontSize:8,background:"#16a34a",color:"white",borderRadius:4,padding:"0 3px"}}>ğŸ’Š</span>}
            </div>}
          </div>
        ))}
      </div>
      <div style={{marginTop:14,display:"flex",gap:8,flexWrap:"wrap"}}>
        {[["ğŸª¤ Monitoraggio","#16a34a"],["ğŸ”¬ Controllo","#7c3aed"],["ğŸ’Š Trattamento","#059669"],["âš ï¸ Allerta",rischio(SA).c],["ğŸš¨ Pericolo",rischio(SP).c]].map(([l,c])=>(
          <div key={l} style={{display:"flex",alignItems:"center",gap:4,fontSize:11,color:mutedC}}>
            <div style={{width:8,height:8,borderRadius:2,background:c}}/>{l}
          </div>
        ))}
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GESTIONE TRAPPOLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function GestioneTrappole({trappole,setTrappole,oId,oliveto,dark,onBack}){
  const [showAdd,setShowAdd]=useState(false);
  const [f,setF]=useState({nome:"",tipo:"Cromotropica"});
  const [saving,setSaving]=useState(false);
  const myT=trappole.filter(t=>(t.oliveto_id||t.oId)===oId);
  const set=(k,v)=>setF(p=>({...p,[k]:v}));
  const cardBg=dark?"#1e293b":"white";
  const mutedC=dark?"#94a3b8":"#6b7280";
  const tipoIcon={"Cromotropica":"ğŸŸ¡","A feromoni":"ğŸŸ£","Attrattivo alimentare":"ğŸŸ¢","Multilure":"ğŸ”µ"};
  const selStyle={width:"100%",padding:"9px 12px",border:`1.5px solid ${dark?"#2d4a2d":"#d1fae5"}`,borderRadius:10,fontSize:14,outline:"none",background:dark?"#273549":"white",color:dark?"#e2e8f0":"#1a1a2e"};

  async function save(){
    if(!f.nome){alert("Inserisci nome trappola");return;}
    setSaving(true);
    const{data}=await sb.from("trappole").insert({nome:f.nome,tipo:f.tipo,oliveto_id:oId,attiva:true}).select().single();
    if(data) setTrappole(p=>[...p,{...data,oId:data.oliveto_id}]);
    setF({nome:"",tipo:"Cromotropica"});setShowAdd(false);setSaving(false);
  }
  async function toggle(id,cur){
    await sb.from("trappole").update({attiva:!cur}).eq("id",id);
    setTrappole(p=>p.map(t=>t.id===id?{...t,attiva:!cur}:t));
  }
  async function remove(id){
    if(!confirm("Rimuovere questa trappola?")) return;
    await sb.from("trappole").delete().eq("id",id);
    setTrappole(p=>p.filter(t=>t.id!==id));
  }
  return(
    <div>
      <div style={{background:dark?"#0a1f0f":"linear-gradient(135deg,#052e16,#166534)",padding:"20px 20px 28px"}}>
        <button onClick={onBack} style={{background:"rgba(255,255,255,0.2)",border:"none",color:"white",padding:"6px 14px",borderRadius:20,cursor:"pointer",marginBottom:14,fontSize:13}}>â† Indietro</button>
        <h2 style={{color:"white",fontFamily:"Lora,serif"}}>ğŸª¤ Gestione Trappole</h2>
        <p style={{color:"#86efac",margin:"4px 0 0",fontSize:13}}>{oliveto}</p>
      </div>
      <div style={{padding:16}}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:14}}>
          <h3 style={{fontFamily:"Lora,serif",fontSize:16}}>{myT.length} trappol{myT.length===1?"a":"e"}</h3>
          <span style={{fontSize:12,color:mutedC}}>{myT.filter(t=>t.attiva).length} attive</span>
        </div>
        {myT.map(t=>(
          <div key={t.id} style={{background:cardBg,borderRadius:14,padding:14,marginBottom:10,boxShadow:dark?"0 2px 10px rgba(0,0,0,0.3)":"0 2px 10px rgba(0,0,0,0.07)",opacity:t.attiva?1:0.55}}>
            <div style={{display:"flex",alignItems:"center",gap:12}}>
              <div style={{fontSize:26}}>{tipoIcon[t.tipo]||"ğŸ”µ"}</div>
              <div style={{flex:1}}><div style={{fontWeight:700,fontSize:15}}>{t.nome}</div><div style={{fontSize:12,color:mutedC}}>{t.tipo}</div></div>
              <div style={{display:"flex",gap:8,alignItems:"center"}}>
                <div onClick={()=>toggle(t.id,t.attiva)} style={{width:42,height:24,borderRadius:12,background:t.attiva?"#16a34a":"#94a3b8",cursor:"pointer",position:"relative",transition:"background 0.2s"}}>
                  <div style={{position:"absolute",top:2,left:t.attiva?20:2,width:20,height:20,borderRadius:10,background:"white",transition:"left 0.2s",boxShadow:"0 1px 4px rgba(0,0,0,0.2)"}}/>
                </div>
                <button onClick={()=>remove(t.id)} style={{background:"none",border:"none",fontSize:16,cursor:"pointer",color:"#dc2626",padding:4}}>ğŸ—‘</button>
              </div>
            </div>
          </div>
        ))}
        {showAdd?(
          <div style={{background:cardBg,borderRadius:14,padding:16,boxShadow:dark?"0 2px 10px rgba(0,0,0,0.3)":"0 2px 10px rgba(0,0,0,0.07)"}}>
            <h4 style={{margin:"0 0 14px",fontFamily:"Lora,serif"}}>Nuova trappola</h4>
            <div style={{marginBottom:12}}>
              <label style={{display:"block",fontSize:13,fontWeight:600,color:mutedC,marginBottom:5}}>Nome trappola *</label>
              <input value={f.nome} onChange={e=>set("nome",e.target.value)} placeholder="Es. Trappola Nord" style={{...selStyle,border:`1.5px solid ${dark?"#2d4a2d":"#d1fae5"}`}}/>
            </div>
            <div style={{marginBottom:14}}>
              <label style={{display:"block",fontSize:13,fontWeight:600,color:mutedC,marginBottom:5}}>Tipo trappola</label>
              <select value={f.tipo} onChange={e=>set("tipo",e.target.value)} style={selStyle}>
                {["Cromotropica","A feromoni","Attrattivo alimentare","Multilure"].map(o=><option key={o} value={o}>{tipoIcon[o]} {o}</option>)}
              </select>
            </div>
            <div style={{display:"flex",gap:10}}>
              <button onClick={save} disabled={saving} className="btn-primary" style={{background:"#16a34a",marginBottom:0}}>{saving?<span className="spinner"/>:"ğŸ’¾ Salva"}</button>
              <button onClick={()=>setShowAdd(false)} className="btn-primary" style={{background:dark?"#334155":"#f3f4f6",color:dark?"#e2e8f0":"#374151",marginBottom:0}}>Annulla</button>
            </div>
          </div>
        ):(
          <button onClick={()=>setShowAdd(true)} style={{width:"100%",padding:14,background:dark?"#1e3a1e":"#f0fdf4",color:"#16a34a",border:"2px dashed #86efac",borderRadius:14,fontSize:15,fontWeight:600,cursor:"pointer"}}>
            + Aggiungi trappola
          </button>
        )}
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAP PICKER â€” solo OpenStreetMap (nessun CORS)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function MapPicker({initLat,initLng,onConfirm,onClose,dark}){
  const [lat,setLat]=useState(initLat||41.9);
  const [lng,setLng]=useState(initLng||12.5);
  const [off,setOff]=useState({x:0,y:0});
  const [dragging,setDragging]=useState(false);
  const [search,setSearch]=useState("");
  const [searching,setSearching]=useState(false);
  const [suggestions,setSuggestions]=useState([]);
  const mapRef=useRef(null);
  const drag=useRef(null);
  const [zoom,setZoom]=useState(13);
  const TILE=256,MW=360,MH=280;

  function toTile(la,lo){
    const n=Math.pow(2,zoom),x=((lo+180)/360)*n;
    const lr=(la*Math.PI)/180,y=((1-Math.log(Math.tan(lr)+1/Math.cos(lr))/Math.PI)/2)*n;
    return{x,y};
  }
  const center=toTile(lat,lng);
  const nx=Math.ceil(MW/TILE)+3,ny=Math.ceil(MH/TILE)+3;
  const stx=Math.floor(center.x)-Math.floor(nx/2);
  const sty=Math.floor(center.y)-Math.floor(ny/2);
  const tiles=[];
  for(let dy=0;dy<ny;dy++) for(let dx=0;dx<nx;dx++){
    const tx=stx+dx,ty=sty+dy;
    const px=(dx-Math.floor(nx/2))*TILE+MW/2+(Math.floor(center.x)-center.x)*TILE+off.x;
    const py=(dy-Math.floor(ny/2))*TILE+MH/2+(Math.floor(center.y)-center.y)*TILE+off.y;
    const safeX=((tx%Math.pow(2,zoom))+Math.pow(2,zoom))%Math.pow(2,zoom);
    const safeY=Math.max(0,Math.min(Math.pow(2,zoom)-1,ty));
    tiles.push({sx:safeX,ty:safeY,px,py});
  }
  // Solo OSM â€” nessun problema CORS
  function tileUrl(sx,ty){ return `https://tile.openstreetmap.org/${zoom}/${sx}/${ty}.png`; }

  function pxToLL(px,py){
    const rx=(px-MW/2-off.x)/TILE+center.x,ry=(py-MH/2-off.y)/TILE+center.y,n=Math.pow(2,zoom);
    return{
      lat:parseFloat(((Math.atan(Math.sinh(Math.PI*(1-(2*ry)/n)))*180)/Math.PI).toFixed(6)),
      lng:parseFloat(((rx/n)*360-180).toFixed(6))
    };
  }
  function onClick(e){if(dragging)return;const r=mapRef.current.getBoundingClientRect();const{lat:nl,lng:nlo}=pxToLL(e.clientX-r.left,e.clientY-r.top);setLat(nl);setLng(nlo);setOff({x:0,y:0});}
  const touch=useRef({});
  function onTouchStart(e){
    if(e.touches.length===1){ drag.current={x:e.touches[0].clientX,y:e.touches[0].clientY,ox:off.x,oy:off.y}; }
    else if(e.touches.length===2){
      const dx=e.touches[0].clientX-e.touches[1].clientX,dy=e.touches[0].clientY-e.touches[1].clientY;
      touch.current.pinchDist=Math.sqrt(dx*dx+dy*dy);touch.current.pinchZoom=zoom;
    }
  }
  function onTouchMove(e){
    e.preventDefault();
    if(e.touches.length===1&&drag.current){
      const dx=e.touches[0].clientX-drag.current.x,dy=e.touches[0].clientY-drag.current.y;
      if(Math.abs(dx)>3||Math.abs(dy)>3) setDragging(true);
      setOff({x:drag.current.ox+dx,y:drag.current.oy+dy});
    } else if(e.touches.length===2&&touch.current.pinchDist){
      const dx=e.touches[0].clientX-e.touches[1].clientX,dy=e.touches[0].clientY-e.touches[1].clientY;
      const dist=Math.sqrt(dx*dx+dy*dy);
      const ratio=dist/touch.current.pinchDist;
      const newZoom=Math.round(Math.max(3,Math.min(19,touch.current.pinchZoom+Math.log2(ratio))));
      if(newZoom!==zoom){setZoom(newZoom);setOff({x:0,y:0});}
    }
  }
  function onTouchEnd(){
    if(dragging){const{lat:nl,lng:nlo}=pxToLL(MW/2-off.x,MH/2-off.y);setLat(nl);setLng(nlo);setOff({x:0,y:0});}
    setTimeout(()=>setDragging(false),10);drag.current=null;touch.current={};
  }
  function onMD(e){drag.current={x:e.clientX,y:e.clientY,ox:off.x,oy:off.y};}
  function onMM(e){if(!drag.current)return;const dx=e.clientX-drag.current.x,dy=e.clientY-drag.current.y;if(Math.abs(dx)>3||Math.abs(dy)>3)setDragging(true);setOff({x:drag.current.ox+dx,y:drag.current.oy+dy});}
  function onMU(){if(dragging){const{lat:nl,lng:nlo}=pxToLL(MW/2-off.x,MH/2-off.y);setLat(nl);setLng(nlo);setOff({x:0,y:0});}setTimeout(()=>setDragging(false),10);drag.current=null;}
  function useGPS(){navigator.geolocation?.getCurrentPosition(p=>{setLat(+p.coords.latitude.toFixed(6));setLng(+p.coords.longitude.toFixed(6));setOff({x:0,y:0});},()=>alert("GPS non disponibile"));}

  // Ricerca con Nominatim â€” senza header User-Agent custom (browser non lo permette)
  async function doSearch(){
    if(!search.trim()) return;
    setSearching(true);setSuggestions([]);
    try{
      const url=`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(search)}&format=json&limit=6&countrycodes=it&accept-language=it`;
      const r=await fetch(url);
      const data=await r.json();
      setSuggestions(data);
    }catch(e){ alert("Ricerca non disponibile, inserisci le coordinate manualmente"); }
    setSearching(false);
  }
  function pickSuggestion(s){
    setLat(+parseFloat(s.lat).toFixed(6));setLng(+parseFloat(s.lon).toFixed(6));
    setOff({x:0,y:0});setSuggestions([]);setSearch(s.display_name.split(",")[0]);
  }

  return(
    <div style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.85)",zIndex:1000,display:"flex",alignItems:"center",justifyContent:"center",padding:12,overflowY:"auto"}}>
      <div style={{background:dark?"#1e293b":"white",borderRadius:20,overflow:"hidden",width:"100%",maxWidth:400,boxShadow:"0 30px 80px rgba(0,0,0,0.6)"}}>
        <div style={{background:"linear-gradient(135deg,#052e16,#166534)",padding:"12px 16px",display:"flex",justifyContent:"space-between",alignItems:"center"}}>
          <div>
            <h3 style={{color:"white",fontFamily:"Lora,serif",fontSize:16,margin:0}}>ğŸ“ Posizione oliveto</h3>
            <p style={{color:"#86efac",fontSize:11,margin:"2px 0 0"}}>Cerca Â· clicca Â· trascina Â· GPS</p>
          </div>
          <button onClick={onClose} style={{background:"rgba(255,255,255,0.2)",border:"none",color:"white",width:30,height:30,borderRadius:15,cursor:"pointer",fontSize:18}}>Ã—</button>
        </div>
        {/* Ricerca */}
        <div style={{padding:"10px 12px",background:dark?"#273549":"#f0fdf4",borderBottom:`1px solid ${dark?"#334155":"#d1fae5"}`,position:"relative"}}>
          <div style={{display:"flex",gap:8}}>
            <input value={search} onChange={e=>setSearch(e.target.value)} onKeyDown={e=>e.key==="Enter"&&doSearch()}
              placeholder="ğŸ” Cerca comune o indirizzo..."
              style={{flex:1,padding:"9px 12px",border:`1.5px solid ${dark?"#334155":"#86efac"}`,borderRadius:10,fontSize:13,outline:"none",background:dark?"#1e293b":"white",color:dark?"#e2e8f0":"#1a1a2e"}}/>
            <button onClick={doSearch} disabled={searching}
              style={{padding:"9px 14px",background:"#16a34a",color:"white",border:"none",borderRadius:10,cursor:"pointer",fontSize:13,fontWeight:700,flexShrink:0}}>
              {searching?<span className="spinner"/>:"Cerca"}
            </button>
          </div>
          {suggestions.length>0&&<div style={{position:"absolute",top:"100%",left:12,right:12,background:dark?"#1e293b":"white",borderRadius:10,boxShadow:"0 8px 24px rgba(0,0,0,0.2)",zIndex:50,overflow:"hidden",maxHeight:180,overflowY:"auto"}}>
            {suggestions.map((s,i)=><div key={i} onClick={()=>pickSuggestion(s)}
              style={{padding:"10px 14px",cursor:"pointer",borderBottom:`1px solid ${dark?"#334155":"#f3f4f6"}`,fontSize:13,color:dark?"#e2e8f0":"#1a1a2e"}}>
              ğŸ“ {s.display_name.split(",").slice(0,3).join(",")}
            </div>)}
          </div>}
        </div>
        {/* Mappa OSM */}
        <div ref={mapRef} style={{position:"relative",width:"100%",height:MH,overflow:"hidden",cursor:dragging?"grabbing":"crosshair",userSelect:"none",background:"#c8d8c8"}}
          onClick={onClick} onMouseDown={onMD} onMouseMove={onMM} onMouseUp={onMU} onMouseLeave={onMU}
          onTouchStart={onTouchStart} onTouchMove={onTouchMove} onTouchEnd={onTouchEnd}>
          {tiles.map((t,i)=>(
            <img key={i} src={tileUrl(t.sx,t.ty)}
              style={{position:"absolute",width:TILE,height:TILE,left:t.px,top:t.py,pointerEvents:"none"}}
              alt="" draggable={false}
              onError={e=>{e.target.style.opacity="0";}}/>
          ))}
          <div style={{position:"absolute",left:"50%",top:"50%",transform:"translate(-50%,-100%)",pointerEvents:"none",zIndex:10,fontSize:32,filter:"drop-shadow(0 2px 8px rgba(0,0,0,0.8))"}}>ğŸ“</div>
          <div style={{position:"absolute",bottom:8,left:8,background:"rgba(0,0,0,0.65)",color:"white",padding:"3px 8px",borderRadius:6,fontSize:11,fontFamily:"monospace",zIndex:10,pointerEvents:"none"}}>
            {lat.toFixed(5)}, {lng.toFixed(5)} Â· z{zoom}
          </div>
          <div style={{position:"absolute",top:8,right:8,display:"flex",flexDirection:"column",gap:4,zIndex:20}}>
            <button onClick={e=>{e.stopPropagation();setZoom(z=>Math.min(z+1,19));setOff({x:0,y:0});}}
              style={{width:32,height:32,background:"white",border:"none",borderRadius:8,cursor:"pointer",fontSize:20,fontWeight:700,boxShadow:"0 2px 8px rgba(0,0,0,0.35)",color:"#16a34a",display:"flex",alignItems:"center",justifyContent:"center"}}>+</button>
            <button onClick={e=>{e.stopPropagation();setZoom(z=>Math.max(z-1,3));setOff({x:0,y:0});}}
              style={{width:32,height:32,background:"white",border:"none",borderRadius:8,cursor:"pointer",fontSize:20,fontWeight:700,boxShadow:"0 2px 8px rgba(0,0,0,0.35)",color:"#16a34a",display:"flex",alignItems:"center",justifyContent:"center"}}>âˆ’</button>
          </div>
          <button onClick={e=>{e.stopPropagation();useGPS();}}
            style={{position:"absolute",bottom:8,right:8,background:"white",border:"none",borderRadius:8,padding:"6px 11px",cursor:"pointer",fontSize:12,fontWeight:700,boxShadow:"0 2px 8px rgba(0,0,0,0.35)",zIndex:20,color:"#16a34a"}}>
            ğŸ¯ GPS
          </button>
        </div>
        {/* Coordinate manuali */}
        <div style={{padding:"10px 12px",background:dark?"#1e293b":"#f8fafc",borderTop:`1px solid ${dark?"#334155":"#e5e7eb"}`,display:"flex",gap:8}}>
          {[["LAT",lat,setLat],["LNG",lng,setLng]].map(([lbl,val,fn])=>(
            <div key={lbl} style={{flex:1}}>
              <label style={{fontSize:10,fontWeight:700,color:dark?"#94a3b8":"#6b7280",display:"block",marginBottom:3}}>{lbl}</label>
              <input type="number" value={val} onChange={e=>{fn(+e.target.value);setOff({x:0,y:0});}} step="0.000001"
                style={{width:"100%",padding:"6px 8px",border:`1.5px solid ${dark?"#334155":"#d1fae5"}`,borderRadius:7,fontSize:12,outline:"none",boxSizing:"border-box",fontFamily:"monospace",background:dark?"#273549":"white",color:dark?"#e2e8f0":"#1a1a2e"}}/>
            </div>
          ))}
        </div>
        <div style={{padding:"8px 12px 14px"}}>
          <button onClick={()=>onConfirm(lat,lng)} className="btn-primary" style={{background:"#16a34a",marginBottom:0}}>âœ… Conferma posizione</button>
        </div>
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIELD INPUT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function FieldInput({label,value,onChange,type="text",placeholder="",dark,borderColor}){
  const bc=borderColor||(dark?"#2d4a2d":"#d1fae5");
  return(
    <div style={{marginBottom:14}}>
      <label style={{display:"block",fontSize:13,fontWeight:600,color:dark?"#94a3b8":"#374151",marginBottom:6}}>{label}</label>
      <input type={type} value={value} onChange={onChange} placeholder={placeholder}
        style={{width:"100%",padding:"10px 14px",border:`1.5px solid ${bc}`,borderRadius:10,fontSize:14,outline:"none",boxSizing:"border-box",background:dark?"#1e293b":"white",color:dark?"#e2e8f0":"#1a1a2e"}}/>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ADD CLIENTE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function AddCliente({onBack,onSave,dark}){
  const [f,setF]=useState({nome:"",telefono:"",email:"",note:""});
  const [saving,setSaving]=useState(false);
  const set=(k,v)=>setF(p=>({...p,[k]:v}));
  const grad=dark?"linear-gradient(135deg,#0f0c29,#1e1b4b)":"linear-gradient(135deg,#1e1b4b,#3730a3)";
  async function save(){
    if(!f.nome.trim()){alert("Inserisci il nome del cliente");return;}
    setSaving(true);
    await onSave(f);
    setSaving(false);
  }
  return(
    <div>
      <div style={{background:grad,padding:"20px 20px 28px"}}>
        <button onClick={onBack} style={{background:"rgba(255,255,255,0.2)",border:"none",color:"white",padding:"6px 14px",borderRadius:20,cursor:"pointer",marginBottom:14,fontSize:13}}>â† Indietro</button>
        <h2 style={{color:"white",fontFamily:"Lora,serif"}}>ğŸ‘¤ Nuovo cliente</h2>
        <p style={{color:"#a5b4fc",margin:"4px 0 0",fontSize:13}}>Aggiungi i dati del cliente</p>
      </div>
      <div style={{padding:16}}>
        <FieldInput label="Nome e cognome *" value={f.nome} onChange={e=>set("nome",e.target.value)} placeholder="Es. Mario Rossi" dark={dark} borderColor={dark?"#2d2b6b":"#c7d2fe"}/>
        <FieldInput label="Telefono" value={f.telefono} onChange={e=>set("telefono",e.target.value)} placeholder="Es. 333 1234567" type="tel" dark={dark} borderColor={dark?"#2d2b6b":"#c7d2fe"}/>
        <FieldInput label="Email" value={f.email} onChange={e=>set("email",e.target.value)} placeholder="mario@email.it" type="email" dark={dark} borderColor={dark?"#2d2b6b":"#c7d2fe"}/>
        <FieldInput label="Note" value={f.note} onChange={e=>set("note",e.target.value)} placeholder="Annotazioni..." dark={dark} borderColor={dark?"#2d2b6b":"#c7d2fe"}/>
        <button onClick={save} disabled={saving} className="btn-primary" style={{background:dark?"#2d2b6b":"#3730a3"}}>
          {saving?<span className="spinner"/>:"ğŸ’¾ Salva cliente"}
        </button>
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ADD OLIVETO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function AddOliveto({clienteId,clienteNome,onBack,onSave,dark}){
  const [f,setF]=useState({nome:"",comune:"",varieta:"",piante:"",ha:"",lat:"",lng:""});
  const [showMap,setShowMap]=useState(false);
  const [saving,setSaving]=useState(false);
  const set=(k,v)=>setF(p=>({...p,[k]:v}));
  const grad=dark?"linear-gradient(135deg,#051a08,#0a2e0a)":"linear-gradient(135deg,#052e16,#166534)";

  const mapModal=showMap?createPortal(
    <MapPicker
      initLat={f.lat?+f.lat:41.9}
      initLng={f.lng?+f.lng:12.5}
      onConfirm={(la,lo)=>{set("lat",la+"");set("lng",lo+"");setShowMap(false);}}
      onClose={()=>setShowMap(false)}
      dark={dark}
    />,document.body
  ):null;

  async function save(){
    if(!f.nome.trim()||!f.comune.trim()){alert("Nome oliveto e comune sono obbligatori");return;}
    setSaving(true);
    await onSave({...f,clienteId});
    setSaving(false);
  }

  return(<>
    {mapModal}
    <div>
      <div style={{background:grad,padding:"20px 20px 28px"}}>
        <button onClick={onBack} style={{background:"rgba(255,255,255,0.2)",border:"none",color:"white",padding:"6px 14px",borderRadius:20,cursor:"pointer",marginBottom:14,fontSize:13}}>â† Indietro</button>
        <h2 style={{color:"white",fontFamily:"Lora,serif"}}>ğŸ«’ Nuovo oliveto</h2>
        {clienteNome&&<p style={{color:"#86efac",margin:"4px 0 0",fontSize:13}}>Cliente: {clienteNome}</p>}
      </div>
      <div style={{padding:16}}>
        <FieldInput label="Nome oliveto *" value={f.nome} onChange={e=>set("nome",e.target.value)} placeholder="Es. Oliveto Collina" dark={dark}/>
        <FieldInput label="Comune / LocalitÃ  *" value={f.comune} onChange={e=>set("comune",e.target.value)} placeholder="Es. Imperia" dark={dark}/>
        <FieldInput label="VarietÃ " value={f.varieta} onChange={e=>set("varieta",e.target.value)} placeholder="Es. Taggiasca" dark={dark}/>
        <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12,marginBottom:4}}>
          <FieldInput label="NÂ° piante" value={f.piante} onChange={e=>set("piante",e.target.value)} type="number" placeholder="Es. 320" dark={dark}/>
          <FieldInput label="Ettari" value={f.ha} onChange={e=>set("ha",e.target.value)} type="number" placeholder="Es. 2.5" dark={dark}/>
        </div>
        <label style={{display:"block",fontSize:13,fontWeight:600,color:dark?"#94a3b8":"#374151",marginBottom:8}}>Coordinate GPS (opzionale)</label>
        {f.lat&&f.lng?(
          <div style={{background:dark?"#1e3a1e":"#f0fdf4",border:"1.5px solid #86efac",borderRadius:12,padding:14,display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:14}}>
            <div>
              <div style={{fontSize:13,color:"#4ade80",fontWeight:600}}>ğŸ“ Posizione impostata</div>
              <div style={{fontSize:12,color:dark?"#94a3b8":"#6b7280",fontFamily:"monospace"}}>{f.lat}, {f.lng}</div>
            </div>
            <button onClick={()=>setShowMap(true)} style={{background:"#16a34a",color:"white",border:"none",borderRadius:8,padding:"6px 12px",cursor:"pointer",fontSize:12,fontWeight:700}}>âœï¸ Modifica</button>
          </div>
        ):(
          <button onClick={()=>setShowMap(true)} className="btn-primary" style={{background:dark?"#051505":"#052e16",display:"flex",alignItems:"center",justifyContent:"center",gap:8}}>ğŸ—ºï¸ Apri mappa</button>
        )}
        <button onClick={save} disabled={saving} className="btn-primary" style={{background:"#16a34a"}}>
          {saving?<span className="spinner"/>:"ğŸ’¾ Salva oliveto"}
        </button>
      </div>
    </div>
  </>);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ADD TRATTAMENTO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function AddTrattamento({oliveto,onBack,onSave,dark}){
  const [f,setF]=useState({data:new Date().toISOString().slice(0,10),prodotto:"",dose:"",note:""});
  const [saving,setSaving]=useState(false);
  const set=(k,v)=>setF(p=>({...p,[k]:v}));
  const grad=dark?"linear-gradient(135deg,#051a08,#0a2e0a)":"linear-gradient(135deg,#052e16,#166534)";
  async function save(){
    if(!f.prodotto){alert("Inserisci il prodotto");return;}
    setSaving(true);
    await onSave({...f,oId:oliveto.id});
    setSaving(false);
  }
  return(
    <div>
      <div style={{background:grad,padding:"20px 20px 28px"}}>
        <button onClick={onBack} style={{background:"rgba(255,255,255,0.2)",border:"none",color:"white",padding:"6px 14px",borderRadius:20,cursor:"pointer",marginBottom:14,fontSize:13}}>â† Indietro</button>
        <h2 style={{color:"white",fontFamily:"Lora,serif"}}>ğŸ’Š Nuovo trattamento</h2>
        <p style={{color:"#86efac",margin:"4px 0 0",fontSize:13}}>{oliveto.nome}</p>
      </div>
      <div style={{padding:16}}>
        {[["data","Data","date"],["prodotto","Prodotto *","text"],["dose","Dose","text"],["note","Note","text"]].map(([k,lbl,type])=>(
          <FieldInput key={k} label={lbl} value={f[k]} onChange={e=>set(k,e.target.value)} type={type} dark={dark}/>
        ))}
        <button onClick={save} disabled={saving} className="btn-primary" style={{background:"#16a34a"}}>
          {saving?<span className="spinner"/>:"ğŸ’¾ Salva trattamento"}
        </button>
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ADD RILEVAMENTO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function AddRilevamento({oliveti,traps,clienteId,preOId,onBack,onSave,dark}){
  const [oId,setOId]=useState(preOId||"");
  const [trapId,setTrapId]=useState("");
  const [f,setF]=useState({data:new Date().toISOString().slice(0,10),mosche:"",meteo:"",fase:""});
  const [saving,setSaving]=useState(false);
  const set=(k,v)=>setF(p=>({...p,[k]:v}));
  const myOl=clienteId?oliveti.filter(o=>o.cliente_id===clienteId):oliveti;
  const myTraps=(traps||[]).filter(t=>(t.oliveto_id||t.oId)===oId&&t.attiva);
  const m=parseInt(f.mosche)||0;
  const selStyle={width:"100%",padding:"10px 14px",border:`1.5px solid ${dark?"#2d2b6b":"#ddd5fe"}`,borderRadius:10,fontSize:14,outline:"none",background:dark?"#1e293b":"white",color:dark?"#e2e8f0":"#1a1a2e",marginBottom:14};
  const grad=dark?"linear-gradient(135deg,#080614,#110e2e)":"linear-gradient(135deg,#1e1b4b,#3730a3)";

  async function save(){
    if(!oId||!trapId||!f.mosche){alert("Seleziona oliveto, trappola e inserisci nÂ° mosche");return;}
    setSaving(true);
    await onSave({...f,mosche:m,oId,trapId});
    setSaving(false);
  }
  return(
    <div>
      <div style={{background:grad,padding:"20px 20px 28px"}}>
        <button onClick={onBack} style={{background:"rgba(255,255,255,0.2)",border:"none",color:"white",padding:"6px 14px",borderRadius:20,cursor:"pointer",marginBottom:14,fontSize:13}}>â† Indietro</button>
        <h2 style={{color:"white",fontFamily:"Lora,serif"}}>ğŸª¤ Nuovo monitoraggio</h2>
      </div>
      <div style={{padding:16}}>
        {!preOId&&<>
          <label style={{display:"block",fontSize:13,fontWeight:600,color:dark?"#94a3b8":"#374151",marginBottom:6}}>Oliveto *</label>
          <select value={oId} onChange={e=>{setOId(e.target.value);setTrapId("");}} style={selStyle}>
            <option value="">â€” seleziona â€”</option>
            {myOl.map(o=><option key={o.id} value={o.id}>{o.nome} ({o.comune||o.loc||""})</option>)}
          </select>
        </>}
        <label style={{display:"block",fontSize:13,fontWeight:600,color:dark?"#94a3b8":"#374151",marginBottom:6}}>Trappola *</label>
        {oId&&myTraps.length===0?(
          <div style={{background:"rgba(220,38,38,0.1)",border:"1.5px solid #dc2626",borderRadius:10,padding:"10px 14px",fontSize:13,color:"#dc2626",marginBottom:14}}>
            âš ï¸ Nessuna trappola attiva per questo oliveto. Aggiungila dalla scheda oliveto.
          </div>
        ):(
          <select value={trapId} onChange={e=>setTrapId(e.target.value)} disabled={!oId} style={{...selStyle,opacity:!oId?0.5:1}}>
            <option value="">â€” seleziona trappola â€”</option>
            {myTraps.map(t=><option key={t.id} value={t.id}>{t.nome} ({t.tipo})</option>)}
          </select>
        )}
        <FieldInput label="Data *" value={f.data} onChange={e=>set("data",e.target.value)} type="date" dark={dark} borderColor={dark?"#2d2b6b":"#ddd5fe"}/>
        <FieldInput label="Mosche catturate *" value={f.mosche} onChange={e=>set("mosche",e.target.value)} type="number" placeholder="Es. 25" dark={dark} borderColor={dark?"#2d2b6b":"#ddd5fe"}/>
        {[["meteo","Meteo",["Soleggiato","Nuvoloso","Variabile","Caldo umido","Fresco","Piovoso"]],
          ["fase","Fase fenologica",["Allegagione","Ingrossamento frutto","Indurimento nocciolo","Invaiatura","Maturazione","Raccolta"]]
        ].map(([k,lbl,opts])=>(
          <div key={k} style={{marginBottom:14}}>
            <label style={{display:"block",fontSize:13,fontWeight:600,color:dark?"#94a3b8":"#374151",marginBottom:6}}>{lbl}</label>
            <select value={f[k]} onChange={e=>set(k,e.target.value)} style={selStyle}>
              <option value="">â€” seleziona â€”</option>
              {opts.map(o=><option key={o} value={o}>{o}</option>)}
            </select>
          </div>
        ))}
        {m>=SA&&<div style={{background:m>=SP?"rgba(220,38,38,0.1)":"rgba(217,119,6,0.1)",border:`1.5px solid ${m>=SP?"#dc2626":"#d97706"}`,borderRadius:12,padding:12,marginBottom:14}}>
          <strong style={{color:m>=SP?"#dc2626":"#d97706"}}>{m>=SP?"ğŸš¨ Soglia PERICOLO superata!":"âš ï¸ Soglia ALLERTA superata!"}</strong>
        </div>}
        <button onClick={save} disabled={saving} className="btn-primary" style={{background:dark?"#2d2b6b":"#3730a3"}}>
          {saving?<span className="spinner"/>:"ğŸ’¾ Salva monitoraggio"}
        </button>
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ADD STEREOSCOPIO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function AddStereoscopio({oliveti,clienteId,preOId,onBack,onSave,dark}){
  const [oId,setOId]=useState(preOId||"");
  const [f,setF]=useState({data:new Date().toISOString().slice(0,10),camp:"",uova:"",l1:"",l2:"",l3:"",pupe:"",fori:""});
  const [saving,setSaving]=useState(false);
  const set=(k,v)=>setF(p=>({...p,[k]:v}));
  const n=k=>parseInt(f[k])||0;
  const camp=n("camp"),uova=n("uova"),l1=n("l1"),l2=n("l2"),l3=n("l3"),pupe=n("pupe"),fori=n("fori");
  const att=camp>0?Math.min(((uova+l1+l2)/camp)*100,100):0;
  const tot=camp>0?Math.min(((uova+l1+l2+l3+pupe+fori)/camp)*100,100):0;
  const myOl=clienteId?oliveti.filter(o=>o.cliente_id===clienteId):oliveti;
  const selStyle={width:"100%",padding:"10px 14px",border:`1.5px solid ${dark?"#2d2b6b":"#ddd5fe"}`,borderRadius:10,fontSize:14,outline:"none",background:dark?"#1e293b":"white",color:dark?"#e2e8f0":"#1a1a2e",marginBottom:14};
  const cardBg=dark?"#1e293b":"white";
  const stadi=[["uova","ğŸ¥š Uova","#f59e0b",true],["l1","L1","#10b981",true],["l2","L2","#059669",true],["l3","L3","#047857",false],["pupe","ğŸ«˜ Pupe","#7c3aed",false],["fori","ğŸ•³ï¸ Fori","#6b7280",false]];
  const grad=dark?"linear-gradient(135deg,#080614,#110e2e)":"linear-gradient(135deg,#1e1b4b,#3730a3)";

  async function save(){
    if(!oId||!f.camp){alert("Seleziona oliveto e inserisci nÂ° campioni");return;}
    setSaving(true);
    await onSave({data:f.data,camp,uova,l1,l2,l3,pupe,fori,oId,stagione:new Date(f.data).getFullYear()});
    setSaving(false);
  }
  return(
    <div>
      <div style={{background:grad,padding:"20px 20px 28px"}}>
        <button onClick={onBack} style={{background:"rgba(255,255,255,0.2)",border:"none",color:"white",padding:"6px 14px",borderRadius:20,cursor:"pointer",marginBottom:14,fontSize:13}}>â† Indietro</button>
        <h2 style={{color:"white",fontFamily:"Lora,serif"}}>ğŸ”¬ Campionamento stereoscopio</h2>
      </div>
      <div style={{padding:16}}>
        {!preOId&&<>
          <label style={{display:"block",fontSize:13,fontWeight:600,color:dark?"#94a3b8":"#374151",marginBottom:6}}>Oliveto *</label>
          <select value={oId} onChange={e=>setOId(e.target.value)} style={selStyle}>
            <option value="">â€” seleziona â€”</option>
            {myOl.map(o=><option key={o.id} value={o.id}>{o.nome} ({o.comune||o.loc||""})</option>)}
          </select>
        </>}
        <FieldInput label="Data *" value={f.data} onChange={e=>set("data",e.target.value)} type="date" dark={dark} borderColor={dark?"#2d2b6b":"#ddd5fe"}/>
        <FieldInput label="NÂ° olive campionate *" value={f.camp} onChange={e=>set("camp",e.target.value)} type="number" dark={dark} borderColor={dark?"#2d2b6b":"#ddd5ve"}/>
        <div style={{background:cardBg,borderRadius:16,padding:16,marginBottom:16,boxShadow:dark?"0 2px 10px rgba(0,0,0,0.3)":"0 2px 10px rgba(0,0,0,0.07)"}}>
          <h4 style={{margin:"0 0 14px",fontFamily:"Lora,serif",fontSize:15}}>Stadi rilevati (nÂ° olive)</h4>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12}}>
            {stadi.map(([k,lbl,color,isAtt])=>(
              <div key={k}>
                <label style={{display:"block",fontSize:11,fontWeight:700,color,marginBottom:5}}>
                  {lbl} {isAtt&&<span style={{background:"rgba(253,224,71,0.2)",color:"#d97706",padding:"1px 5px",borderRadius:4,fontSize:9,fontWeight:700}}>ATTIVA</span>}
                </label>
                <input type="number" min="0" value={f[k]} onChange={e=>set(k,e.target.value)}
                  style={{width:"100%",padding:"9px",border:`1.5px solid ${color}40`,borderRadius:10,fontSize:18,fontWeight:700,outline:"none",boxSizing:"border-box",textAlign:"center",color,background:dark?"#273549":"white"}}/>
              </div>
            ))}
          </div>
        </div>
        {camp>0&&<div style={{background:cardBg,borderRadius:16,padding:16,marginBottom:16,boxShadow:dark?"0 2px 10px rgba(0,0,0,0.3)":"0 2px 10px rgba(0,0,0,0.07)"}}>
          <h4 style={{margin:"0 0 12px",fontFamily:"Lora,serif",fontSize:14}}>ğŸ“Š Anteprima</h4>
          <InfBar label="Inf. ATTIVA (Uova+L1+L2)" value={att} color={cInf(att)}/>
          <InfBar label="Inf. TOTALE (tutti gli stadi)" value={tot} color={tot>20?"#dc2626":tot>10?"#d97706":"#7c3aed"}/>
        </div>}
        <button onClick={save} disabled={saving} className="btn-primary" style={{background:dark?"#2d2b6b":"#3730a3"}}>
          {saving?<span className="spinner"/>:"ğŸ’¾ Salva campionamento"}
        </button>
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SOGLIE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function Soglie({onBack,dark}){
  const [s1,setS1]=useState(SA),[s2,setS2]=useState(SP);
  const [i1,setI1]=useState(IA),[i2,setI2]=useState(IP);
  const [ok,setOk]=useState(false);
  function save(){SA=+s1;SP=+s2;IA=+i1;IP=+i2;setOk(true);setTimeout(()=>setOk(false),2000);}
  const cardBg=dark?"#1e293b":"white";
  const grad=dark?"linear-gradient(135deg,#080614,#110e2e)":"linear-gradient(135deg,#1e1b4b,#3730a3)";
  const mutedC=dark?"#94a3b8":"#6b7280";
  return(
    <div>
      <div style={{background:grad,padding:"20px 20px 28px"}}>
        <button onClick={onBack} style={{background:"rgba(255,255,255,0.2)",border:"none",color:"white",padding:"6px 14px",borderRadius:20,cursor:"pointer",marginBottom:14,fontSize:13}}>â† Indietro</button>
        <h2 style={{color:"white",fontFamily:"Lora,serif"}}>âš™ï¸ Soglie di allerta</h2>
      </div>
      <div style={{padding:16}}>
        <div style={{background:cardBg,borderRadius:16,padding:20,boxShadow:dark?"0 2px 10px rgba(0,0,0,0.3)":"0 2px 10px rgba(0,0,0,0.07)",marginBottom:16}}>
          <h4 style={{fontFamily:"Lora,serif",fontSize:15,margin:"0 0 14px"}}>ğŸª¤ Soglie mosche (nÂ°)</h4>
          {[["âš ï¸ Allerta","#d97706",s1,setS1],["ğŸš¨ Pericolo","#dc2626",s2,setS2]].map(([lbl,color,val,fn])=>(
            <div key={lbl} style={{marginBottom:16}}>
              <label style={{display:"block",fontSize:13,fontWeight:600,marginBottom:6,color}}>{lbl}</label>
              <input type="number" value={val} onChange={e=>fn(e.target.value)}
                style={{width:"100%",padding:"11px 14px",border:`1.5px solid ${color}60`,borderRadius:10,fontSize:20,fontWeight:700,outline:"none",boxSizing:"border-box",background:dark?"#273549":"white",color:dark?"#e2e8f0":"#1a1a2e"}}/>
            </div>
          ))}
        </div>
        <div style={{background:cardBg,borderRadius:16,padding:20,boxShadow:dark?"0 2px 10px rgba(0,0,0,0.3)":"0 2px 10px rgba(0,0,0,0.07)",marginBottom:16}}>
          <h4 style={{fontFamily:"Lora,serif",fontSize:15,margin:"0 0 14px"}}>ğŸ”¬ Soglie infestazione (%)</h4>
          {[["âš ï¸ Allerta %","#d97706",i1,setI1],["ğŸš¨ Pericolo %","#dc2626",i2,setI2]].map(([lbl,color,val,fn])=>(
            <div key={lbl} style={{marginBottom:16}}>
              <label style={{display:"block",fontSize:13,fontWeight:600,marginBottom:6,color}}>{lbl}</label>
              <input type="number" value={val} onChange={e=>fn(e.target.value)}
                style={{width:"100%",padding:"11px 14px",border:`1.5px solid ${color}60`,borderRadius:10,fontSize:20,fontWeight:700,outline:"none",boxSizing:"border-box",background:dark?"#273549":"white",color:dark?"#e2e8f0":"#1a1a2e"}}/>
            </div>
          ))}
          <p style={{fontSize:11,color:mutedC,margin:0}}>Basato sull'infestazione ATTIVA (Uova+L1+L2)</p>
        </div>
        <button onClick={save} className="btn-primary" style={{background:ok?"#16a34a":(dark?"#2d2b6b":"#3730a3"),transition:"background 0.3s",marginBottom:0}}>
          {ok?"âœ… Salvato!":"ğŸ’¾ Salva soglie"}
        </button>
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function Export({oliveti,clienti,rils,sters,trats,onBack,dark}){
  const cardBg=dark?"#1e293b":"white";
  const grad=dark?"linear-gradient(135deg,#080614,#110e2e)":"linear-gradient(135deg,#1e1b4b,#3730a3)";
  const mutedC=dark?"#94a3b8":"#6b7280";
  const [selCliente,setSelCliente]=useState("");
  const selStyle={width:"100%",padding:"10px 14px",border:`1.5px solid ${dark?"#334155":"#d1fae5"}`,borderRadius:10,fontSize:13,outline:"none",background:dark?"#1e293b":"white",color:dark?"#e2e8f0":"#1a1a2e",marginBottom:14};

  function dl(rows,name){
    const csv=rows.map(r=>r.map(v=>'"'+(v||"")+'"').join(",")).join("\n");
    const a=document.createElement("a");a.href=URL.createObjectURL(new Blob(["\uFEFF"+csv],{type:"text/csv;charset=utf-8"}));a.download=name;a.click();
  }
  function myOl(){ return selCliente?oliveti.filter(o=>o.cliente_id===selCliente):oliveti; }
  function filterByOl(items){ const ids=myOl().map(o=>o.id); return items.filter(x=>ids.includes(x.oliveto_id)||ids.includes(x.oId)); }

  function expRil(){
    const rows=[["Cliente","Oliveto","Data","Mosche","Trappola","Meteo","Fase","Rischio"]];
    filterByOl(rils).forEach(r=>{
      const o=oliveti.find(x=>x.id===r.oliveto_id||x.id===r.oId);
      const c=clienti.find(x=>x.id===o?.cliente_id);
      rows.push([c?.nome||"",o?.nome||"",r.data,r.mosche,r.trappola||"",r.meteo||"",r.fase||"",rischio(r.mosche).l]);
    });
    dl(rows,"olivetrack_monitoraggi.csv");
  }
  function expSter(){
    const rows=[["Cliente","Oliveto","Data","Campione","Uova","L1","L2","L3","Pupe","Fori","Att%","Tot%"]];
    filterByOl(sters).forEach(s=>{
      const o=oliveti.find(x=>x.id===s.oliveto_id||x.id===s.oId);
      const c=clienti.find(x=>x.id===o?.cliente_id);
      const i=calcInf(s);
      if(i) rows.push([c?.nome||"",o?.nome||"",s.data,s.camp,s.uova,s.l1,s.l2,s.l3,s.pupe,s.fori,i.att.toFixed(1),i.tot.toFixed(1)]);
    });
    dl(rows,"olivetrack_campionamenti.csv");
  }

  function stampaPDF(){
    const c=selCliente?clienti.find(x=>x.id===selCliente):null;
    const ol=myOl();
    const myRils=filterByOl(rils);
    const mySters=filterByOl(sters);
    const now=new Date().toLocaleDateString("it-IT");
    let html=`<!DOCTYPE html><html><head><meta charset="utf-8"><title>OliveTrack â€” Report</title>
      <style>body{font-family:Georgia,serif;color:#1a1a2e;max-width:800px;margin:0 auto;padding:20px}
      h1{color:#052e16;border-bottom:3px solid #052e16;padding-bottom:8px}h2{color:#166534;margin-top:24px}
      h3{color:#374151;margin-top:16px;font-size:15px}table{width:100%;border-collapse:collapse;font-size:12px;margin-top:8px}
      th{background:#052e16;color:white;padding:6px 8px;text-align:left}td{padding:5px 8px;border-bottom:1px solid #e5e7eb}
      tr:nth-child(even){background:#f9fafb}.tag{display:inline-block;padding:2px 8px;border-radius:10px;font-size:11px;font-weight:bold}
      .ok{background:#d1fae5;color:#065f46}.alert{background:#fee2e2;color:#991b1b}.warn{background:#fef3c7;color:#92400e}
      .footer{margin-top:32px;font-size:11px;color:#9ca3af;border-top:1px solid #e5e7eb;padding-top:8px}
      @media print{body{padding:10px}}</style></head><body>
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px">
        <span style="font-size:36px">ğŸ«’</span>
        <div><h1 style="margin:0;border:none;font-size:24px">OliveTrack</h1>
        <p style="margin:0;color:#6b7280;font-size:13px">Report generato il ${now}${c?" Â· "+c.nome:""}</p></div>
      </div>`;
    ol.forEach(o=>{
      const cc=clienti.find(x=>x.id===o.cliente_id);
      const oRils=myRils.filter(r=>r.oliveto_id===o.id||r.oId===o.id).sort((a,b)=>b.data.localeCompare(a.data));
      const oSters=mySters.filter(s=>s.oliveto_id===o.id||s.oId===o.id).sort((a,b)=>b.data.localeCompare(a.data));
      const lr=oRils[0]; const ls=oSters[0];
      const rv=lr?rischio(lr.mosche):{l:"Nessun dato"};
      const inf=ls?calcInf(ls):null;
      html+=`<h2>ğŸ«’ ${o.nome}</h2>
        <p style="color:#6b7280;font-size:13px;margin:4px 0">${[o.comune,o.varieta,o.piante?o.piante+" piante":null,o.ha?o.ha+" ha":null,cc&&!selCliente?"ğŸ‘¤ "+cc.nome:null].filter(Boolean).join(" Â· ")}</p>
        <p>Rischio: <span class="tag ${rv.l==="OK"?"ok":rv.l.includes("ALLERTA")?"warn":"alert"}">${rv.l}</span>
        ${inf?` &nbsp; Infestazione attiva: <span class="tag ${inf.att>=IP?"alert":inf.att>=IA?"warn":"ok"}">${inf.att.toFixed(1)}%</span>`:""}</p>`;
      if(oRils.length){
        html+=`<h3>Monitoraggi</h3><table><tr><th>Data</th><th>Mosche</th><th>Trappola</th><th>Meteo</th><th>Fase</th><th>Rischio</th></tr>`;
        oRils.forEach(r=>{const rv2=rischio(r.mosche);html+=`<tr><td>${r.data}</td><td>${r.mosche}</td><td>${r.trappola||"â€”"}</td><td>${r.meteo||"â€”"}</td><td>${r.fase||"â€”"}</td><td><span class="tag ${rv2.l==="OK"?"ok":rv2.l.includes("ALLERTA")?"warn":"alert"}">${rv2.l}</span></td></tr>`;});
        html+=`</table>`;
      }
      if(oSters.length){
        html+=`<h3>Campionamenti</h3><table><tr><th>Data</th><th>Olive</th><th>Uova</th><th>L1</th><th>L2</th><th>L3</th><th>Pupe</th><th>Fori</th><th>Att%</th><th>Tot%</th></tr>`;
        oSters.forEach(s=>{const i=calcInf(s);html+=`<tr><td>${s.data}</td><td>${s.camp}</td><td>${s.uova}</td><td>${s.l1}</td><td>${s.l2}</td><td>${s.l3}</td><td>${s.pupe}</td><td>${s.fori}</td><td>${i.att.toFixed(1)}%</td><td>${i.tot.toFixed(1)}%</td></tr>`;});
        html+=`</table>`;
      }
    });
    html+=`<div class="footer">OliveTrack â€” Monitoraggio Mosca delle Olive</div></body></html>`;
    const w=window.open("","_blank"); w.document.write(html); w.document.close(); setTimeout(()=>w.print(),500);
  }

  const statCl=selCliente?1:clienti.length;
  const statOl=myOl().length;
  const statRil=filterByOl(rils).length;
  const statSter=filterByOl(sters).length;

  return(
    <div>
      <div style={{background:grad,padding:"20px 20px 28px"}}>
        <button onClick={onBack} style={{background:"rgba(255,255,255,0.2)",border:"none",color:"white",padding:"6px 14px",borderRadius:20,cursor:"pointer",marginBottom:14,fontSize:13}}>â† Indietro</button>
        <h2 style={{color:"white",fontFamily:"Lora,serif"}}>ğŸ“Š Export dati</h2>
      </div>
      <div style={{padding:16}}>
        <label style={{display:"block",fontSize:13,fontWeight:600,color:mutedC,marginBottom:6}}>Filtra per cliente</label>
        <select value={selCliente} onChange={e=>setSelCliente(e.target.value)} style={selStyle}>
          <option value="">Tutti i clienti</option>
          {clienti.map(c=><option key={c.id} value={c.id}>{c.nome}</option>)}
        </select>
        <div style={{background:cardBg,borderRadius:16,padding:18,marginBottom:14}}>
          {[["ğŸ‘¥ Clienti",statCl],["ğŸ«’ Oliveti",statOl],["ğŸª¤ Monitoraggi",statRil],["ğŸ”¬ Campionamenti",statSter]].map(([l,v])=>(
            <div key={l} style={{display:"flex",justifyContent:"space-between",padding:"7px 0",borderBottom:`1px solid ${dark?"#334155":"#f3f4f6"}`,fontSize:14}}>
              <span>{l}</span><strong>{v}</strong>
            </div>
          ))}
        </div>
        <button onClick={stampaPDF} className="btn-primary" style={{background:"#dc2626"}}>ğŸ“„ Stampa / Salva PDF</button>
        <button onClick={expRil} className="btn-primary" style={{background:"#16a34a"}}>ğŸ“¥ CSV Monitoraggi</button>
        <button onClick={expSter} className="btn-primary" style={{background:dark?"#2d2b6b":"#3730a3"}}>ğŸ“¥ CSV Campionamenti</button>
      </div>
    </div>
  );
}
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// OLIVETO DETAIL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FOTO OLIVETO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function FotoOliveto({oliveto,dark,cardBg,mutedC}){
  const [foto,setFoto]=useState([]);
  const [loading,setLoading]=useState(true);
  const [uploading,setUploading]=useState(false);
  const [preview,setPreview]=useState(null);
  const inputRef=React.useRef(null);

  useEffect(()=>{ loadFoto(); },[oliveto.id]);

  async function loadFoto(){
    setLoading(true);
    const{data}=await sb.from("foto_oliveto").select("*").eq("oliveto_id",oliveto.id).order("created_at",{ascending:false});
    setFoto(data||[]);
    setLoading(false);
  }

  async function upload(e){
    const file=e.target.files[0];
    if(!file) return;
    if(file.size>5*1024*1024){ alert("File troppo grande (max 5MB)"); return; }
    setUploading(true);
    const ext=file.name.split(".").pop();
    const path=`${oliveto.id}/${Date.now()}.${ext}`;
    const{error:upErr}=await sb.storage.from("olive-foto").upload(path,file,{contentType:file.type});
    if(upErr){ alert("Errore upload: "+upErr.message); setUploading(false); return; }
    const{data:{publicUrl}}=sb.storage.from("olive-foto").getPublicUrl(path);
    const{data,error}=await sb.from("foto_oliveto").insert({oliveto_id:oliveto.id,url:publicUrl,path,nome:file.name,data:new Date().toISOString().slice(0,10)}).select().single();
    if(error){ alert("Errore salvataggio: "+error.message); }
    else if(data) setFoto(p=>[data,...p]);
    setUploading(false);
    e.target.value="";
  }

  async function deleteFoto(f){
    if(!confirm("Eliminare questa foto?")) return;
    await sb.storage.from("olive-foto").remove([f.path]);
    await sb.from("foto_oliveto").delete().eq("id",f.id);
    setFoto(p=>p.filter(x=>x.id!==f.id));
  }

  return(
    <div>
      <input ref={inputRef} type="file" accept="image/*" capture="environment" onChange={upload} style={{display:"none"}}/>
      <div style={{display:"flex",gap:10,marginBottom:16}}>
        <button onClick={()=>inputRef.current.click()} disabled={uploading}
          style={{flex:1,padding:12,background:"#16a34a",color:"white",border:"none",borderRadius:12,fontSize:13,fontWeight:700,cursor:"pointer"}}>
          {uploading?<span className="spinner"/>:"ğŸ“· Scatta / Carica foto"}
        </button>
      </div>
      {loading?<p style={{textAlign:"center",color:mutedC}}>Caricamento...</p>:
        foto.length===0?<p style={{textAlign:"center",color:mutedC,padding:20}}>Nessuna foto ancora</p>:
        <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10}}>
          {foto.map(f=>(
            <div key={f.id} style={{position:"relative",borderRadius:12,overflow:"hidden",aspectRatio:"1",background:dark?"#273549":"#f3f4f6"}}>
              <img src={f.url} alt={f.nome} style={{width:"100%",height:"100%",objectFit:"cover",cursor:"pointer"}} onClick={()=>setPreview(f.url)}/>
              <div style={{position:"absolute",bottom:0,left:0,right:0,background:"rgba(0,0,0,0.55)",padding:"4px 8px",display:"flex",justifyContent:"space-between",alignItems:"center"}}>
                <span style={{color:"white",fontSize:10}}>{f.data}</span>
                <button onClick={()=>deleteFoto(f)} style={{background:"none",border:"none",color:"#fca5a5",cursor:"pointer",fontSize:14,padding:0}}>ğŸ—‘</button>
              </div>
            </div>
          ))}
        </div>
      }
      {preview&&createPortal(
        <div onClick={()=>setPreview(null)} style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.9)",zIndex:3000,display:"flex",alignItems:"center",justifyContent:"center",padding:16}}>
          <img src={preview} style={{maxWidth:"100%",maxHeight:"90vh",borderRadius:12,objectFit:"contain"}}/>
          <button onClick={()=>setPreview(null)} style={{position:"absolute",top:20,right:20,background:"rgba(255,255,255,0.2)",border:"none",color:"white",width:36,height:36,borderRadius:18,fontSize:20,cursor:"pointer"}}>Ã—</button>
        </div>, document.body
      )}
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NOTE OLIVETO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function NoteOliveto({oliveto,cliente,dark,cardBg,mutedC,selectedYear}){
  const [note,setNote]=useState([]);
  const [loading,setLoading]=useState(true);
  const [showForm,setShowForm]=useState(false);
  const [f,setF]=useState({data:new Date().toISOString().slice(0,10),testo:""});
  const [saving,setSaving]=useState(false);

  useEffect(()=>{ load(); },[oliveto.id]);
  const noteFiltrate = note.filter(n => new Date(n.data).getFullYear() === selectedYear);

  async function load(){
    setLoading(true);
    const{data}=await sb.from("note_oliveto").select("*").eq("oliveto_id",oliveto.id).order("data",{ascending:false});
    setNote(data||[]);
    setLoading(false);
  }

  async function save(){
    if(!f.testo.trim()){alert("Inserisci il testo della nota");return;}
    setSaving(true);
    const{data,error}=await sb.from("note_oliveto").insert({oliveto_id:oliveto.id,data:f.data,testo:f.testo.trim()}).select().single();
    if(error){alert("Errore: "+error.message);setSaving(false);return;}
    setNote(p=>[data,...p]);

    // --- INIZIO NUOVO CODICE WHATSAPP ---
    if (cliente && cliente.telefono) {
      if (confirm("Nota salvata! Vuoi inviarla su WhatsApp al cliente?")) {
        inviaWhatsApp(cliente, 'nota', f, oliveto.nome);
      }
    }
    // --- FINE NUOVO CODICE WHATSAPP ---

    setF({data:new Date().toISOString().slice(0,10),testo:""});
    setShowForm(false);
    setSaving(false);
  }

  async function remove(id){
    if(!confirm("Eliminare questa nota?")) return;
    await sb.from("note_oliveto").delete().eq("id",id);
    setNote(p=>p.filter(n=>n.id!==id));
  }

  const inp={width:"100%",padding:"10px 14px",border:`1.5px solid ${dark?"#334155":"#d1fae5"}`,borderRadius:10,fontSize:14,outline:"none",boxSizing:"border-box",background:dark?"#1e293b":"white",color:dark?"#e2e8f0":"#1a1a2e",marginBottom:12};

  return(
    <div>
      {loading?<p style={{textAlign:"center",color:mutedC,padding:20}}>Caricamento...</p>:<>
        {showForm?(
          <div style={{background:cardBg,borderRadius:16,padding:16,marginBottom:14,boxShadow:dark?"0 2px 10px rgba(0,0,0,0.3)":"0 2px 10px rgba(0,0,0,0.07)"}}>
            <h4 style={{fontFamily:"Lora,serif",fontSize:15,margin:"0 0 14px"}}>ğŸ“ Nuova nota</h4>
            <label style={{display:"block",fontSize:13,fontWeight:600,color:dark?"#94a3b8":"#374151",marginBottom:6}}>Data</label>
            <input type="date" value={f.data} onChange={e=>setF(p=>({...p,data:e.target.value}))} style={inp}/>
            <label style={{display:"block",fontSize:13,fontWeight:600,color:dark?"#94a3b8":"#374151",marginBottom:6}}>Nota *</label>
            <textarea value={f.testo} onChange={e=>setF(p=>({...p,testo:e.target.value}))} placeholder="Scrivi una nota..." rows={4}
              style={{...inp,resize:"vertical",fontFamily:"inherit",lineHeight:1.5}}/>
            <div style={{display:"flex",gap:10}}>
              <button onClick={save} disabled={saving} className="btn-primary" style={{background:"#16a34a",marginBottom:0}}>
                {saving?<span className="spinner"/>:"ğŸ’¾ Salva"}
              </button>
              <button onClick={()=>setShowForm(false)} className="btn-primary" style={{background:dark?"#334155":"#f3f4f6",color:dark?"#e2e8f0":"#374151",marginBottom:0}}>Annulla</button>
            </div>
          </div>
        ):(
          <button onClick={()=>setShowForm(true)} style={{width:"100%",padding:14,background:dark?"#1a2e1a":"#f0fdf4",color:"#16a34a",border:"2px dashed #86efac",borderRadius:14,fontSize:15,fontWeight:600,cursor:"pointer",marginBottom:14}}>
            + Aggiungi nota
          </button>
        )}
        {noteFiltrate.length===0&&!showForm&&<p style={{textAlign:"center",color:mutedC,padding:20}}>Nessuna nota ancora</p>}
        {noteFiltrate.map(n=>(
          <div key={n.id} style={{background:cardBg,borderRadius:14,padding:16,marginBottom:10,boxShadow:dark?"0 2px 10px rgba(0,0,0,0.3)":"0 2px 10px rgba(0,0,0,0.07)"}}>
            <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:8}}>
              <span style={{fontSize:12,fontWeight:700,color:dark?"#4ade80":"#16a34a"}}>{n.data}</span>
              <button onClick={()=>remove(n.id)} style={{background:"none",border:"none",color:"#dc2626",cursor:"pointer",fontSize:16,padding:0}}>ğŸ—‘</button>
            </div>
            <p style={{margin:0,fontSize:14,lineHeight:1.6,color:dark?"#e2e8f0":"#1a1a2e",whiteSpace:"pre-wrap"}}>{n.testo}</p>
          </div>
        ))}
      </>}
    </div>
  );
}

function OlivetoDetail({oliveto,clienti,onBack,nav,rils,sters,trats,allRils,allSters,traps,setTraps,dark,selectedYear,onDeleteOliveto,onDeleteRil,onDeleteSter,onDeleteTrat,onUpdateRil,onUpdateSter,onUpdateTrat}){
  const [tab,setTab]=useState("grafici");
  const [editItem,setEditItem]=useState(null);
  const myRil=[...rils].filter(r=>r.oId===oliveto.id).sort((a,b)=>b.data.localeCompare(a.data));
  const mySter=[...sters].filter(s=>s.oId===oliveto.id).sort((a,b)=>b.data.localeCompare(a.data));
  const myTrat=[...trats].filter(t=>t.oId===oliveto.id).sort((a,b)=>b.data.localeCompare(a.data));
  const lr=myRil[0],ls=mySter[0];
  const r=lr?rischio(lr.mosche):{l:"Nessun dato",c:"#9ca3af",bg:"rgba(156,163,175,0.1)",border:"#9ca3af"};
  const infD=ls?calcInf(ls):null;
  const cardBg=dark?"#1e293b":"white";
  const mutedC=dark?"#94a3b8":"#6b7280";
  const selStyle={width:"100%",padding:"9px 12px",border:`1.5px solid ${dark?"#334155":"#d1fae5"}`,borderRadius:10,fontSize:13,outline:"none",background:dark?"#273549":"white",color:dark?"#e2e8f0":"#1a1a2e",marginBottom:10,boxSizing:"border-box"};
  const inpStyle={...selStyle};
  const tabs=[["grafici","ğŸ“Š Grafici"],["trappole","ğŸª¤ Monitoraggi"],["stereo","ğŸ”¬ Controlli"],["trattamenti","ğŸ’Š Trattamenti"],["note","ğŸ“ Note"],["foto","ğŸ“· Foto"],["calendario","ğŸ“… Calendario"]];
  const cliente = clienti ? clienti.find(c => c.id === oliveto.cliente_id) : null;
  function EditModal(){
    const [f,setF]=useState({...editItem.data});
    const set=(k,v)=>setF(p=>({...p,[k]:v}));
    async function save(){
      if(editItem.type==="ril"){
        await sb.from("monitoraggi").update({data:f.data,mosche:+f.mosche,meteo:f.meteo,fase:f.fase}).eq("id",f.id);
        onUpdateRil&&onUpdateRil(f);
      } else if(editItem.type==="ster"){
        await sb.from("campionamenti").update({data:f.data,camp:+f.camp,uova:+f.uova||0,l1:+f.l1||0,l2:+f.l2||0,l3:+f.l3||0,pupe:+f.pupe||0,fori:+f.fori||0}).eq("id",f.id);
        onUpdateSter&&onUpdateSter(f);
      } else if(editItem.type==="trat"){
        await sb.from("trattamenti").update({data:f.data,prodotto:f.prodotto,dose:f.dose,note:f.note}).eq("id",f.id);
        onUpdateTrat&&onUpdateTrat(f);
      }
      setEditItem(null);
    }
    return createPortal(
      <div style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.7)",zIndex:2000,display:"flex",alignItems:"center",justifyContent:"center",padding:16}}>
        <div style={{background:cardBg,borderRadius:20,padding:20,width:"100%",maxWidth:360,maxHeight:"85vh",overflowY:"auto"}}>
          <h3 style={{fontFamily:"Lora,serif",margin:"0 0 16px",fontSize:17}}>
            {editItem.type==="ril"?"âœï¸ Modifica monitoraggio":editItem.type==="ster"?"âœï¸ Modifica campionamento":"âœï¸ Modifica trattamento"}
          </h3>
          <label style={{fontSize:12,fontWeight:600,color:mutedC,display:"block",marginBottom:4}}>Data</label>
          <input type="date" value={f.data} onChange={e=>set("data",e.target.value)} style={inpStyle}/>
          {editItem.type==="ril"&&<>
            <label style={{fontSize:12,fontWeight:600,color:mutedC,display:"block",marginBottom:4}}>Mosche</label>
            <input type="number" value={f.mosche} onChange={e=>set("mosche",e.target.value)} style={inpStyle}/>
            <label style={{fontSize:12,fontWeight:600,color:mutedC,display:"block",marginBottom:4}}>Meteo</label>
            <select value={f.meteo||""} onChange={e=>set("meteo",e.target.value)} style={selStyle}>
              {["","Soleggiato","Nuvoloso","Variabile","Caldo umido","Fresco","Piovoso"].map(o=><option key={o} value={o}>{o||"â€” seleziona â€”"}</option>)}
            </select>
            <label style={{fontSize:12,fontWeight:600,color:mutedC,display:"block",marginBottom:4}}>Fase</label>
            <select value={f.fase||""} onChange={e=>set("fase",e.target.value)} style={selStyle}>
              {["","Allegagione","Ingrossamento frutto","Indurimento nocciolo","Invaiatura","Maturazione","Raccolta"].map(o=><option key={o} value={o}>{o||"â€” seleziona â€”"}</option>)}
            </select>
          </>}
          {editItem.type==="ster"&&<>
            <label style={{fontSize:12,fontWeight:600,color:mutedC,display:"block",marginBottom:4}}>NÂ° campioni</label>
            <input type="number" value={f.camp} onChange={e=>set("camp",e.target.value)} style={inpStyle}/>
            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8}}>
              {[["uova","ğŸ¥š Uova"],["l1","L1"],["l2","L2"],["l3","L3"],["pupe","Pupe"],["fori","Fori"]].map(([k,lbl])=>(
                <div key={k}><label style={{fontSize:11,fontWeight:600,color:mutedC,display:"block",marginBottom:3}}>{lbl}</label>
                <input type="number" value={f[k]||0} onChange={e=>set(k,e.target.value)} style={{...inpStyle,marginBottom:0,textAlign:"center"}}/></div>
              ))}
            </div>
          </>}
          {editItem.type==="trat"&&<>
            <label style={{fontSize:12,fontWeight:600,color:mutedC,display:"block",marginBottom:4}}>Prodotto</label>
            <input value={f.prodotto||""} onChange={e=>set("prodotto",e.target.value)} style={inpStyle}/>
            <label style={{fontSize:12,fontWeight:600,color:mutedC,display:"block",marginBottom:4}}>Dose</label>
            <input value={f.dose||""} onChange={e=>set("dose",e.target.value)} style={inpStyle}/>
            <label style={{fontSize:12,fontWeight:600,color:mutedC,display:"block",marginBottom:4}}>Note</label>
            <input value={f.note||""} onChange={e=>set("note",e.target.value)} style={inpStyle}/>
          </>}
          <div style={{display:"flex",gap:10,marginTop:16}}>
            <button onClick={save} className="btn-primary" style={{background:"#16a34a",marginBottom:0}}>ğŸ’¾ Salva</button>
            <button onClick={()=>setEditItem(null)} className="btn-primary" style={{background:dark?"#334155":"#f3f4f6",color:dark?"#e2e8f0":"#374151",marginBottom:0}}>Annulla</button>
          </div>
        </div>
      </div>, document.body
    );
  }

  return(
    <div>
      {editItem&&<EditModal/>}
      <div style={{background:dark?"#0a1f0f":"linear-gradient(135deg,#052e16,#166534)",padding:"20px 20px 28px"}}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start"}}>
          <button onClick={onBack} style={{background:"rgba(255,255,255,0.2)",border:"none",color:"white",padding:"6px 14px",borderRadius:20,cursor:"pointer",marginBottom:14,fontSize:13}}>â† Indietro</button>
          <button onClick={()=>{if(confirm(`Eliminare "${oliveto.nome}"?`))onDeleteOliveto&&onDeleteOliveto(oliveto.id);}}
            style={{background:"rgba(220,38,38,0.3)",border:"none",color:"white",padding:"6px 12px",borderRadius:20,cursor:"pointer",fontSize:12}}>ğŸ—‘ Elimina</button>
        </div>
        <h2 style={{color:"white",fontFamily:"Lora,serif",margin:"0 0 4px",fontSize:20}}>{oliveto.nome}</h2>
        <p style={{color:"#86efac",margin:0,fontSize:13}}>{oliveto.comune||oliveto.loc} Â· {oliveto.varieta||oliveto.var} Â· {oliveto.piante} piante Â· {oliveto.ha} ha</p>
        {oliveto.lat&&oliveto.lng&&(
          <a href={`https://www.google.com/maps?q=${oliveto.lat},${oliveto.lng}&z=16`} target="_blank" rel="noreferrer"
            style={{color:"#86efac",margin:"5px 0 0",fontSize:12,fontFamily:"monospace",display:"inline-flex",alignItems:"center",gap:5,textDecoration:"none",background:"rgba(255,255,255,0.12)",padding:"4px 10px",borderRadius:8}}>
            ğŸ“ {oliveto.lat}, {oliveto.lng} <span style={{fontSize:11,opacity:0.8}}>â†— Maps</span>
          </a>
        )}
      </div>
      <div style={{padding:"12px 14px 0",display:"flex",gap:10}}>
        {lr&&<div style={{flex:1,background:r.bg,border:`1.5px solid ${r.border}`,borderRadius:14,padding:12}}>
          <div style={{fontSize:10,fontWeight:700,color:mutedC,marginBottom:3}}>ULTIMA TRAPPOLA</div>
          <div style={{fontSize:28,fontWeight:700,color:r.c,fontFamily:"Lora,serif"}}>{lr.mosche}</div>
          <div style={{fontSize:11,color:mutedC}}>mosche Â· {lr.data}</div>
          <span className="tag" style={{background:r.c,color:"white",marginTop:6}}>{r.l}</span>
        </div>}
        {infD&&<div style={{flex:1,background:cardBg,border:`1.5px solid ${dark?"#334155":"#e0e7ff"}`,borderRadius:14,padding:12}}>
          <div style={{fontSize:10,fontWeight:700,color:mutedC,marginBottom:6}}>STEREOSCOPIO</div>
          {[["Attiva",infD.att,"#d97706"],["Totale",infD.tot,"#7c3aed"]].map(([lbl,val,color])=>(
            <div key={lbl} style={{marginBottom:6}}>
              <div style={{fontSize:10,color,fontWeight:700}}>{lbl}</div>
              <div className="inf-bar-bg" style={{marginTop:2}}><div className="inf-bar-fill" style={{width:`${val}%`,background:color}}/></div>
              <div style={{fontSize:13,fontWeight:700,color,textAlign:"right"}}>{val.toFixed(1)}%</div>
            </div>
          ))}
        </div>}
      </div>
      <div style={{display:"flex",gap:6,padding:"12px 14px 0",overflowX:"auto"}}>
        {tabs.map(([id,lbl])=>(
          <button key={id} onClick={()=>setTab(id)}
            style={{flexShrink:0,padding:"8px 12px",borderRadius:10,border:"none",cursor:"pointer",fontSize:12,fontWeight:600,background:tab===id?"#16a34a":(dark?"#1e3a1e":"#f0fdf4"),color:tab===id?"white":(dark?"#4ade80":"#16a34a")}}>
            {lbl}
          </button>
        ))}
      </div>
      <div style={{padding:14}}>
        {tab==="grafici"&&<>
          <h4 style={{margin:"0 0 12px",fontFamily:"Lora,serif",fontSize:16}}>Andamento</h4>
          <div style={{background:cardBg,borderRadius:14,padding:16,boxShadow:dark?"0 2px 10px rgba(0,0,0,0.3)":"0 2px 10px rgba(0,0,0,0.06)",marginBottom:14}}>
            <DualChart oId={oliveto.id} rils={allRils} sters={allSters} dark={dark} selectedYear={selectedYear}/>
          </div>
          <div style={{display:"flex",gap:10,marginBottom:12}}>
            {[["Ril.",myRil.length,"ğŸª¤"],["Controlli",mySter.length,"ğŸ”¬"],["Tratt.",myTrat.length,"ğŸ’Š"]].map(([lbl,val,icon])=>(
              <div key={lbl} style={{flex:1,background:cardBg,borderRadius:12,padding:12,textAlign:"center",boxShadow:dark?"0 2px 8px rgba(0,0,0,0.3)":"0 2px 8px rgba(0,0,0,0.06)"}}>
                <div style={{fontSize:18}}>{icon}</div>
                <div style={{fontSize:22,fontWeight:700,fontFamily:"Lora,serif"}}>{val}</div>
                <div style={{fontSize:11,color:mutedC}}>{lbl}</div>
              </div>
            ))}
          </div>
          {(()=>{
            if(!lr) return null;
            const lastDate=new Date(lr.data);
            const oggi=new Date();
            const diff=Math.floor((oggi-lastDate)/(1000*60*60*24));
            const INTERVALLO=7;
            const prossimo=INTERVALLO-diff;
            const urgente=diff>=INTERVALLO;
            const colore=urgente?"#dc2626":diff>=5?"#d97706":"#16a34a";
            const msg=urgente?`âš ï¸ Monitoraggio in ritardo di ${diff-INTERVALLO} giorni`:prossimo<=2?`ğŸ”” Monitoraggio tra ${prossimo} giorni`:`âœ… Prossimo monitoraggio tra ${prossimo} giorni`;
            return(
              <div style={{background:urgente?"rgba(220,38,38,0.08)":dark?"#1e293b":"#f0fdf4",border:`1.5px solid ${colore}40`,borderRadius:12,padding:"10px 14px",marginBottom:4,display:"flex",justifyContent:"space-between",alignItems:"center"}}>
                <div>
                  <div style={{fontSize:13,fontWeight:600,color:colore}}>{msg}</div>
                  <div style={{fontSize:11,color:mutedC}}>Ultimo: {lr.data} Â· Cadenza consigliata: 7 giorni</div>
                </div>
                <div style={{fontSize:24,fontWeight:700,fontFamily:"Lora,serif",color:colore}}>{diff}gg</div>
              </div>
            );
          })()}
        </>}
        {tab==="trappole"&&<>
          <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:12}}>
            <h4 style={{fontFamily:"Lora,serif",fontSize:16,margin:0}}>Monitoraggi trappole</h4>
            <button onClick={()=>nav("gestione-trappole",{oId:oliveto.id,oliveto:oliveto.nome})}
              style={{background:dark?"#1e3a1e":"#f0fdf4",border:"none",color:"#16a34a",padding:"6px 12px",borderRadius:8,fontSize:12,fontWeight:700,cursor:"pointer"}}>
              âš™ï¸ Gestisci trappole
            </button>
          </div>
          <button onClick={()=>nav("add-rilevamento",{clienteId:oliveto.cliente_id,oId:oliveto.id})}
            style={{width:"100%",padding:12,background:dark?"#1e1b4b":"#3730a3",color:"white",border:"none",borderRadius:12,fontSize:13,fontWeight:700,cursor:"pointer",marginBottom:14}}>
            + Aggiungi monitoraggio ğŸª¤
          </button>
          {myRil.length===0&&<p style={{color:mutedC,textAlign:"center",padding:20}}>Nessun monitoraggio ancora</p>}
          {myRil.map(rr=>{const rv=rischio(rr.mosche);return(
            <div key={rr.id} style={{background:cardBg,borderRadius:12,padding:14,marginBottom:10,boxShadow:dark?"0 1px 6px rgba(0,0,0,0.3)":"0 1px 6px rgba(0,0,0,0.06)"}}>
              <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start"}}>
                <div><div style={{fontWeight:700}}>{rr.data}</div><div style={{fontSize:12,color:mutedC}}>{rr.trappola||"â€”"} Â· {rr.meteo}</div><div style={{fontSize:12,color:mutedC}}>{rr.fase}</div></div>
                <div style={{textAlign:"right"}}>
                  <div style={{fontSize:28,fontWeight:700,color:rv.c,fontFamily:"Lora,serif"}}>{rr.mosche}</div>
                  <span className="tag" style={{background:rv.c,color:"white"}}>{rv.l}</span>
                </div>
              </div>
              <div style={{display:"flex",gap:8,marginTop:10}}>
                <button onClick={()=>setEditItem({type:"ril",data:rr})} style={{flex:1,padding:"6px",background:dark?"#1e3a1e":"#f0fdf4",color:"#16a34a",border:"none",borderRadius:8,cursor:"pointer",fontSize:12,fontWeight:700}}>âœï¸ Modifica</button>
                <button onClick={()=>{if(confirm("Eliminare?"))onDeleteRil&&onDeleteRil(rr.id);}} style={{flex:1,padding:"6px",background:"rgba(220,38,38,0.1)",color:"#dc2626",border:"none",borderRadius:8,cursor:"pointer",fontSize:12,fontWeight:700}}>ğŸ—‘ Elimina</button>
              </div>
            </div>);})}
        </>}
        {tab==="stereo"&&<>
          <h4 style={{margin:"0 0 12px",fontFamily:"Lora,serif",fontSize:16}}>Controlli infestazione</h4>
          <button onClick={()=>nav("add-stereoscopio",{clienteId:oliveto.cliente_id,oId:oliveto.id})}
            style={{width:"100%",padding:12,background:dark?"#080614":"#1e1b4b",color:"white",border:"none",borderRadius:12,fontSize:13,fontWeight:700,cursor:"pointer",marginBottom:14}}>
            + Aggiungi controllo ğŸ”¬
          </button>
          {mySter.length===0&&<p style={{color:mutedC,textAlign:"center",padding:20}}>Nessun controllo ancora</p>}
          {mySter.map(s=>{const i=calcInf(s);return(
            <div key={s.id} style={{background:cardBg,borderRadius:14,padding:16,marginBottom:12,boxShadow:dark?"0 2px 10px rgba(0,0,0,0.3)":"0 2px 10px rgba(0,0,0,0.07)"}}>
              <div style={{display:"flex",justifyContent:"space-between",marginBottom:8}}>
                <div style={{fontWeight:700,fontFamily:"Lora,serif"}}>{s.data}</div>
                <div style={{fontSize:12,color:mutedC}}>{s.camp} olive</div>
              </div>
              <InfBar label="Inf. ATTIVA" value={i.att} color={cInf(i.att)}/>
              <InfBar label="Inf. TOTALE" value={i.tot} color={i.tot>20?"#dc2626":"#7c3aed"}/>
              <div style={{display:"flex",gap:6,flexWrap:"wrap",marginTop:10}}>
                {[["ğŸ¥š",s.uova,"#f59e0b"],["L1",s.l1,"#10b981"],["L2",s.l2,"#059669"],["L3",s.l3,"#047857"],["Pupe",s.pupe,"#7c3aed"],["Fori",s.fori,"#6b7280"]].map(([lbl,val,color])=>(
                  <div key={lbl} style={{background:dark?"#273549":"#f9fafb",borderRadius:8,padding:"4px 8px",textAlign:"center"}}>
                    <div style={{fontSize:14,fontWeight:700,color}}>{val}</div><div style={{fontSize:10,color:mutedC}}>{lbl}</div>
                  </div>
                ))}
              </div>
              <div style={{display:"flex",gap:8,marginTop:10}}>
                <button onClick={()=>setEditItem({type:"ster",data:s})} style={{flex:1,padding:"6px",background:dark?"#1e3a1e":"#f0fdf4",color:"#16a34a",border:"none",borderRadius:8,cursor:"pointer",fontSize:12,fontWeight:700}}>âœï¸ Modifica</button>
                <button onClick={()=>{if(confirm("Eliminare?"))onDeleteSter&&onDeleteSter(s.id);}} style={{flex:1,padding:"6px",background:"rgba(220,38,38,0.1)",color:"#dc2626",border:"none",borderRadius:8,cursor:"pointer",fontSize:12,fontWeight:700}}>ğŸ—‘ Elimina</button>
              </div>
            </div>);})}
        </>}
        {tab==="trattamenti"&&<>
          <h4 style={{margin:"0 0 12px",fontFamily:"Lora,serif",fontSize:16}}>Trattamenti effettuati</h4>
          {myTrat.length===0&&<p style={{color:mutedC,textAlign:"center",padding:20}}>Nessun trattamento registrato</p>}
          {myTrat.map(t=>(
            <div key={t.id} style={{background:cardBg,borderRadius:12,padding:14,marginBottom:10}}>
              <div style={{fontWeight:700}}>{t.data} Â· {t.prodotto}</div>
              {t.dose&&<div style={{fontSize:12,color:mutedC,marginTop:2}}>Dose: {t.dose}</div>}
              {t.note&&<div style={{fontSize:12,color:mutedC}}>{t.note}</div>}
              <div style={{display:"flex",gap:8,marginTop:8}}>
                <button onClick={()=>setEditItem({type:"trat",data:t})} style={{flex:1,padding:"5px 12px",background:dark?"#1e3a1e":"#f0fdf4",color:"#16a34a",border:"none",borderRadius:8,cursor:"pointer",fontSize:12,fontWeight:700}}>âœï¸ Modifica</button>
                <button onClick={()=>{if(confirm("Eliminare?"))onDeleteTrat&&onDeleteTrat(t.id);}} style={{flex:1,padding:"5px 12px",background:"rgba(220,38,38,0.1)",color:"#dc2626",border:"none",borderRadius:8,cursor:"pointer",fontSize:12,fontWeight:700}}>ğŸ—‘ Elimina</button>
              </div>
            </div>
          ))}
          <button onClick={()=>nav("add-trattamento",oliveto)}
            style={{width:"100%",padding:14,background:dark?"#1e3a1e":"#f0fdf4",color:"#16a34a",border:"2px dashed #86efac",borderRadius:14,fontSize:15,fontWeight:600,cursor:"pointer",marginTop:4}}>
            + Aggiungi trattamento
          </button>
        </>}
        {tab==="note"&&<NoteOliveto oliveto={oliveto} cliente={cliente} dark={dark} cardBg={cardBg} mutedC={mutedC} selectedYear={selectedYear}/>}
        {tab==="foto"&&<FotoOliveto oliveto={oliveto} dark={dark} cardBg={cardBg} mutedC={mutedC}/>}
        {tab==="calendario"&&<Calendario rils={myRil} sters={mySter} trats={myTrat} oliveti={[oliveto]} dark={dark} selectedYear={selectedYear}/>}
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CLIENTE DETAIL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function ClienteDetail({cliente,oliveti,rils,sters,trats,traps,setTraps,onBack,nav,dark,onDeleteCliente,onDeleteOliveto,onDeleteRil,onDeleteSter,onDeleteTrat,onUpdateRil,onUpdateSter,onUpdateTrat}){
  const myOl=oliveti.filter(o=>o.cliente_id===cliente.id);
  const [olSort,setOlSort]=useState("nome"); // nome | alert | data
  const myRils=rils.filter(r=>myOl.map(o=>o.id).includes(r.oId));
  const mySters=sters.filter(s=>myOl.map(o=>o.id).includes(s.oId));
  const myTrats=trats.filter(t=>myOl.map(o=>o.id).includes(t.oId));
  const [ctab,setCtab]=useState("oliveti");
  const cardBg=dark?"#1e293b":"white";
  const mutedC=dark?"#94a3b8":"#6b7280";
  const alerts=myOl.filter(o=>{const l=lastOf(rils,"oId",o.id);return l&&l.mosche>=SA;}).length;

  return(
    <div>
      <div style={{background:dark?"linear-gradient(135deg,#080614,#110e2e)":"linear-gradient(135deg,#1e1b4b,#3730a3)",padding:"20px 20px 28px"}}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start"}}>
          <button onClick={onBack} style={{background:"rgba(255,255,255,0.2)",border:"none",color:"white",padding:"6px 14px",borderRadius:20,cursor:"pointer",marginBottom:14,fontSize:13}}>â† Indietro</button>
          <button onClick={()=>{if(confirm(`Eliminare "${cliente.nome}"?\nVerranno eliminati tutti gli oliveti e dati associati.`))onDeleteCliente&&onDeleteCliente(cliente.id);}}
            style={{background:"rgba(220,38,38,0.3)",border:"none",color:"white",padding:"6px 12px",borderRadius:20,cursor:"pointer",fontSize:12}}>ğŸ—‘ Elimina</button>
        </div>
        <h2 style={{color:"white",fontFamily:"Lora,serif"}}>{cliente.nome}</h2>
        <p style={{color:"#a5b4fc",margin:"4px 0 0",fontSize:13}}>
          {cliente.telefono&&<span>ğŸ“ {cliente.telefono} Â· </span>}
          {myOl.length} oliveti Â· {alerts>0&&<span style={{color:"#fca5a5"}}>âš ï¸ {alerts} alert</span>}
        </p>
      </div>

      <div style={{padding:14}}>
        <div>
          <div style={{display:"flex",gap:8,marginBottom:12,alignItems:"center"}}>
            <span style={{fontSize:13,color:mutedC,fontWeight:600}}>Ordina:</span>
            {[["nome","Aâ†’Z"],["alert","âš ï¸"],["data","ğŸ“…"]].map(([v,l])=>(
              <button key={v} onClick={()=>setOlSort(v)}
                style={{padding:"5px 10px",borderRadius:8,border:"none",cursor:"pointer",fontSize:11,fontWeight:600,
                  background:olSort===v?"#16a34a":(dark?"#1e3a1e":"#f0fdf4"),
                  color:olSort===v?"white":(dark?"#4ade80":"#16a34a")}}>
                {l}
              </button>
            ))}
          </div>
          {[...myOl]
            .map(o=>{
              const lr=lastOf(rils,"oId",o.id);
              const ls=lastOf(sters,"oId",o.id);
              const alertM=lr&&lr.mosche>=SA?1:0;
              const alertI=ls&&calcInf(ls).att>=IA?1:0;
              return{o,lr,ls,alertM,alertI};
            })
            .sort((a,b)=>{
              if(olSort==="alert") return (b.alertM+b.alertI)-(a.alertM+a.alertI);
              if(olSort==="data") return (b.lr?.data||"").localeCompare(a.lr?.data||"");
              return a.o.nome.localeCompare(b.o.nome);
            })
            .map(({o,lr,ls,alertM,alertI})=>{
              const r=lr?rischio(lr.mosche):{l:"â€”",c:"#9ca3af",bg:"rgba(156,163,175,0.1)",border:"#9ca3af"};
              const inf=ls?calcInf(ls):null;
              return(
                <div key={o.id} onClick={()=>nav("oliveto-detail",o)} style={{background:cardBg,borderRadius:14,padding:16,marginBottom:10,cursor:"pointer",boxShadow:dark?"0 2px 14px rgba(0,0,0,0.4)":"0 2px 14px rgba(0,0,0,0.07)"}} className="card">
                  <div style={{display:"flex",alignItems:"center",gap:12}}>
                    <div style={{fontSize:28}}>ğŸ«’</div>
                    <div style={{flex:1}}>
                      <div style={{fontWeight:700,fontFamily:"Lora,serif"}}>{o.nome}</div>
                      <div style={{fontSize:12,color:mutedC}}>{o.comune||o.loc}</div>
                      {lr&&<div style={{fontSize:12,color:mutedC}}>ğŸª¤ {lr.data}: {lr.mosche} mosche</div>}
                    </div>
                    <div style={{display:"flex",flexDirection:"column",gap:3,alignItems:"flex-end"}}>
                      <span className="tag" style={{background:r.bg,color:r.c,border:`1px solid ${r.border}`}}>{r.l}</span>
                      {inf&&alertI>0&&<span className="tag" style={{background:"rgba(217,119,6,0.15)",color:"#d97706",border:"1px solid #d97706"}}>ğŸ”¬ {inf.att.toFixed(0)}%</span>}
                    </div>
                  </div>
                </div>
              );
            })}
          <button onClick={()=>nav("add-oliveto",{clienteId:cliente.id,clienteNome:cliente.nome})}
            style={{width:"100%",padding:14,background:dark?"#1e3a1e":"#f0fdf4",color:"#16a34a",border:"2px dashed #86efac",borderRadius:14,fontSize:15,fontWeight:600,cursor:"pointer",marginTop:4}}>
            + Aggiungi oliveto
          </button>
        </div>

      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HOME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAPPA OLIVETI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function MappaOliveti({oliveti,rils,sters,clienti,nav,dark}){
  const mapRef=React.useRef(null);
  const leafRef=React.useRef(null);
  const mutedC=dark?"#94a3b8":"#6b7280";
  const [filtro,setFiltro]=useState("tutti"); // tutti | alert | ok

  useEffect(()=>{
    if(!window.L){ return; }
    if(!leafRef.current){
      leafRef.current=window.L.map(mapRef.current,{zoomControl:true}).setView([41.9,12.5],6);
      window.L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{
        attribution:"Â© OpenStreetMap",maxZoom:19
      }).addTo(leafRef.current);
    }
    const map=leafRef.current;
    map.eachLayer(l=>{ if(l._isMarker) map.removeLayer(l); });
    const olConCoord=oliveti.filter(o=>o.lat&&o.lng);
    const filtered=olConCoord.filter(o=>{
      const lr=lastOf(rils,"oId",o.id);
      const ls=lastOf(sters,"oId",o.id);
      const alertM=lr&&lr.mosche>=SA;
      const alertI=ls&&calcInf(ls).att>=IA;
      if(filtro==="alert") return alertM||alertI;
      if(filtro==="ok") return !alertM&&!alertI;
      return true;
    });
    const bounds=[];
    filtered.forEach(o=>{
      const lr=lastOf(rils,"oId",o.id);
      const ls=lastOf(sters,"oId",o.id);
      const alertM=lr&&lr.mosche>=SA;
      const alertI=ls&&calcInf(ls).att>=IA;
      const color=alertM?"#dc2626":alertI?"#d97706":"#16a34a";
      const cliente=clienti.find(c=>c.id===o.cliente_id);
      const icon=window.L.divIcon({
        className:"",
        html:`<div style="width:32px;height:32px;border-radius:50%;background:${color};border:3px solid white;box-shadow:0 2px 8px rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;font-size:16px;cursor:pointer">ğŸ«’</div>`,
        iconSize:[32,32],iconAnchor:[16,16]
      });
      const inf=ls?calcInf(ls):null;
      const popup=`<div style="font-family:sans-serif;min-width:160px">
        <strong style="font-size:14px">${o.nome}</strong><br>
        <span style="font-size:12px;color:#6b7280">${o.comune||""}</span><br>
        ${cliente?`<span style="font-size:11px">ğŸ‘¤ ${cliente.nome}</span><br>`:""}
        ${lr?`<span style="font-size:12px;color:${color}">ğŸª¤ ${lr.mosche} mosche Â· ${lr.data}</span><br>`:""}
        ${inf?`<span style="font-size:12px;color:#d97706">ğŸ”¬ Att. ${inf.att.toFixed(1)}%</span><br>`:""}
        <div style="margin-top:6px;padding:4px 8px;background:${color};color:white;border-radius:6px;font-size:11px;font-weight:700;text-align:center;cursor:pointer" onclick="window.__mapNav&&window.__mapNav('${o.id}')">Apri scheda â†’</div>
      </div>`;
      const marker=window.L.marker([+o.lat,+o.lng],{icon}).addTo(map);
      marker._isMarker=true;
      marker.bindPopup(popup);
      bounds.push([+o.lat,+o.lng]);
    });
    if(bounds.length>0) map.fitBounds(bounds,{padding:[40,40],maxZoom:13});
  },[oliveti,rils,sters,filtro]);

  // Esponi nav globalmente per popup
  useEffect(()=>{
    window.__mapNav=(oId)=>{
      const o=oliveti.find(x=>x.id===oId);
      if(o) nav("oliveto-detail",o);
    };
    return()=>{ delete window.__mapNav; };
  },[oliveti,nav]);

  const olConCoord=oliveti.filter(o=>o.lat&&o.lng).length;
  const olSenzaCoord=oliveti.length-olConCoord;

  return(
    <div style={{display:"flex",flexDirection:"column",height:"calc(100vh - 120px)"}}>
      <div style={{background:dark?"#0a1f0f":"#052e16",padding:"14px 16px"}}>
        <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:8}}>
          <h3 style={{color:"white",fontFamily:"Lora,serif",fontSize:16,margin:0}}>ğŸ—ºï¸ Mappa oliveti</h3>
          <span style={{color:"#86efac",fontSize:12}}>{olConCoord} su {oliveti.length} con GPS</span>
        </div>
        <div style={{display:"flex",gap:6}}>
          {[["tutti","Tutti"],["alert","âš ï¸ Alert"],["ok","âœ… OK"]].map(([v,l])=>(
            <button key={v} onClick={()=>setFiltro(v)}
              style={{padding:"5px 12px",borderRadius:8,border:"none",cursor:"pointer",fontSize:12,fontWeight:600,
                background:filtro===v?"white":"rgba(255,255,255,0.15)",
                color:filtro===v?"#052e16":"white"}}>
              {l}
            </button>
          ))}
        </div>
      </div>
      {!window.L?(
        <div style={{flex:1,display:"flex",alignItems:"center",justifyContent:"center",flexDirection:"column",gap:12,padding:24,textAlign:"center"}}>
          <div style={{fontSize:48}}>ğŸ—ºï¸</div>
          <p style={{color:dark?"#94a3b8":"#6b7280"}}>Leaflet non caricato.<br/>Controlla la connessione.</p>
        </div>
      ):(
        <div ref={mapRef} style={{flex:1}}/>
      )}
      {olSenzaCoord>0&&(
        <div style={{padding:"10px 16px",background:dark?"#1e293b":"#fffbeb",borderTop:`1px solid ${dark?"#334155":"#fde68a"}`,fontSize:12,color:dark?"#fbbf24":"#92400e"}}>
          âš ï¸ {olSenzaCoord} olivet{olSenzaCoord===1?"o":"i"} senza coordinate GPS â€” aggiungile dalla scheda oliveto
        </div>
      )}
    </div>
  );
}

function Home({clienti,oliveti,rils,sters,nav,dark}){
  const cardBg=dark?"#1e293b":"white";
  const mutedC=dark?"#94a3b8":"#6b7280";
  const [alertPanel,setAlertPanel]=useState(null);
  const [search,setSearch]=useState("");
  const [sortBy,setSortBy]=useState("nome"); // nome | alert | data

  const olivetiAlertMosche=oliveti.filter(o=>{const l=lastOf(rils,"oId",o.id);return l&&l.mosche>=SA;});
  const olivetiAlertInf=oliveti.filter(o=>{const s=lastOf(sters,"oId",o.id);if(!s)return false;const i=calcInf(s);return i&&i.att>=IA;});

  // Raggruppa per cliente
  function byCliente(olList){
    const map={};
    olList.forEach(o=>{
      const c=clienti.find(x=>x.id===o.cliente_id);
      const cId=c?.id||"sconosciuto";
      if(!map[cId]) map[cId]={cliente:c,oliveti:[]};
      map[cId].oliveti.push(o);
    });
    return Object.values(map);
  }

  function AlertPanel({tipo,onClose}){
    const lista=tipo==="mosche"?olivetiAlertMosche:olivetiAlertInf;
    const gruppi=byCliente(lista);
    const color=tipo==="mosche"?"#dc2626":"#d97706";
    const title=tipo==="mosche"?"ğŸª¤ Alert mosche":"ğŸ”¬ Alert infestazione";
    return createPortal(
      <div style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.6)",zIndex:500,display:"flex",alignItems:"flex-end",justifyContent:"center"}} onClick={onClose}>
        <div style={{background:dark?"#1e293b":"white",width:"100%",maxWidth:640,maxHeight:"75vh",borderRadius:"20px 20px 0 0",overflowY:"auto",boxShadow:"0 -8px 32px rgba(0,0,0,0.3)"}} onClick={e=>e.stopPropagation()}>
          <div style={{background:color,padding:"14px 16px",display:"flex",justifyContent:"space-between",alignItems:"center",borderRadius:"20px 20px 0 0"}}>
            <h3 style={{color:"white",fontFamily:"Lora,serif",fontSize:16,margin:0}}>{title} ({lista.length})</h3>
            <button onClick={onClose} style={{background:"rgba(255,255,255,0.25)",border:"none",color:"white",width:28,height:28,borderRadius:14,cursor:"pointer",fontSize:16}}>Ã—</button>
          </div>
          <div style={{padding:14}}>
            {lista.length===0&&<p style={{color:mutedC,textAlign:"center",padding:20}}>Nessun alert</p>}
            {gruppi.map(({cliente,oliveti:ol})=>(
              <div key={cliente?.id||"x"} style={{marginBottom:16}}>
                <div style={{fontSize:12,fontWeight:700,color:mutedC,marginBottom:6,textTransform:"uppercase",letterSpacing:1}}>
                  ğŸ‘¤ {cliente?.nome||"Cliente sconosciuto"}
                </div>
                {ol.map(o=>{
                  const lr=lastOf(rils,"oId",o.id);
                  const ls=lastOf(sters,"oId",o.id);
                  const inf=ls?calcInf(ls):null;
                  return(
                    <div key={o.id} onClick={()=>{onClose();nav("oliveto-detail",o);}}
                      style={{background:dark?"#273549":"#fff8f8",border:`1.5px solid ${color}40`,borderRadius:12,padding:"12px 14px",marginBottom:8,cursor:"pointer",display:"flex",justifyContent:"space-between",alignItems:"center"}}>
                      <div>
                        <div style={{fontWeight:700,fontFamily:"Lora,serif",fontSize:14}}>{o.nome}</div>
                        <div style={{fontSize:12,color:mutedC}}>{o.comune||o.loc}</div>
                        {tipo==="mosche"&&lr&&<div style={{fontSize:12,color:color,fontWeight:600,marginTop:2}}>ğŸª¤ {lr.mosche} mosche Â· {lr.data}</div>}
                        {tipo==="inf"&&inf&&<div style={{fontSize:12,color:color,fontWeight:600,marginTop:2}}>ğŸ”¬ Att. {inf.att.toFixed(1)}% Â· {ls.data}</div>}
                      </div>
                      <span style={{fontSize:20,color:mutedC}}>â€º</span>
                    </div>
                  );
                })}
              </div>
            ))}
          </div>
        </div>
      </div>, document.body
    );
  }

  return(
    <div>
      {alertPanel&&<AlertPanel tipo={alertPanel} onClose={()=>setAlertPanel(null)}/>}
      <div style={{background:dark?"linear-gradient(135deg,#051a08,#0a2e0a)":"linear-gradient(135deg,#052e16,#166534)",padding:"28px 20px 40px",borderRadius:"0 0 28px 28px"}}>
        <h2 style={{color:"white",fontFamily:"Lora,serif",margin:"0 0 4px",fontSize:22}}>ğŸ«’ OliveTrack</h2>
        <p style={{color:"#86efac",margin:0,fontSize:13}}>Monitoraggio Mosca delle Olive</p>
        <div style={{display:"flex",gap:10,marginTop:20,flexWrap:"wrap"}}>
          <div style={{flex:1,minWidth:55,background:"rgba(255,255,255,0.13)",borderRadius:14,padding:"12px 8px",textAlign:"center"}}>
            <div style={{fontSize:22}}>ğŸ‘¥</div>
            <div style={{color:"white",fontSize:24,fontWeight:700,fontFamily:"Lora,serif"}}>{clienti.length}</div>
            <div style={{color:"#86efac",fontSize:11}}>Clienti</div>
          </div>
          <div style={{flex:1,minWidth:55,background:"rgba(255,255,255,0.13)",borderRadius:14,padding:"12px 8px",textAlign:"center"}}>
            <div style={{fontSize:22}}>ğŸ«’</div>
            <div style={{color:"white",fontSize:24,fontWeight:700,fontFamily:"Lora,serif"}}>{oliveti.length}</div>
            <div style={{color:"#86efac",fontSize:11}}>Oliveti</div>
          </div>
          <div onClick={()=>olivetiAlertMosche.length>0&&setAlertPanel("mosche")}
            style={{flex:1,minWidth:55,background:olivetiAlertMosche.length>0?"rgba(220,38,38,0.4)":"rgba(255,255,255,0.13)",borderRadius:14,padding:"12px 8px",textAlign:"center",cursor:olivetiAlertMosche.length>0?"pointer":"default",transition:"transform 0.1s"}}
            className={olivetiAlertMosche.length>0?"card":""}>
            <div style={{fontSize:22}}>ğŸª¤</div>
            <div style={{color:"white",fontSize:24,fontWeight:700,fontFamily:"Lora,serif"}}>{olivetiAlertMosche.length}</div>
            <div style={{color:"#fca5a5",fontSize:11}}>Alert mosche</div>
          </div>
          <div onClick={()=>olivetiAlertInf.length>0&&setAlertPanel("inf")}
            style={{flex:1,minWidth:55,background:olivetiAlertInf.length>0?"rgba(217,119,6,0.4)":"rgba(255,255,255,0.13)",borderRadius:14,padding:"12px 8px",textAlign:"center",cursor:olivetiAlertInf.length>0?"pointer":"default",transition:"transform 0.1s"}}
            className={olivetiAlertInf.length>0?"card":""}>
            <div style={{fontSize:22}}>ğŸ”¬</div>
            <div style={{color:"white",fontSize:24,fontWeight:700,fontFamily:"Lora,serif"}}>{olivetiAlertInf.length}</div>
            <div style={{color:"#fde68a",fontSize:11}}>Alert inf.</div>
          </div>
        </div>
      </div>
      <div className="page-pad">
        {/* Barra ricerca + ordinamento */}
        <div style={{display:"flex",gap:8,marginBottom:14,alignItems:"center"}}>
          <div style={{flex:1,position:"relative"}}>
            <span style={{position:"absolute",left:10,top:"50%",transform:"translateY(-50%)",fontSize:14,color:mutedC}}>ğŸ”</span>
            <input value={search} onChange={e=>setSearch(e.target.value)} placeholder="Cerca cliente..."
              style={{width:"100%",padding:"9px 12px 9px 32px",border:`1.5px solid ${dark?"#334155":"#d1fae5"}`,borderRadius:10,fontSize:13,outline:"none",boxSizing:"border-box",background:dark?"#1e293b":"white",color:dark?"#e2e8f0":"#1a1a2e"}}/>
          </div>
          <select value={sortBy} onChange={e=>setSortBy(e.target.value)}
            style={{padding:"9px 10px",border:`1.5px solid ${dark?"#334155":"#d1fae5"}`,borderRadius:10,fontSize:12,outline:"none",background:dark?"#1e293b":"white",color:dark?"#e2e8f0":"#1a1a2e",flexShrink:0}}>
            <option value="nome">Aâ†’Z</option>
            <option value="alert">âš ï¸ Alert</option>
            <option value="data">ğŸ“… Recenti</option>
          </select>
        </div>
        {clienti.length===0&&(
          <div style={{background:cardBg,borderRadius:16,padding:32,textAlign:"center",boxShadow:dark?"0 2px 14px rgba(0,0,0,0.4)":"0 2px 14px rgba(0,0,0,0.07)"}}>
            <div style={{fontSize:48,marginBottom:12}}>ğŸ‘¥</div>
            <p style={{color:mutedC,marginBottom:16}}>Nessun cliente ancora.<br/>Aggiungi il primo!</p>
          </div>
        )}
        <div className="card-grid">
        {clienti
          .filter(c=>c.nome.toLowerCase().includes(search.toLowerCase()))
          .map(c=>{
            const myOl=oliveti.filter(o=>o.cliente_id===c.id);
            const myAlertsMosche=myOl.filter(o=>{const l=lastOf(rils,"oId",o.id);return l&&l.mosche>=SA;}).length;
            const myAlertsInf=myOl.filter(o=>{const s=lastOf(sters,"oId",o.id);if(!s)return false;const i=calcInf(s);return i&&i.att>=IA;}).length;
            const lastRil=rils.filter(r=>myOl.map(o=>o.id).includes(r.oId)).sort((a,b)=>b.data.localeCompare(a.data))[0];
            return{c,myOl,myAlertsMosche,myAlertsInf,lastRil};
          })
          .sort((a,b)=>{
            if(sortBy==="alert") return (b.myAlertsMosche+b.myAlertsInf)-(a.myAlertsMosche+a.myAlertsInf);
            if(sortBy==="data") return (b.lastRil?.data||"").localeCompare(a.lastRil?.data||"");
            return a.c.nome.localeCompare(b.c.nome);
          })
          .map(({c,myOl,myAlertsMosche,myAlertsInf,lastRil})=>(
            <div key={c.id} onClick={()=>nav("cliente-detail",c)} style={{background:cardBg,borderRadius:18,padding:16,boxShadow:dark?"0 2px 14px rgba(0,0,0,0.4)":"0 2px 14px rgba(0,0,0,0.07)",cursor:"pointer"}} className="card fade-in">
              <div style={{display:"flex",alignItems:"center",gap:12}}>
                <div style={{width:44,height:44,borderRadius:22,background:dark?"#1e3a1e":"#d1fae5",display:"flex",alignItems:"center",justifyContent:"center",fontSize:22}}>ğŸ‘¤</div>
                <div style={{flex:1}}>
                  <div style={{fontWeight:700,fontFamily:"Lora,serif"}}>{c.nome}</div>
                  <div style={{fontSize:12,color:mutedC}}>{myOl.length} olivet{myOl.length===1?"o":"i"}</div>
                  {c.telefono&&<div style={{fontSize:12,color:mutedC}}>ğŸ“ {c.telefono}</div>}
                </div>
                <div style={{display:"flex",flexDirection:"column",gap:4,alignItems:"flex-end"}}>
                  {myAlertsMosche>0&&<div className="tag" style={{background:"#dc2626",color:"white"}}>ğŸª¤ {myAlertsMosche}</div>}
                  {myAlertsInf>0&&<div className="tag" style={{background:"#d97706",color:"white"}}>ğŸ”¬ {myAlertsInf}</div>}
                </div>
              </div>
              {lastRil&&<div style={{marginTop:10,paddingTop:10,borderTop:`1px solid ${dark?"#334155":"#f3f4f6"}`,fontSize:12,color:mutedC}}>
                Ultimo: {lastRil.data} â€” {lastRil.mosche} mosche ğŸª¤
              </div>}
            </div>
          ))}
        </div>
        <div style={{display:"flex",gap:10,marginTop:12}}>
          <button onClick={()=>nav("add-cliente")} style={{flex:1,padding:14,background:dark?"#1e1b4b":"#eef2ff",color:dark?"#818cf8":"#3730a3",border:`2px dashed ${dark?"#3730a3":"#a5b4fc"}`,borderRadius:14,fontSize:15,fontWeight:600,cursor:"pointer"}}>
            + Nuovo cliente
          </button>
          <button onClick={()=>nav("importa-dati")} style={{flex:1,padding:14,background:dark?"#1e3a1e":"#f0fdf4",color:"#16a34a",border:`2px dashed #86efac`,borderRadius:14,fontSize:15,fontWeight:600,cursor:"pointer"}}>
            ğŸ”„ Rinnova passati
          </button>
        </div>
      </div>
    </div>
  );
}
        
// Metti questa funzione fuori dai componenti, ad es. prima di "function App(){"
function inviaWhatsApp(cliente, tipo, dati, olivetoNome) {
  if (!cliente || !cliente.telefono) return;

  let num = cliente.telefono.replace(/\s+/g, '');
  if (!num.startsWith('+') && !num.startsWith('00')) {
    num = '39' + num; 
  } else {
    num = num.replace('+', '');
  }

  let text = '';
  if (tipo === 'ril') {
    text = `Ciao ${cliente.nome},\nti aggiorno sul monitoraggio dell'oliveto *${olivetoNome}* del ${dati.data}:\n\nğŸª¤ Mosche catturate: ${dati.mosche}\nğŸŒ¤ Meteo: ${dati.meteo || '-'}\nğŸŒ¿ Fase: ${dati.fase || '-'}`;
  } else if (tipo === 'ster') {
    let camp = parseInt(dati.camp) || 1;
    let att = (((parseInt(dati.uova)||0) + (parseInt(dati.l1)||0) + (parseInt(dati.l2)||0)) / camp) * 100;
    text = `Ciao ${cliente.nome},\nti aggiorno sul controllo infestazione dell'oliveto *${olivetoNome}* del ${dati.data}:\n\nğŸ”¬ Infestazione Attiva: ${att.toFixed(1)}%\nğŸ«’ Olive campionate: ${dati.camp}`;
  } else if (tipo === 'nota') {
    // Lascia esclusivamente il testo della nota
    text = dati.testo;
  }

  const url = `https://wa.me/${num}?text=${encodeURIComponent(text)}`;
  window.open(url, '_blank');
}
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RINNOVO STAGIONE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function ImportaDati({allClienti, allOliveti, selectedYear, onBack, onSave, dark}) {
  const passati = allClienti.filter(c => !c.stagioni.includes(selectedYear));
  const [selCl, setSelCl] = useState([]);
  const [selOl, setSelOl] = useState([]);
  const [saving, setSaving] = useState(false);

  function toggleCl(cId) {
    if (selCl.includes(cId)) {
      setSelCl(p => p.filter(id => id !== cId));
      const olIds = allOliveti.filter(o => o.cliente_id === cId).map(o => o.id);
      setSelOl(p => p.filter(id => !olIds.includes(id)));
    } else {
      setSelCl(p => [...p, cId]);
      const olIds = allOliveti.filter(o => o.cliente_id === cId && !o.stagioni.includes(selectedYear)).map(o => o.id);
      setSelOl(p => [...new Set([...p, ...olIds])]);
    }
  }

  function toggleOl(oId, cId) {
    if (selOl.includes(oId)) {
      setSelOl(p => p.filter(id => id !== oId));
    } else {
      setSelOl(p => [...p, oId]);
      if (!selCl.includes(cId)) setSelCl(p => [...p, cId]);
    }
  }

  async function doSave() {
    if(selCl.length===0) return;
    setSaving(true);
    await onSave(selCl, selOl);
    setSaving(false);
  }

  const cardBg = dark ? "#1e293b" : "white";
  const grad = dark ? "linear-gradient(135deg,#080614,#110e2e)" : "linear-gradient(135deg,#1e1b4b,#3730a3)";

  return (
    <div>
      <div style={{background:grad, padding:"20px 20px 28px"}}>
        <button onClick={onBack} style={{background:"rgba(255,255,255,0.2)",border:"none",color:"white",padding:"6px 14px",borderRadius:20,cursor:"pointer",marginBottom:14,fontSize:13}}>â† Indietro</button>
        <h2 style={{color:"white",fontFamily:"Lora,serif"}}>ğŸ”„ Rinnova per il {selectedYear}</h2>
        <p style={{color:"#a5b4fc",margin:"4px 0 0",fontSize:13}}>Seleziona chi seguire in questa stagione</p>
      </div>
      <div style={{padding:16}}>
        {passati.length === 0 ? (
          <p style={{textAlign:"center", color:dark?"#94a3b8":"#6b7280", padding:20}}>Tutti i clienti passati sono giÃ  attivi in questa stagione!</p>
        ) : (
          passati.map(c => {
            const ols = allOliveti.filter(o => o.cliente_id === c.id && !o.stagioni.includes(selectedYear));
            return (
              <div key={c.id} style={{background:cardBg, borderRadius:16, padding:16, marginBottom:12}}>
                <div style={{display:"flex", alignItems:"center", gap:10, cursor:"pointer", marginBottom:8}} onClick={()=>toggleCl(c.id)}>
                  <input type="checkbox" checked={selCl.includes(c.id)} readOnly style={{transform:"scale(1.4)"}} />
                  <strong style={{fontSize:16}}>{c.nome}</strong>
                </div>
                {ols.length > 0 && (
                  <div style={{marginLeft:28, display:"flex", flexDirection:"column", gap:8}}>
                    {ols.map(o => (
                      <div key={o.id} style={{display:"flex", alignItems:"center", gap:8, cursor:"pointer"}} onClick={()=>toggleOl(o.id, c.id)}>
                        <input type="checkbox" checked={selOl.includes(o.id)} readOnly />
                        <span style={{fontSize:14, color:dark?"#e2e8f0":"#374151"}}>ğŸ«’ {o.nome} ({o.comune})</span>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            );
          })
        )}
        {passati.length > 0 && (
          <button onClick={doSave} disabled={saving} className="btn-primary" style={{background:"#16a34a", marginTop:10}}>
            {saving ? <span className="spinner"/> : `ğŸ’¾ Importa ${selCl.length} clienti`}
          </button>
        )}
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// APP ROOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function App(){
  const [dark,setDark]=useState(()=>localStorage.getItem("ot_dark")==="1");
  const [dataLoading,setDataLoading]=useState(true);
  const [page,setPage]=useState("home");
  const [pdata,setPdata]=useState(null);
  const [tab,setTab]=useState("home");
  const [clienti,setClienti]=useState([]);
  const [oliveti,setOliveti]=useState([]);
  const [rils,setRils]=useState([]);
  const [sters,setSters]=useState([]);
  const [trats,setTrats]=useState([]);
  const [traps,setTraps]=useState([]);
  const online=useOnline();
  const [selectedYear, setSelectedYear] = useState(new Date().getFullYear());

  function toggleDark(){setDark(d=>{localStorage.setItem("ot_dark",d?"0":"1");return !d;});}
  function nav(p,d=null){setPage(p);setPdata(d);}
  function goHome(){setPage("home");setPdata(null);}
  function goHomeClear(){setPage("home");setPdata(null);setTab("home");}

  useEffect(()=>{ loadData(); },[]);

  async function loadData(){
    setDataLoading(true);
    try{
      const[{data:cl},{data:ol},{data:ri},{data:st},{data:tr},{data:tp}]=await Promise.all([
        sb.from("clienti").select("*").order("nome",{ascending:true}),
        sb.from("oliveti").select("*").order("created_at",{ascending:false}),
        sb.from("monitoraggi").select("*").order("data",{ascending:false}),
        sb.from("campionamenti").select("*").order("data",{ascending:false}),
        sb.from("trattamenti").select("*").order("data",{ascending:false}),
        sb.from("trappole").select("*"),
      ]);
      setClienti(cl||[]);
      setOliveti(ol||[]);
      setRils(ri||[]);
      setSters(st||[]);
      setTrats(tr||[]);
      setTraps(tp||[]);
      Cache.set("cl",cl); Cache.set("ol",ol); Cache.set("ri",ri);
      Cache.set("st",st); Cache.set("tr",tr); Cache.set("tp",tp);
    }catch(e){
      if(Cache.get("cl")) setClienti(Cache.get("cl"));
      if(Cache.get("ol")) setOliveti(Cache.get("ol"));
      if(Cache.get("ri")) setRils(Cache.get("ri"));
      if(Cache.get("st")) setSters(Cache.get("st"));
      if(Cache.get("tr")) setTrats(Cache.get("tr"));
      if(Cache.get("tp")) setTraps(Cache.get("tp"));
    }
    setDataLoading(false);
  }

  // Sync coda offline quando torna online
  useEffect(()=>{
    if(!online) return;
    async function syncPending(){
      const q=PendingQueue.get();
      if(q.length===0) return;
      let synced=0;
      for(const op of q){
        try{
          if(op.type==="ril"){
            const{error}=await sb.from("monitoraggi").insert(op.data);
            if(!error){PendingQueue.remove(op._qid);synced++;}
          } else if(op.type==="ster"){
            const{error}=await sb.from("campionamenti").insert(op.data);
            if(!error){PendingQueue.remove(op._qid);synced++;}
          } else if(op.type==="trat"){
            const{error}=await sb.from("trattamenti").insert(op.data);
            if(!error){PendingQueue.remove(op._qid);synced++;}
          }
        }catch(e){}
      }
      if(synced>0){ loadData(); }
    }
    syncPending();
  },[online]);

  // Normalizza campi
  const rilsC=rils.map(r=>({...r,oId:r.oliveto_id||r.oId,stagione:r.stagione||new Date(r.data).getFullYear()}));
  const stersC=sters.map(s=>({...s,oId:s.oliveto_id||s.oId,stagione:s.stagione||new Date(s.data).getFullYear()}));
  const tratsC=trats.map(t=>({...t,oId:t.oliveto_id||t.oId}));
  const trapsC=traps.map(t=>({...t,oId:t.oliveto_id||t.oId}));
  
      // --- INIZIO NUOVA LOGICA ANNO ---
  const currentY = new Date().getFullYear();
  // Forza la presenza dell'anno corrente e dei 3 anni precedenti (es. 2026, 2025, 2024, 2023)
  const allYears = new Set([
    currentY, currentY - 1, currentY - 2, currentY - 3,
    ...rilsC.map(r => r.stagione),
    ...stersC.map(s => s.stagione),
    ...tratsC.map(t => new Date(t.data).getFullYear())
  ]);
  const availableYears = [...allYears].sort((a,b)=>b-a);

  // Per i clienti vecchi senza etichetta, assegniamo gli anni per non perderli
  const clC = clienti.map(c => ({...c, stagioni: c.stagioni && c.stagioni.length ? c.stagioni : availableYears}));
  const olC = oliveti.map(o => ({...o, stagioni: o.stagioni && o.stagioni.length ? o.stagioni : availableYears}));

  // FILTRIAMO CLIENTI E OLIVETI IN BASE ALL'ANNO SCELTO NELLA TENDINA!
  const clientiY = clC.filter(c => c.stagioni.includes(selectedYear));
  const olivetiY = olC.filter(o => o.stagioni.includes(selectedYear));
  
  const rilsY = rilsC.filter(r => r.stagione === selectedYear);
  const stersY = stersC.filter(s => s.stagione === selectedYear);
  const tratsY = tratsC.filter(t => new Date(t.data).getFullYear() === selectedYear);

  const shared = { clienti: clientiY, oliveti: olivetiY, allClienti: clC, allOliveti: olC, rils: rilsY, sters: stersY, trats: tratsY, allRils: rilsC, allSters: stersC, traps: trapsC, setTraps, dark, selectedYear };
  // --- FINE NUOVA LOGICA ANNO ---


  // â”€â”€â”€ CRUD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function saveCliente(f){
    // Inserisce automaticamente l'anno selezionato nel menu a tendina
    const payload = {
      nome: f.nome.trim(),
      telefono: f.telefono || null,
      email: f.email || null,
      note: f.note || null,
      stagioni: [selectedYear] 
    };
    const{data,error}=await sb.from("clienti").insert(payload).select().single();
    if(error){ alert("Errore salvataggio: "+error.message); return; }
    if(data) setClienti(p=>[...p,data]);
    goHome();
  }
  async function deleteCliente(id){
    const myOlIds=oliveti.filter(o=>o.cliente_id===id).map(o=>o.id);
    if(myOlIds.length){
      await sb.from("monitoraggi").delete().in("oliveto_id",myOlIds);
      await sb.from("campionamenti").delete().in("oliveto_id",myOlIds);
      await sb.from("trattamenti").delete().in("oliveto_id",myOlIds);
      await sb.from("trappole").delete().in("oliveto_id",myOlIds);
      await sb.from("oliveti").delete().in("id",myOlIds);
    }
    await sb.from("clienti").delete().eq("id",id);
    setClienti(p=>p.filter(c=>c.id!==id));
    setOliveti(p=>p.filter(o=>o.cliente_id!==id));
    setRils(p=>p.filter(r=>!myOlIds.includes(r.oliveto_id)));
    setSters(p=>p.filter(s=>!myOlIds.includes(s.oliveto_id)));
    setTrats(p=>p.filter(t=>!myOlIds.includes(t.oliveto_id)));
    setTraps(p=>p.filter(t=>!myOlIds.includes(t.oliveto_id)));
    goHome();
  }

  async function saveOliveto(f){
    // Inserisce automaticamente l'anno selezionato nel menu a tendina
    const payload = {
      nome: f.nome.trim(),
      comune: f.comune.trim(),
      varieta: f.varieta || null,
      piante: +f.piante || null,
      ha: +f.ha || null,
      lat: f.lat ? +f.lat : null,
      lng: f.lng ? +f.lng : null,
      cliente_id: f.clienteId,
      stagioni: [selectedYear]
    };
    const{data,error}=await sb.from("oliveti").insert(payload).select().single();
    if(error){ alert("Errore salvataggio oliveto: "+error.message); return; }
    if(data) setOliveti(p=>[...p,data]);
    const cliente=clienti.find(c=>c.id===f.clienteId);
    if(cliente) nav("cliente-detail",cliente);
    else goHome();
  }
  async function deleteOliveto(id){
    await sb.from("monitoraggi").delete().eq("oliveto_id",id);
    await sb.from("campionamenti").delete().eq("oliveto_id",id);
    await sb.from("trattamenti").delete().eq("oliveto_id",id);
    await sb.from("trappole").delete().eq("oliveto_id",id);
    await sb.from("oliveti").delete().eq("id",id);
    const ol=oliveti.find(o=>o.id===id);
    setOliveti(p=>p.filter(o=>o.id!==id));
    setRils(p=>p.filter(r=>r.oliveto_id!==id));
    setSters(p=>p.filter(s=>s.oliveto_id!==id));
    setTrats(p=>p.filter(t=>t.oliveto_id!==id));
    setTraps(p=>p.filter(t=>t.oliveto_id!==id));
    const cliente=ol?clienti.find(c=>c.id===ol.cliente_id):null;
    if(cliente) nav("cliente-detail",cliente);
    else goHome();
  }

  async function deleteRil(id){
    await sb.from("monitoraggi").delete().eq("id",id);
    setRils(p=>p.filter(r=>r.id!==id));
  }
  async function deleteSter(id){
    await sb.from("campionamenti").delete().eq("id",id);
    setSters(p=>p.filter(s=>s.id!==id));
  }
  async function deleteTrat(id){
    await sb.from("trattamenti").delete().eq("id",id);
    setTrats(p=>p.filter(t=>t.id!==id));
  }
  async function updateRil(f){setRils(p=>p.map(r=>r.id===f.id?{...r,...f,mosche:+f.mosche}:r));}
  async function updateSter(f){setSters(p=>p.map(s=>s.id===f.id?{...s,...f}:s));}
  async function updateTrat(f){setTrats(p=>p.map(t=>t.id===f.id?{...t,...f}:t));}

  async function saveRil(f){
    const trap=trapsC.find(t=>t.id===f.trapId);
    const payload={data:f.data,mosche:f.mosche,meteo:f.meteo,fase:f.fase,oliveto_id:f.oId,trappola_id:f.trapId,trappola:trap?.nome||"",stagione:new Date(f.data).getFullYear()};
    if(!online){
      const fakeId="offline_"+Date.now();
      const fakeRecord={...payload,id:fakeId,oId:f.oId,_offline:true};
      PendingQueue.add({type:"ril",data:payload});
      setRils(p=>[...p,fakeRecord]);
      const ol=oliveti.find(o=>o.id===f.oId);
      if(ol) nav("oliveto-detail",ol); else goHome();
      return;
    }
    const{data,error}=await sb.from("monitoraggi").insert(payload).select().single();
    if(error){ alert("Errore: "+error.message); return; }
    if(data){
      setRils(p=>[...p,data]);
      const ol=oliveti.find(o=>o.id===f.oId);
      
      // --- INIZIO NUOVO CODICE WHATSAPP ---
      const cliente = ol ? clienti.find(c => c.id === ol.cliente_id) : null;
      if (cliente && cliente.telefono) {
        if (confirm("Dati salvati! Vuoi inviare l'aggiornamento su WhatsApp al cliente?")) {
          inviaWhatsApp(cliente, 'ril', f, ol.nome);
        }
      }
      // --- FINE NUOVO CODICE WHATSAPP ---

      if(ol) nav("oliveto-detail",ol); else goHome();
    } else goHome();
  }
  
  async function saveSter(f){
    const payload={data:f.data,camp:+f.camp,uova:+f.uova,l1:+f.l1,l2:+f.l2,l3:+f.l3,pupe:+f.pupe,fori:+f.fori,oliveto_id:f.oId,stagione:new Date(f.data).getFullYear()};
    if(!online){
      const fakeId="offline_"+Date.now();
      PendingQueue.add({type:"ster",data:payload});
      setSters(p=>[...p,{...payload,id:fakeId,oId:f.oId,_offline:true}]);
      const ol=oliveti.find(o=>o.id===f.oId);
      if(ol) nav("oliveto-detail",ol); else goHome();
      return;
    }
    const{data,error}=await sb.from("campionamenti").insert(payload).select().single();
    if(error){ alert("Errore: "+error.message); return; }
    if(data){
      setSters(p=>[...p,data]);
      const ol=oliveti.find(o=>o.id===f.oId);

      // --- INIZIO NUOVO CODICE WHATSAPP ---
      const cliente = ol ? clienti.find(c => c.id === ol.cliente_id) : null;
      if (cliente && cliente.telefono) {
        if (confirm("Dati salvati! Vuoi inviare l'aggiornamento su WhatsApp al cliente?")) {
          inviaWhatsApp(cliente, 'ster', f, ol.nome);
        }
      }
      // --- FINE NUOVO CODICE WHATSAPP ---

      if(ol) nav("oliveto-detail",ol); else goHome();
    } else goHome();
  }

  async function saveTrat(f){
    const{data,error}=await sb.from("trattamenti").insert({
      data:f.data,prodotto:f.prodotto,dose:f.dose||null,note:f.note||null,oliveto_id:f.oId
    }).select().single();
    if(error){ alert("Errore: "+error.message); return; }
    if(data) setTrats(p=>[...p,data]);
    // Torna all'oliveto
    const ol=oliveti.find(o=>o.id===f.oId);
    if(ol) nav("oliveto-detail",ol);
    else goHome();
  }
  async function importaDatiPassati(clientiIds, olivetiIds) {
    if(!online) { alert("Devi essere online per importare i vecchi clienti."); return; }
    
    // Aggiunge l'anno corrente ai clienti selezionati
    for (const cid of clientiIds) {
      const c = clC.find(x => x.id === cid);
      if(!c) continue;
      const newSt = [...new Set([...c.stagioni, selectedYear])];
      await sb.from("clienti").update({ stagioni: newSt }).eq("id", cid);
      setClienti(p => p.map(x => x.id === cid ? {...x, stagioni: newSt} : x));
    }
    
    // Aggiunge l'anno corrente agli oliveti selezionati
    for (const oid of olivetiIds) {
      const o = olC.find(x => x.id === oid);
      if(!o) continue;
      const newSt = [...new Set([...o.stagioni, selectedYear])];
      await sb.from("oliveti").update({ stagioni: newSt }).eq("id", oid);
      setOliveti(p => p.map(x => x.id === oid ? {...x, stagioni: newSt} : x));
    }
    goHome();
  }

  const theme=dark?"dark":"light";
  const headerBg=dark?"#0a1f0f":"#052e16";
  const mutedC=dark?"#94a3b8":"#6b7280";
  const activeColor=dark?"#4ade80":"#16a34a";

  if(dataLoading) return(
    <div className={`page ${theme}`} style={{display:"flex",alignItems:"center",justifyContent:"center",minHeight:"100vh"}}>
      <div style={{textAlign:"center"}}>
        <div style={{fontSize:50,marginBottom:12}}>ğŸ«’</div>
        <p style={{color:mutedC}}>Caricamento...</p>
        <div className="spinner" style={{margin:"12px auto",width:28,height:28}}/>
      </div>
    </div>
  );

  function renderPage(){
    // Cliente
    if(page==="add-cliente") return <AddCliente onBack={goHome} onSave={saveCliente} dark={dark}/>;
    if(page==="cliente-detail") return <ClienteDetail
      cliente={pdata} oliveti={oliveti} rils={rilsC} sters={stersC} trats={tratsC} traps={trapsC}
      setTraps={setTraps} onBack={goHome} nav={nav} dark={dark}
      onDeleteCliente={deleteCliente} onDeleteOliveto={deleteOliveto}
      onDeleteRil={deleteRil} onDeleteSter={deleteSter} onDeleteTrat={deleteTrat}
      onUpdateRil={updateRil} onUpdateSter={updateSter} onUpdateTrat={updateTrat}/>;
    // Oliveto
    if(page==="add-oliveto") return <AddOliveto
      clienteId={pdata?.clienteId} clienteNome={pdata?.clienteNome}
      onBack={()=>{ const c=clienti.find(x=>x.id===pdata?.clienteId); if(c) nav("cliente-detail",c); else goHome(); }}
      onSave={saveOliveto} dark={dark}/>;
    if(page==="oliveto-detail") return <OlivetoDetail
      oliveto={pdata} onBack={()=>{
        const ol=oliveti.find(o=>o.id===pdata?.id);
        const c=ol?clienti.find(x=>x.id===ol.cliente_id):null;
        if(c) nav("cliente-detail",c); else goHome();
      }}
      nav={nav} {...shared}
      onDeleteOliveto={deleteOliveto} onDeleteRil={deleteRil} onDeleteSter={deleteSter} onDeleteTrat={deleteTrat}
      onUpdateRil={updateRil} onUpdateSter={updateSter} onUpdateTrat={updateTrat}/>;
    if(page==="add-trattamento") return <AddTrattamento oliveto={pdata} onBack={()=>nav("oliveto-detail",pdata)} onSave={saveTrat} dark={dark}/>;
    if(page==="gestione-trappole") return <GestioneTrappole
      trappole={trapsC} setTrappole={fn=>{const u=typeof fn==="function"?fn(trapsC):fn;setTraps(u.map(t=>({...t,oliveto_id:t.oId||t.oliveto_id})));}}
      oId={pdata?.oId} oliveto={pdata?.oliveto} dark={dark}
      onBack={()=>{ const ol=oliveti.find(o=>o.id===pdata?.oId); if(ol) nav("oliveto-detail",ol); else goHome(); }}/>;
    // Form inserimento dati
    if(page==="add-rilevamento") return <AddRilevamento
      oliveti={oliveti} traps={trapsC} clienteId={pdata?.clienteId} preOId={pdata?.oId}
      onBack={()=>{ const ol=oliveti.find(x=>x.id===pdata?.oId); if(ol) nav("oliveto-detail",ol); else { const c=clienti.find(x=>x.id===pdata?.clienteId); if(c) nav("cliente-detail",c); else goHome(); }}}
      onSave={saveRil} dark={dark}/>;
    if(page==="add-stereoscopio") return <AddStereoscopio
      oliveti={oliveti} clienteId={pdata?.clienteId} preOId={pdata?.oId}
      onBack={()=>{ const ol=oliveti.find(x=>x.id===pdata?.oId); if(ol) nav("oliveto-detail",ol); else { const c=clienti.find(x=>x.id===pdata?.clienteId); if(c) nav("cliente-detail",c); else goHome(); }}}
      onSave={saveSter} dark={dark}/>;
    if(page==="export") return <Export oliveti={oliveti} clienti={clienti} rils={rilsC} sters={stersC} trats={tratsC} onBack={goHome} dark={dark}/>;
    if(tab==="soglie") return <Soglie onBack={goHomeClear} dark={dark}/>;
    if(tab==="mappa") return <MappaOliveti oliveti={oliveti} rils={rilsC} sters={stersC} clienti={clienti} nav={nav} dark={dark}/>;
    if(page==="importa-dati") return <ImportaDati allClienti={clC} allOliveti={olC} selectedYear={selectedYear} onBack={goHome} onSave={importaDatiPassati} dark={dark} />;
    return <Home clienti={clienti} oliveti={oliveti} rils={rilsC} sters={stersC} nav={nav} dark={dark}/>;
  }

  const tabs=[["home","ğŸ ","Home"],["mappa","ğŸ—ºï¸","Mappa"],["soglie","âš™ï¸","Soglie"]];

  return(
    <div className={`page ${theme}`}>
      
      <div className="header" style={{background:headerBg,boxShadow:"0 2px 20px rgba(0,0,0,0.3)"}}>
        <div style={{display:"flex",alignItems:"center",gap:6,flex:1,minWidth:0}}>
          <span style={{fontSize:20}}>ğŸ«’</span>
          <span style={{color:"white",fontFamily:"Lora,serif",fontWeight:700,fontSize:16,whiteSpace:"nowrap"}}>OliveTrack</span>
          <span title={online?"Online":"Offline"} style={{marginLeft:4}}>{online?<span className="dot-online"/>:<span className="dot-offline"/>}</span>
          {!online&&PendingQueue.get().length>0&&<span style={{background:"#d97706",color:"white",fontSize:10,padding:"2px 7px",borderRadius:10,fontWeight:700}}>â³ {PendingQueue.get().length} da sincronizzare</span>}
        </div>
        <div style={{display:"flex",gap:5,alignItems:"center",flexShrink:0}}>
          <select value={selectedYear} onChange={e=>setSelectedYear(+e.target.value)} style={{background:"rgba(255,255,255,0.15)",border:"none",color:"white",padding:"4px 8px",borderRadius:10,outline:"none",fontWeight:700,fontSize:13,cursor:"pointer"}}>
            {availableYears.map(y => <option key={y} value={y} style={{color:"black"}}>{y}</option>)}
          </select>
          <div onClick={toggleDark} style={{width:36,height:20,borderRadius:10,background:dark?"#4ade80":"rgba(255,255,255,0.3)",cursor:"pointer",position:"relative",transition:"background 0.3s"}}>
            <div style={{position:"absolute",top:2,left:dark?18:2,width:16,height:16,borderRadius:8,background:"white",transition:"left 0.3s",display:"flex",alignItems:"center",justifyContent:"center",fontSize:9}}>{dark?"ğŸŒ™":"â˜€ï¸"}</div>
          </div>
          <button onClick={()=>nav("export")} style={{background:"rgba(255,255,255,0.15)",border:"none",color:"white",padding:"4px 8px",borderRadius:14,cursor:"pointer",fontSize:12}}>ğŸ“Š</button>
        </div>
      </div>
      <div className="scroll-area">{renderPage()}</div>
      {page==="home"&&<div className="bottom-nav nav-bg">
        {tabs.map(([id,icon,lbl])=>(
          <button key={id} className="nav-btn" onClick={()=>{setTab(id);setPage("home");}}>
            <span style={{fontSize:20}}>{icon}</span>
            <span style={{fontSize:10,fontWeight:tab===id?700:500,color:tab===id?activeColor:mutedC}}>{lbl}</span>
          </button>
        ))}
      </div>}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>

<script>
if('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    const swCode = `
      const CACHE = 'olivetrack-v2';
      const ASSETS = ['./', './index.html'];
      self.addEventListener('install', e => {
        e.waitUntil(caches.open(CACHE).then(c => c.addAll(ASSETS).catch(()=>{})));
        self.skipWaiting();
      });
      self.addEventListener('activate', e => {
        e.waitUntil(caches.keys().then(keys =>
          Promise.all(keys.filter(k=>k!==CACHE).map(k=>caches.delete(k)))
        ));
        self.clients.claim();
      });
      self.addEventListener('fetch', e => {
        e.respondWith(fetch(e.request).catch(() => caches.match(e.request)));
      });
    `;
    const blob = new Blob([swCode], {type:'application/javascript'});
    navigator.serviceWorker.register(URL.createObjectURL(blob)).catch(()=>{});
  });
}
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault(); deferredPrompt = e;
  setTimeout(() => { if(deferredPrompt && document.getElementById('install-banner')) document.getElementById('install-banner').style.display='flex'; }, 3000);
});
window.addEventListener('appinstalled', () => { const b=document.getElementById('install-banner'); if(b) b.style.display='none'; deferredPrompt=null; });
</script>

<div id="install-banner" style="display:none;position:fixed;bottom:90px;left:50%;transform:translateX(-50%);width:calc(100% - 32px);max-width:398px;background:#052e16;color:white;border-radius:16px;padding:14px 18px;align-items:center;gap:12px;z-index:9999;box-shadow:0 8px 32px rgba(0,0,0,0.4);">
  <span style="font-size:28px">ğŸ«’</span>
  <div style="flex:1"><div style="font-weight:700;font-size:14px">Installa OliveTrack</div><div style="font-size:12px;opacity:0.8">Aggiungila alla schermata home</div></div>
  <button onclick="deferredPrompt&&deferredPrompt.prompt();document.getElementById('install-banner').style.display='none';"
    style="background:#16a34a;color:white;border:none;border-radius:10px;padding:8px 16px;font-weight:700;cursor:pointer;font-size:13px">Installa</button>
  <button onclick="document.getElementById('install-banner').style.display='none';"
    style="background:rgba(255,255,255,0.15);color:white;border:none;border-radius:10px;padding:8px 10px;cursor:pointer;font-size:16px">Ã—</button>
</div>
</body></html>

